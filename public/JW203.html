<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JW203 è“ç‰™è®¾å¤‡ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .scan-section {
            text-align: center;
        }

        .scan-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .scan-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .scan-btn.active {
            outline: 2px solid #ffd166;
            box-shadow: 0 0 0 3px rgba(255, 209, 102, 0.3);
            filter: brightness(1.05);
        }

        .scan-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-weight: 500;
        }

        .status.scanning {
            background: #e6f3ff;
            color: #0066cc;
            border: 1px solid #b3d9ff;
        }

        .status.connected {
            background: #e6ffe6;
            color: #006600;
            border: 1px solid #b3ffb3;
        }

        .status.error {
            background: #ffe6e6;
            color: #cc0000;
            border: 1px solid #ffb3b3;
        }

        .status.info {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .device-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .device-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .device-item:hover {
            background: #e3f2fd;
            border-color: #667eea;
            transform: translateX(5px);
        }

        .device-item.connected {
            background: #e8f5e8;
            border-color: #4caf50;
        }

        .device-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .device-id {
            font-size: 0.9rem;
            color: #6c757d;
            font-family: 'Courier New', monospace;
        }

        .characteristics-section {
            grid-column: 1 / -1;
        }

        .characteristics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .characteristic-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .characteristic-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .characteristic-uuid {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-family: 'Courier New', monospace;
        }

        .characteristic-properties {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .property-tag {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .characteristic-value {
            background: #ffffff;
            border: 1px solid #ced4da;
            border-radius: 5px;
            padding: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            word-break: break-all;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* æ“ä½œæ—¥å¿—æ ·å¼ */
        .log-section {
            margin-top: 12px;
            text-align: left;
        }
        .log-label {
            display: inline-block;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 6px;
        }
        .log-output {
            background: #0b1e3b;
            color: #a7ff83;
            border-radius: 8px;
            padding: 10px;
            min-height: 90px;
            max-height: 220px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            box-shadow: inset 0 0 6px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .characteristics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”µ JW203 è“ç‰™è®¾å¤‡ç®¡ç†</h1>
            <p>æ‰«æå¹¶è¿æ¥BLEè“ç‰™è®¾å¤‡ï¼ŒæŸ¥çœ‹è®¾å¤‡ç‰¹å¾ä¿¡æ¯</p>
        </div>


        <div class="card scan-section">
            <h2>ğŸ” è®¾å¤‡æ‰«æ</h2>
            <button id="scanBtn" class="scan-btn">å¼€å§‹æ‰«æè®¾å¤‡</button>
            <div style="margin-top: 12px">
                <label for="extraServicesInput" class="log-label" style="margin-bottom: 6px; display:block;">é™„åŠ æœåŠ¡UUIDï¼ˆç”¨äºè®¢é˜…é€šçŸ¥ï¼Œé€—å·åˆ†éš”ï¼‰</label>
                <input id="extraServicesInput" type="text" placeholder="ä¾‹å¦‚ï¼šffe0, fff0 æˆ– 0000ffe0-0000-1000-8000-00805f9b34fb" value="59462f12-9543-9999-12c8-58b459a2712d" style="width:100%; padding:10px; border:1px solid #dee2e6; border-radius:8px;">
                <div style="color:#6c757d; font-size: 0.9rem; margin-top: 6px;">æç¤ºï¼šå¦‚è®¾å¤‡ä½¿ç”¨è‡ªå®šä¹‰æœåŠ¡ï¼Œè¯·åœ¨æ‰«æå‰å¡«å…¥å¯¹åº”æœåŠ¡UUIDï¼›çŸ­UUIDä¼šè‡ªåŠ¨è½¬æ¢ä¸º128ä½ã€‚</div>
            </div>
            <div id="scanStatus" class="status" style="display: none;"></div>
            <div class="log-section">
                <label class="log-label">æ“ä½œæ—¥å¿—</label>
                <pre id="opLog" class="log-output"></pre>
            </div>
        </div>


        <div class="card device-status">
            <h2>ğŸ“Ÿ è®¾å¤‡çŠ¶æ€</h2>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                <div>
                    <div style="color:#6c757d;">ç”µé‡</div>
                    <div id="batteryValue" class="characteristic-value">-</div>
                </div>
                <div>
                    <div style="color:#6c757d;">å®æµ‹æ¸©åº¦</div>
                    <div id="realTempValue" class="characteristic-value">-</div>
                </div>
                <div>
                    <div style="color:#6c757d;">å‰©ä½™æ—¶é—´</div>
                    <div id="remainTimeValue" class="characteristic-value">-</div>
                </div>
            </div>
            <div class="status info" id="deviceStatusTips" style="margin-top:12px; display:none;"></div>
        </div>

        <div class="card control-section">
            <h2>ğŸ›ï¸ è®¾å¤‡æ§åˆ¶</h2>
            <div style="display:grid;grid-template-columns:1fr;gap:12px;">
                <div>
                    <div style="color:#6c757d; margin-bottom:6px;">ç¯å…‰æ¨¡å¼</div>
                    <div id="lightModeControls" style="display:flex;gap:8px;flex-wrap:wrap;">
                        <button class="scan-btn" data-mode="0">0</button>
                        <button class="scan-btn" data-mode="1">1</button>
                        <button class="scan-btn" data-mode="2">2</button>
                        <button class="scan-btn" data-mode="3">3</button>
                        <button class="scan-btn" data-mode="4">4</button>
                        <button class="scan-btn" data-mode="5">5</button>
                    </div>
                </div>
                <div>
                    <div style="color:#6c757d; margin:10px 0 6px;">è®¾ç½®æ¸©åº¦ (150-300â„ƒ)</div>
                    <input id="setTempInput" type="range" min="150" max="300" step="5" value="200" style="width:100%" />
                    <div style="display:flex;justify-content:space-between;color:#6c757d;font-size:0.9rem;">
                        <span>150â„ƒ</span><span id="setTempDisplay">200â„ƒ</span><span>300â„ƒ</span>
                    </div>
                </div>
                <div>
                    <div style="color:#6c757d; margin:10px 0 6px;">è®¾ç½®æ—¶é—´ (30-120min)</div>
                    <input id="setTimeInput" type="range" min="30" max="120" step="5" value="60" style="width:100%" />
                    <div style="display:flex;justify-content:space-between;color:#6c757d;font-size:0.9rem;">
                        <span>30min</span><span id="setTimeDisplay">60min</span><span>120min</span>
                    </div>
                </div>
            </div>
            <div style="margin-top:12px;">
                <div style="color:#6c757d; margin-bottom:6px;">WiFi é…ç½®</div>
                <input id="ssidInput" type="text" placeholder="SSID" style="width:100%; padding:10px; border:1px solid #dee2e6; border-radius:8px; margin-bottom:8px;">
                <input id="passwordInput" type="text" placeholder="Password" style="width:100%; padding:10px; border:1px solid #dee2e6; border-radius:8px;">
            </div>
            <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
                <button id="sendControlBtn" class="scan-btn">å‘é€æ§åˆ¶æŒ‡ä»¤</button>
                <button id="wifiStartBtn" class="scan-btn">WiFi Start</button>
                <button id="otaStartBtn" class="scan-btn">OTA Start</button>
                <div id="controlStatus" class="status info" style="display:none;"></div>
            </div>
        </div>
        
        <div class="card b1-section">
            <h2>ğŸ§ª Classicæ¸©åº¦/æ—¶é—´ (B1/A1)</h2>
            <div style="overflow-x:auto;">
                <table id="b1Table" style="width:100%;border-collapse:collapse;">
                    <thead>
                        <tr>
                            <th style="text-align:left;color:#6c757d;">é˜¶æ®µ</th>
                            <th style="text-align:left;color:#6c757d;">æ¸©åº¦(â„ƒ)</th>
                            <th style="text-align:left;color:#6c757d;">æ—¶é—´(min)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>é¢„çƒ­</td>
                            <td><input id="b1PreHeatTemp" type="number" min="60" max="300" step="1" value="200" style="width:100%"></td>
                            <td><input id="b1PreHeatTime" type="number" min="0" max="120" step="1" value="0" style="width:100%"></td>
                        </tr>
                        <tr>
                            <td>å‡æ¸©</td>
                            <td><input id="b1RampUpTemp" type="number" min="60" max="300" step="1" value="200" style="width:100%"></td>
                            <td><input id="b1RampUpTime" type="number" min="0" max="120" step="1" value="0" style="width:100%"></td>
                        </tr>
                        <tr>
                            <td>æ’æ¸©</td>
                            <td><input id="b1SteadyTemp" type="number" min="60" max="300" step="1" value="200" style="width:100%"></td>
                            <td><input id="b1SteadyTime" type="number" min="0" max="120" step="1" value="0" style="width:100%"></td>
                        </tr>
                        <tr>
                            <td>å¢å¼º</td>
                            <td><input id="b1BoostTemp" type="number" min="60" max="300" step="1" value="200" style="width:100%"></td>
                            <td><input id="b1BoostTime" type="number" min="0" max="120" step="1" value="0" style="width:100%"></td>
                        </tr>
                        <tr>
                            <td>é™æ¸©</td>
                            <td><input id="b1CooldownTemp" type="number" min="60" max="300" step="1" value="200" style="width:100%"></td>
                            <td><input id="b1CooldownTime" type="number" min="0" max="120" step="1" value="0" style="width:100%"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
                <button id="sendA1Btn" class="scan-btn">å‘é€é˜¶æ®µå‚æ•°(A1)</button>
            </div>
            <div id="b1Status" class="status info" style="display:none;margin-top:8px;"></div>
        </div>
        
        <div class="card b2-section">
            <h2>ğŸ§ª Herbalæ¸©åº¦/æ—¶é—´ (B2/A2)</h2>
            <div style="overflow-x:auto;">
                <table id="b2Table" style="width:100%;border-collapse:collapse;">
                    <thead>
                        <tr>
                            <th style="text-align:left;color:#6c757d;">é˜¶æ®µ</th>
                            <th style="text-align:left;color:#6c757d;">æ¸©åº¦(â„ƒ)</th>
                            <th style="text-align:left;color:#6c757d;">æ—¶é—´(min)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>é¢„çƒ­</td>
                            <td><input id="b2PreHeatTemp" type="number" min="60" max="300" step="1" value="200" style="width:100%"></td>
                            <td><input id="b2PreHeatTime" type="number" min="0" max="120" step="1" value="0" style="width:100%"></td>
                        </tr>
                        <tr>
                            <td>å‡æ¸©</td>
                            <td><input id="b2RampUpTemp" type="number" min="60" max="300" step="1" value="200" style="width:100%"></td>
                            <td><input id="b2RampUpTime" type="number" min="0" max="120" step="1" value="0" style="width:100%"></td>
                        </tr>
                        <tr>
                            <td>æ’æ¸©</td>
                            <td><input id="b2SteadyTemp" type="number" min="60" max="300" step="1" value="200" style="width:100%"></td>
                            <td><input id="b2SteadyTime" type="number" min="0" max="120" step="1" value="0" style="width:100%"></td>
                        </tr>
                        <tr>
                            <td>å¢å¼º</td>
                            <td><input id="b2BoostTemp" type="number" min="60" max="300" step="1" value="200" style="width:100%"></td>
                            <td><input id="b2BoostTime" type="number" min="0" max="120" step="1" value="0" style="width:100%"></td>
                        </tr>
                        <tr>
                            <td>é™æ¸©</td>
                            <td><input id="b2CooldownTemp" type="number" min="60" max="300" step="1" value="200" style="width:100%"></td>
                            <td><input id="b2CooldownTime" type="number" min="0" max="120" step="1" value="0" style="width:100%"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
                <button id="sendA2Btn" class="scan-btn">å‘é€é˜¶æ®µå‚æ•°(A2)</button>
            </div>

            <div id="b2Status" class="status info" style="display:none;margin-top:8px;"></div>
        </div>



        <div class="card characteristics-section">
            <h2>ğŸ”§ è®¾å¤‡ç‰¹å¾ä¿¡æ¯ (0x2A24-0x2A29)</h2>
            <div id="characteristicsContainer">
                <p style="text-align: center; color: #6c757d; padding: 20px;">è¯·å…ˆè¿æ¥è®¾å¤‡ä»¥æŸ¥çœ‹ç‰¹å¾ä¿¡æ¯</p>
            </div>
        </div>

        <div class="card notify-section">
            <h2>ğŸ”” é€šçŸ¥æ¶ˆæ¯</h2>
            <div id="notifyStatus" class="status info" style="display: none;"></div>
            <div id="notifyList" class="characteristics-grid"></div>
            <pre id="notifyLog" class="log-output" style="min-height: 120px"></pre>
        </div>


    </div>



    
    <script>
        class BluetoothDeviceManager {
            constructor() {
                this.connectedDevice = null;
                this.connectedServer = null;
                this.scanBtn = document.getElementById('scanBtn');
                this.scanStatus = document.getElementById('scanStatus');
                this.characteristicsContainer = document.getElementById('characteristicsContainer');
                this.logOutput = document.getElementById('opLog');
                this.notifyLog = document.getElementById('notifyLog');
                this.notifyList = document.getElementById('notifyList');
                this.notifyStatus = document.getElementById('notifyStatus');
                this.subscribedNotifyUUIDs = new Set();
                this.extraServicesInput = document.getElementById('extraServicesInput');
                this.lightModeControls = document.getElementById('lightModeControls');
                this.setTempInput = document.getElementById('setTempInput');
                this.setTimeInput = document.getElementById('setTimeInput');
                this.setTempDisplay = document.getElementById('setTempDisplay');
                this.setTimeDisplay = document.getElementById('setTimeDisplay');
                this.sendControlBtn = document.getElementById('sendControlBtn');
                this.controlStatus = document.getElementById('controlStatus');
                this.batteryValue = document.getElementById('batteryValue');
                this.realTempValue = document.getElementById('realTempValue');
                this.setTempValue = document.getElementById('setTempValue');
                this.setTimeValue = document.getElementById('setTimeValue');
                this.remainTimeValue = document.getElementById('remainTimeValue');
                this.lightModeValue = document.getElementById('lightModeValue');
                this.deviceStatusTips = document.getElementById('deviceStatusTips');
                this.txCharacteristic = null;
                this.currentLightMode = 0;
                this.debounceTimer = null;
                this.debounceTimerA1 = null;
                this.b1PreHeatTemp = document.getElementById('b1PreHeatTemp');
                this.b1PreHeatTime = document.getElementById('b1PreHeatTime');
                this.b1RampUpTemp = document.getElementById('b1RampUpTemp');
                this.b1RampUpTime = document.getElementById('b1RampUpTime');
                this.b1SteadyTemp = document.getElementById('b1SteadyTemp');
                this.b1SteadyTime = document.getElementById('b1SteadyTime');
                this.b1BoostTemp = document.getElementById('b1BoostTemp');
                this.b1BoostTime = document.getElementById('b1BoostTime');
                this.b1CooldownTemp = document.getElementById('b1CooldownTemp');
                this.b1CooldownTime = document.getElementById('b1CooldownTime');
                this.b1Status = document.getElementById('b1Status');
                

                // é˜¶æ®µå‚æ•°A2
                this.b2PreHeatTemp = document.getElementById('b2PreHeatTemp');
                this.b2PreHeatTime = document.getElementById('b2PreHeatTime');
                this.b2RampUpTemp = document.getElementById('b2RampUpTemp');
                this.b2RampUpTime = document.getElementById('b2RampUpTime');
                this.b2SteadyTemp = document.getElementById('b2SteadyTemp');
                this.b2SteadyTime = document.getElementById('b2SteadyTime');
                this.b2BoostTemp = document.getElementById('b2BoostTemp');
                this.b2BoostTime = document.getElementById('b2BoostTime');
                this.b2CooldownTemp = document.getElementById('b2CooldownTemp');
                this.b2CooldownTime = document.getElementById('b2CooldownTime');
                this.b2Status = document.getElementById('b2Status');

                this.init();
            }

            init() {
                this.scanBtn.addEventListener('click', () => this.scanForDevices());
                
                // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒWeb Bluetooth
                if (!navigator.bluetooth) {
                    this.showStatus('error', 'æ­¤æµè§ˆå™¨ä¸æ”¯æŒWeb Bluetooth API');
                    this.scanBtn.disabled = true;
                }
                this.log('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
                
                // è®¾å¤‡æ§åˆ¶å¡ç‰‡äº‹ä»¶ç»‘å®š
                if (this.lightModeControls) {
                    const modeButtons = Array.from(this.lightModeControls.querySelectorAll('button[data-mode]'));
                    modeButtons.forEach(btn => {
                        btn.addEventListener('click', () => {
                            const mode = parseInt(btn.getAttribute('data-mode')) || 0;
                            this.currentLightMode = mode;
                            // æ›´æ–°é€‰ä¸­æ€
                            modeButtons.forEach(b => b.classList.toggle('active', b === btn));
                            // ä¹è§‚æ›´æ–°çŠ¶æ€å¡ç‰‡çš„ç¯å…‰æ¨¡å¼æ˜¾ç¤º
                            if (this.lightModeValue) {
                                this.lightModeValue.textContent = this.mapLightMode(mode);
                            }
                            const temp = parseInt(this.setTempInput?.value || '200', 10);
                            const time = parseInt(this.setTimeInput?.value || '60', 10);
                            this.sendControlCommand(mode, temp, time);
                        });
                    });
                }
                if (this.setTempInput && this.setTempDisplay) {
                    this.setTempInput.addEventListener('input', () => {
                        const tempVal = parseInt(this.setTempInput.value || '200', 10);
                        this.setTempDisplay.textContent = `${tempVal}â„ƒ`;
                        // ä¹è§‚æ›´æ–°çŠ¶æ€å¡ç‰‡çš„è®¾ç½®æ¸©åº¦
                        if (this.setTempValue) this.setTempValue.textContent = `${tempVal}Â°C`;
                        // å˜æ›´å³å‘é€ï¼ˆé˜²æŠ–ï¼‰
                        this.scheduleDebouncedSend();
                    });
                }
                if (this.setTimeInput && this.setTimeDisplay) {
                    this.setTimeInput.addEventListener('input', () => {
                        const timeVal = parseInt(this.setTimeInput.value || '60', 10);
                        this.setTimeDisplay.textContent = `${timeVal}min`;
                        // ä¹è§‚æ›´æ–°çŠ¶æ€å¡ç‰‡çš„è®¾ç½®æ—¶é—´
                        if (this.setTimeValue) this.setTimeValue.textContent = `${timeVal}Min`;
                        // å˜æ›´å³å‘é€ï¼ˆé˜²æŠ–ï¼‰
                        this.scheduleDebouncedSend();
                    });
                }
                if (this.sendControlBtn) {
                    this.sendControlBtn.addEventListener('click', () => {
                        const mode = this.currentLightMode || 0;
                        const temp = parseInt(this.setTempInput?.value || '200', 10);
                        const time = parseInt(this.setTimeInput?.value || '60', 10);
                        this.sendControlCommand(mode, temp, time);
                    });
                }
                // ç»‘å®š A1 å‘é€æŒ‰é’®ï¼šç”¨æˆ·ä¿®æ”¹å®Œæ‰€æœ‰é˜¶æ®µå‚æ•°åï¼Œç»Ÿä¸€ç‚¹å‡»å‘é€
                const sendA1Btn = document.getElementById('sendA1Btn');
                if (sendA1Btn) {
                    sendA1Btn.addEventListener('click', () => {
                        this.sendA1FrameFromUI();
                    });
                }
                // ç»‘å®š A2 å‘é€æŒ‰é’®ï¼šç”¨æˆ·ä¿®æ”¹å®Œæ‰€æœ‰é˜¶æ®µå‚æ•°åï¼Œç»Ÿä¸€ç‚¹å‡»å‘é€
                const sendA2Btn = document.getElementById('sendA2Btn');
                if (sendA2Btn) {
                    sendA2Btn.addEventListener('click', () => {
                        this.sendA2FrameFromUI();
                    });
                }
                // ç»‘å®š WiFi/OTA å¯åŠ¨æŒ‰é’®
                const wifiStartBtn = document.getElementById('wifiStartBtn');
                if (wifiStartBtn) {
                    wifiStartBtn.addEventListener('click', () => {
                        this.sendWifiConfigFromUI();
                    });
                }
                const otaStartBtn = document.getElementById('otaStartBtn');
                if (otaStartBtn) {
                    otaStartBtn.addEventListener('click', () => {
                        this.sendA6StartFromUI();
                    });
                }
            }

            // ç»Ÿä¸€æ—¥å¿—è¾“å‡º
            log(message) {
                const ts = new Date().toLocaleTimeString();
                const text = `[${ts}] ${message}`;
                if (this.logOutput) {
                    const line = document.createElement('div');
                    line.textContent = text;
                    this.logOutput.appendChild(line);
                    this.logOutput.scrollTop = this.logOutput.scrollHeight;
                }
                console.log(text);
            }

            // é€šçŸ¥æ—¥å¿—è¾“å‡º
            notify(message) {
                const ts = new Date().toLocaleTimeString();
                const text = `[${ts}] ${message}`;
                if (this.notifyLog) {
                    const line = document.createElement('div');
                    line.textContent = text;
                    this.notifyLog.appendChild(line);
                    this.notifyLog.scrollTop = this.notifyLog.scrollHeight;
                }
                console.log('[NOTIFY]', text);
            }

            // å­—èŠ‚æ•°ç»„è½¬ HEX æ–‡æœ¬
            formatHex(bytes) {
                return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join(' ');
            }

            // ç‰¹å¾å±æ€§è½¬å­—ç¬¦ä¸²
            formatProperties(props) {
                return Object.keys(props).filter(k => props[k]).join(',');
            }

            // è§„èŒƒåŒ–UUIDåˆ°128ä½æˆ–ä¿ç•™å·²è¯†åˆ«åˆ«å
            normalizeUuid(u) {
                const v = (u || '').trim().toLowerCase();
                if (!v) return '';
                if (/^[0-9a-f]{4}$/.test(v)) {
                    return `0000${v}-0000-1000-8000-00805f9b34fb`;
                }
                if (/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/.test(v)) {
                    return v;
                }
                // å…è®¸å·²çŸ¥åˆ«åï¼ˆå¦‚ device_informationï¼‰ç›´æ¥è¿”å›
                return v;
            }

            // è§£æç”¨æˆ·è¾“å…¥çš„é™„åŠ æœåŠ¡UUIDåˆ—è¡¨
            parseExtraServices() {
                const raw = this.extraServicesInput ? this.extraServicesInput.value : '';
                const parts = raw.split(/[\s,;ï¼Œï¼›]+/).filter(Boolean).map(p => this.normalizeUuid(p));
                return parts.filter(Boolean);
            }

            async scanForDevices() {
                try {
                    this.showStatus('scanning', 'æ­£åœ¨æ‰«æè®¾å¤‡...');
                    this.log('å¼€å§‹æ‰«æè®¾å¤‡');
                    this.scanBtn.disabled = true;
                    this.scanBtn.innerHTML = '<span class="loading"></span> æ‰«æä¸­...';

                    const defaultServices = ['generic_access', 'generic_attribute', 'device_information', '0000180a-0000-1000-8000-00805f9b34fb'];
                    const commonNotifyServices = [
                        '0000ffe0-0000-1000-8000-00805f9b34fb',
                        '0000fff0-0000-1000-8000-00805f9b34fb'
                    ];
                    const extra = this.parseExtraServices();
                    const optionalServices = Array.from(new Set([...defaultServices, ...commonNotifyServices, ...extra]));

                    this.log(`é™„åŠ æœåŠ¡è¾“å…¥: ${this.extraServicesInput && this.extraServicesInput.value ? this.extraServicesInput.value : '(ç©º)'}`);
                    this.log(`è¯·æ±‚çš„å¯é€‰æœåŠ¡: ${optionalServices.join(', ')}`);

                    const device = await navigator.bluetooth.requestDevice({
                        acceptAllDevices: true,
                        optionalServices
                    });

                    this.showStatus('scanning', `æ­£åœ¨è¿æ¥: ${device.name || 'æœªçŸ¥è®¾å¤‡'}`);
                    this.log(`å‘ç°è®¾å¤‡ï¼š${device.name || 'æœªçŸ¥è®¾å¤‡'} (ID: ${device.id})`);
                    await this.connectToDevice(device);
                    
                } catch (error) {
                    console.error('æ‰«æè®¾å¤‡å¤±è´¥:', error);
                    
                    // åŒºåˆ†ä¸åŒç±»å‹çš„é”™è¯¯
                    let errorMessage = '';
                    
                    if (error.name === 'NotFoundError') {
                        // ç”¨æˆ·å–æ¶ˆé€‰æ‹©è®¾å¤‡
                        errorMessage = 'ç”¨æˆ·å–æ¶ˆäº†è®¾å¤‡é€‰æ‹©';
                        this.showStatus('info', errorMessage);
                        this.log(errorMessage);
                    } else if (error.name === 'SecurityError') {
                        // æƒé™é—®é¢˜
                        errorMessage = 'è“ç‰™æƒé™è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®';
                        this.showStatus('error', errorMessage);
                        this.log(errorMessage);
                    } else if (error.name === 'NotSupportedError') {
                        // è®¾å¤‡ä¸æ”¯æŒ
                        errorMessage = 'å½“å‰è®¾å¤‡ä¸æ”¯æŒè“ç‰™åŠŸèƒ½';
                        this.showStatus('error', errorMessage);
                        this.log(errorMessage);
                    } else if (error.name === 'InvalidStateError') {
                        // è“ç‰™çŠ¶æ€å¼‚å¸¸
                        errorMessage = 'è“ç‰™çŠ¶æ€å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥è“ç‰™æ˜¯å¦å·²å¼€å¯';
                        this.showStatus('error', errorMessage);
                        this.log(errorMessage);
                    } else {
                        // å…¶ä»–æœªçŸ¥é”™è¯¯
                        errorMessage = `æ‰«æå¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`;
                        this.showStatus('error', errorMessage);
                        this.log(errorMessage);
                    }
                } finally {
                    this.scanBtn.disabled = false;
                    this.scanBtn.innerHTML = 'å¼€å§‹æ‰«æè®¾å¤‡';
                    this.log('æ‰«æç»“æŸ');
                }
            }

            async connectToDevice(device) {
                try {
                    this.showStatus('scanning', 'æ­£åœ¨è¿æ¥è®¾å¤‡...');
                    this.log(`å°è¯•è¿æ¥è®¾å¤‡ï¼š${device.name || 'æœªçŸ¥è®¾å¤‡'} (ID: ${device.id})`);
                    
                    // æ–­å¼€ä¹‹å‰çš„è¿æ¥
                    if (this.connectedServer) {
                        this.connectedServer.disconnect();
                    }

                    // è¿æ¥åˆ°è®¾å¤‡
                    const server = await device.gatt.connect();
                    this.connectedDevice = device;
                    this.connectedServer = server;

                    // æ¸…ç©ºé€šçŸ¥åŒºå¹¶é‡ç½®å·²è®¢é˜…åˆ—è¡¨
                    this.subscribedNotifyUUIDs.clear();
                    if (this.notifyLog) this.notifyLog.textContent = '';
                    if (this.notifyList) this.notifyList.innerHTML = '';
                    // æ–°å¢ï¼šé‡ç½®çŠ¶æ€å¡ç‰‡
                    this.resetDeviceStatus();
                    // æ–°å¢ï¼šé‡ç½®æ§åˆ¶çŠ¶æ€
                    if (this.controlStatus) {
                        this.controlStatus.style.display = 'none';
                        this.controlStatus.textContent = '';
                    }
                    this.showStatus('connected', `å·²è¿æ¥åˆ°: ${device.name || 'æœªçŸ¥è®¾å¤‡'}`);
                    this.log('è®¾å¤‡è¿æ¥æˆåŠŸ');
                    await this.readDeviceCharacteristics(server);
                    this.log('è¯»å–è®¾å¤‡ç‰¹å¾å®Œæˆ');
                    if (this.subscribedNotifyUUIDs.size === 0 && this.notifyStatus) {
                        this.notifyStatus.style.display = 'block';
                        this.notifyStatus.className = 'status info';
                        this.notifyStatus.textContent = 'æœªè®¢é˜…åˆ°é€šçŸ¥ç‰¹å¾ã€‚è‹¥è®¾å¤‡ä½¿ç”¨è‡ªå®šä¹‰æœåŠ¡ï¼Œè¯·åœ¨æ‰«æå‰æ·»åŠ å¯¹åº”æœåŠ¡UUIDï¼ˆå¦‚ ffe0/fff0 æˆ– 128-bitï¼‰ã€‚';
                    }
                    
                } catch (error) {
                    console.error('è¿æ¥è®¾å¤‡å¤±è´¥:', error);
                    
                    // åŒºåˆ†ä¸åŒç±»å‹çš„è¿æ¥é”™è¯¯
                    let errorMessage = '';
                    
                    if (error.name === 'NetworkError') {
                        // ç½‘ç»œè¿æ¥é—®é¢˜
                        errorMessage = 'è®¾å¤‡è¿æ¥è¶…æ—¶ï¼Œè¯·ç¡®ä¿è®¾å¤‡åœ¨èŒƒå›´å†…ä¸”å¯è¿æ¥';
                    } else if (error.name === 'NotSupportedError') {
                        // è®¾å¤‡ä¸æ”¯æŒGATT
                        errorMessage = 'è®¾å¤‡ä¸æ”¯æŒGATTè¿æ¥';
                    } else if (error.name === 'SecurityError') {
                        // å®‰å…¨æƒé™é—®é¢˜
                        errorMessage = 'è¿æ¥è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥è®¾å¤‡æƒé™è®¾ç½®';
                    } else if (error.name === 'InvalidStateError') {
                        // è®¾å¤‡çŠ¶æ€å¼‚å¸¸
                        errorMessage = 'è®¾å¤‡çŠ¶æ€å¼‚å¸¸ï¼Œè¯·é‡æ–°æ‰«æè®¾å¤‡';
                    } else if (error.message && error.message.includes('GATT Server is disconnected')) {
                        // GATTæœåŠ¡å™¨æ–­å¼€
                        errorMessage = 'è®¾å¤‡è¿æ¥å·²æ–­å¼€ï¼Œè¯·é‡æ–°è¿æ¥';
                    } else {
                        // å…¶ä»–æœªçŸ¥é”™è¯¯
                        errorMessage = `è¿æ¥å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯ï¼Œè¯·é‡è¯•'}`;
                    }
                    
                    this.showStatus('error', errorMessage);
                    this.log(errorMessage);
                    
                    // æ¸…ç†è¿æ¥çŠ¶æ€
                    this.connectedDevice = null;
                    this.connectedServer = null;
                }
            }

            async readDeviceCharacteristics(server) {
                try {
                    this.characteristicsContainer.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">æ­£åœ¨è¯»å–è®¾å¤‡ç‰¹å¾...</p>';
                    this.log('å¼€å§‹è¯»å–è®¾å¤‡ç‰¹å¾');
                    
                    const services = await server.getPrimaryServices();
                    this.log(`è¯»å–åˆ°æœåŠ¡æ•°é‡ï¼š${services.length}`);
                    const targetCharacteristics = [];
                    
                    // ç›®æ ‡UUIDèŒƒå›´ (0x2A24-0x2A29)
                    const targetUUIDs = [
                        '00002a24-0000-1000-8000-00805f9b34fb', // Model Number String
                        '00002a25-0000-1000-8000-00805f9b34fb', // Serial Number String
                        '00002a26-0000-1000-8000-00805f9b34fb', // Firmware Revision String
                        '00002a27-0000-1000-8000-00805f9b34fb', // Hardware Revision String
                        '00002a28-0000-1000-8000-00805f9b34fb', // Software Revision String
                        '00002a29-0000-1000-8000-00805f9b34fb'  // Manufacturer Name String
                    ];

                    for (const service of services) {
                        try {
                            this.log(`æœåŠ¡: ${service.uuid}`);
                            const characteristics = await service.getCharacteristics();
                            // è®°å½•æœåŠ¡çš„ç‰¹å¾æ•°é‡
                            this.log(`æœåŠ¡ç‰¹å¾æ•°é‡ï¼š${characteristics.length}`);
                            for (const characteristic of characteristics) {
                                const uuid = characteristic.uuid.toLowerCase();
                                const propsStr = this.formatProperties(characteristic.properties);
                                this.log(`  ç‰¹å¾: ${uuid} [${propsStr}]`);
                                // é€‰æ‹©ä¸€ä¸ªå¯å†™ç‰¹å¾ç”¨äºå‘é€æ§åˆ¶æŒ‡ä»¤ï¼ˆä¼˜å…ˆ writeWithoutResponseï¼‰
                                if (!this.txCharacteristic &&  service.uuid === '59462f12-9543-9999-12c8-58b459a2712d' &&
                                    (characteristic.properties.writeWithoutResponse || characteristic.properties.write)) {
                                    this.txCharacteristic = characteristic;
                                    this.log(`é€‰æ‹©å¯å†™ç‰¹å¾ç”¨äºå‘é€æŒ‡ä»¤: ${uuid}`);
                                }

                                // è®¢é˜…é€šçŸ¥å‹ç‰¹å¾
                                if ((characteristic.properties.notify || characteristic.properties.indicate) && !this.subscribedNotifyUUIDs.has(uuid)) {
                                    try {
                                        await characteristic.startNotifications();
                                        characteristic.addEventListener('characteristicvaluechanged', (event) => {
                                            const dv = event.target.value;
                                            const bytes = new Uint8Array(dv.buffer, dv.byteOffset, dv.byteLength);
                                            const ascii = new TextDecoder('utf-8').decode(bytes).replace(/\0+$/g, '');
                                            const hex = this.formatHex(bytes);
                                            this.notify(`${uuid} -> ASCII: ${ascii}`);
                                            this.notify(`${uuid} -> HEX: ${hex}`);
                                            // è§£æå¹¶æ›´æ–°è®¾å¤‡çŠ¶æ€å¡ç‰‡ï¼ˆB9 å¸§ï¼‰
                                            this.handleStatusFrame(bytes);
                                        });
                                        this.subscribedNotifyUUIDs.add(uuid);
                                        this.updateNotifyList(uuid, propsStr);
                                        if (this.notifyStatus) {
                                            this.notifyStatus.style.display = 'block';
                                            this.notifyStatus.className = 'status connected';
                                            this.notifyStatus.textContent = 'å·²è®¢é˜…é€šçŸ¥ç‰¹å¾ï¼Œç­‰å¾…æ¶ˆæ¯...';
                                        }
                                        this.log(`å·²è®¢é˜…é€šçŸ¥ç‰¹å¾: ${uuid}`);
                                    } catch (e) {
                                        this.log(`è®¢é˜…é€šçŸ¥å¤±è´¥: ${uuid} (${e.name || 'Error'}: ${e.message || ''})`);
                                    }
                                }
                                
                                // æ£€æŸ¥æ˜¯å¦åœ¨ç›®æ ‡èŒƒå›´å†…
                                if (targetUUIDs.includes(uuid)) {
                                    let value = 'N/A';
                                    
                                    try {
                                        if (characteristic.properties.read) {
                                            const dataView = await characteristic.readValue();
                                            const bytes = new Uint8Array(dataView.buffer);
                                            value = new TextDecoder('utf-8').decode(bytes).replace(/\0+$/g, '');
                                            // æ‰“å°ç›®æ ‡ç‰¹å¾çš„å€¼
                                            this.log(`    å€¼(ASCII): ${value}`);
                                            this.log(`    å€¼(HEX): ${this.formatHex(bytes)}`);
                                            this.log(`è¯»å–ç‰¹å¾æˆåŠŸï¼š${this.getCharacteristicName(uuid)}`);
                                        }
                                    } catch (readError) {
                                        console.warn(`æ— æ³•è¯»å–ç‰¹å¾ ${uuid}:`, readError);
                                        this.log(`è¯»å–ç‰¹å¾å¤±è´¥ï¼š${uuid} (${readError.name || 'Error'}: ${readError.message || ''})`);
                                        value = 'è¯»å–å¤±è´¥';
                                    }
                                    
                                    targetCharacteristics.push({
                                        uuid: uuid,
                                        properties: characteristic.properties,
                                        value: value,
                                        name: this.getCharacteristicName(uuid)
                                    });
                                    this.log(`å‘ç°ç›®æ ‡ç‰¹å¾ï¼š${this.getCharacteristicName(uuid)}`);
                                } else {
                                    // éç›®æ ‡ç‰¹å¾ä¹Ÿå°è¯•æ‰“å°å…¶å€¼ï¼ˆè‹¥å¯è¯»ï¼‰
                                    try {
                                        if (characteristic.properties.read) {
                                            const dv = await characteristic.readValue();
                                            const bytes = new Uint8Array(dv.buffer);
                                            const ascii = new TextDecoder('utf-8').decode(bytes).replace(/\0+$/g, '');
                                            this.log(`    å€¼(ASCII): ${ascii}`);
                                            this.log(`    å€¼(HEX): ${this.formatHex(bytes)}`);
                                        }
                                    } catch (e) {
                                        this.log(`    è¯»å–å€¼å¤±è´¥ (${e.name || 'Error'}: ${e.message || ''})`);
                                    }
                                }
                            }

                        } catch (serviceError) {
                            console.warn('è¯»å–æœåŠ¡ç‰¹å¾å¤±è´¥:', serviceError);
                            const reason = `${serviceError.name || 'Error'}: ${serviceError.message || ''}`;
                            this.log(`è¯»å–æœåŠ¡ç‰¹å¾å¤±è´¥ï¼š${reason}`);
                        }
                    }
                    
                    this.displayCharacteristics(targetCharacteristics);
                    
                } catch (error) {
                    console.error('è¯»å–è®¾å¤‡ç‰¹å¾å¤±è´¥:', error);
                    this.log(`è¯»å–è®¾å¤‡ç‰¹å¾å¤±è´¥ï¼š${error.message}`);
                    this.characteristicsContainer.innerHTML = `<p style="text-align: center; color: #cc0000; padding: 20px;">è¯»å–ç‰¹å¾å¤±è´¥: ${error.message}</p>`;
                }
            }

            // åœ¨é€šçŸ¥å¡ç‰‡ä¸­è®°å½•å·²è®¢é˜…ç‰¹å¾
            updateNotifyList(uuid, propsStr) {
                if (!this.notifyList) return;
                const item = document.createElement('div');
                item.className = 'characteristic-item';
                const properties = propsStr
                    .split(',')
                    .filter(Boolean)
                    .map(p => `<span class="property-tag">${p}</span>`) 
                    .join('');
                item.innerHTML = `
                    <div class="characteristic-uuid">${uuid}</div>
                    <div class="characteristic-properties">${properties}</div>
                    <div class="characteristic-value" style="font-size:0.9rem;color:#6c757d">å·²å¼€å§‹æ¥æ”¶é€šçŸ¥...</div>
                `;
                this.notifyList.appendChild(item);
            }

            getCharacteristicName(uuid) {
                const names = {
                    '00002a24-0000-1000-8000-00805f9b34fb': 'Model Number String',
                    '00002a25-0000-1000-8000-00805f9b34fb': 'Serial Number String',
                    '00002a26-0000-1000-8000-00805f9b34fb': 'Firmware Revision String',
                    '00002a27-0000-1000-8000-00805f9b34fb': 'Hardware Revision String',
                    '00002a28-0000-1000-8000-00805f9b34fb': 'Software Revision String',
                    '00002a29-0000-1000-8000-00805f9b34fb': 'Manufacturer Name String'
                };
                return names[uuid] || 'Unknown Characteristic';
            }

            displayCharacteristics(characteristics) {
                if (characteristics.length === 0) {
                    this.characteristicsContainer.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">æœªå‘ç°0x2A24-0x2A29èŒƒå›´å†…çš„ç‰¹å¾</p>';
                    return;
                }

                const grid = document.createElement('div');
                grid.className = 'characteristics-grid';

                characteristics.forEach(char => {
                    const charElement = document.createElement('div');
                    charElement.className = 'characteristic-item';
                    
                    const properties = Object.keys(char.properties)
                        .filter(prop => char.properties[prop])
                        .map(prop => `<span class="property-tag">${prop}</span>`)
                        .join('');

                    charElement.innerHTML = `
                        <div class="characteristic-uuid">${char.name}</div>
                        <div class="characteristic-uuid" style="font-size: 0.8rem; color: #6c757d;">${char.uuid}</div>
                        <div class="characteristic-properties">${properties}</div>
                        <div class="characteristic-value">${char.value}</div>
                    `;

                    grid.appendChild(charElement);
                });

                this.characteristicsContainer.innerHTML = '';
                this.characteristicsContainer.appendChild(grid);
            }

            // è§£æçŠ¶æ€é€šçŸ¥å¸§å¹¶æ›´æ–°è®¾å¤‡çŠ¶æ€
            handleStatusFrame(bytes) {
                try {
                    const START = 0xB9, END = 0xB9;
                    if (bytes[0] == START || bytes[bytes.length - 1] == END) {
                        const len = bytes[1];
                        const payloadLen = bytes.length;
                        if (len !== payloadLen) {
                            this.notify(`çŠ¶æ€å¸§é•¿åº¦ä¸ä¸€è‡´: len=${len}, å®é™…=${payloadLen}`);
                        }
                        const battery = bytes[2];
                        const realTemp = (bytes[3] << 8) | bytes[4];
                        const setTemp = (bytes[5] << 8) | bytes[6];
                        const lightMode = bytes[7];
                        const setTime = bytes[8];
                        const remainTime = (bytes[9] << 8) | bytes[10]; 
                        this.updateDeviceStatus({ battery, realTemp, setTemp, lightMode, setTime, remainTime });
                        return true;                        
                    }
                    else if (bytes[0] == 0xb1 && bytes[bytes.length - 1] == 0xb1) {
                        const len = bytes[1];
                        const payloadLen = bytes.length;
                        if (len !== payloadLen) {
                            this.notify(`B1å¸§é•¿åº¦ä¸ä¸€è‡´: len=${len}, å®é™…=${payloadLen}`);
                        }
                        const preHeatTemp = (bytes[2] << 8) | bytes[3];
                        const rampUpTemp = (bytes[4] << 8) | bytes[5];
                        const steadyTemp = (bytes[6] << 8) | bytes[7];
                        const boostTemp = (bytes[8] << 8) | bytes[9];
                        const cooldownTemp = (bytes[10] << 8) | bytes[11];
                        const preHeatTime = bytes[12];
                        const rampUpTime = bytes[13];
                        const steadyTime = bytes[14];
                        const boostTime = bytes[15];
                        const cooldownTime = bytes[16];
                        this.updateB1UI({ preHeatTemp, rampUpTemp, steadyTemp, boostTemp, cooldownTemp, preHeatTime, rampUpTime, steadyTime, boostTime, cooldownTime });
                        this.notify(`B1å¸§: ${this.formatHex(bytes)}`);
                        return true;
                    }
                    else if (bytes[0] == 0xb2 && bytes[bytes.length - 1] == 0xb2) {
                        const len = bytes[1];
                        const payloadLen = bytes.length;
                        if (len !== payloadLen) {
                            this.notify(`B2å¸§é•¿åº¦ä¸ä¸€è‡´: len=${len}, å®é™…=${payloadLen}`);
                        }


                        const preHeatTemp = (bytes[2] << 8) | bytes[3];
                        const rampUpTemp = (bytes[4] << 8) | bytes[5];
                        const steadyTemp = (bytes[6] << 8) | bytes[7];
                        const boostTemp = (bytes[8] << 8) | bytes[9];
                        const cooldownTemp = (bytes[10] << 8) | bytes[11];
                        const preHeatTime = bytes[12];
                        const rampUpTime = bytes[13];
                        const steadyTime = bytes[14];
                        const boostTime = bytes[15];
                        const cooldownTime = bytes[16];
                        this.updateB2UI({ preHeatTemp, rampUpTemp, steadyTemp, boostTemp, cooldownTemp, preHeatTime, rampUpTime, steadyTime, boostTime, cooldownTime });
                        this.notify(`B2å¸§: ${this.formatHex(bytes)}`);


                        return true;
                    }
                    else {
                        const hexString = bytes.map(b => b.toString(16).padStart(2, '0')).join(' ');
                        this.notify(`å¤±è´¥å¸§: ${hexString}`);
                        return false;
                    }

                } catch (e) {
                    this.notify(`è§£æçŠ¶æ€å¸§å¤±è´¥: ${e.message || e}`);
                    return false;
                }
            }

            updateDeviceStatus({ battery, realTemp, setTemp, lightMode, setTime, remainTime }) {
                if (this.batteryValue) this.batteryValue.textContent = `${battery}%`;
                if (this.realTempValue) this.realTempValue.textContent = `${realTemp}Â°C`;
                if (this.setTempValue) this.setTempValue.textContent = `${setTemp}Â°C`;
                if (this.setTimeValue) this.setTimeValue.textContent = `${setTime}Min`;
                // åŒæ­¥è®¾å¤‡æ§åˆ¶å¡ç‰‡ï¼šæ›´æ–°æ»‘åŠ¨æ¡çš„ä½ç½®ä¸æ•°å€¼æ˜¾ç¤º
                const tempC = Math.round(setTemp);
                if (this.setTempInput) this.setTempInput.value = String(tempC);
                if (this.setTempDisplay) this.setTempDisplay.textContent = `${tempC}â„ƒ`;
                if (this.setTimeInput) this.setTimeInput.value = String(setTime);
                if (this.setTimeDisplay) this.setTimeDisplay.textContent = `${setTime}min`;
                // åŒæ­¥ç¯å…‰æ¨¡å¼æŒ‰é’®é€‰ä¸­æ€
                if (this.lightModeControls) {
                    const modeButtons = Array.from(this.lightModeControls.querySelectorAll('button[data-mode]'));
                    modeButtons.forEach(b => {
                        const m = parseInt(b.getAttribute('data-mode')) || 0;
                        b.classList.toggle('active', m === lightMode);
                    });
                }
                // ç¼“å­˜å½“å‰ç¯å…‰æ¨¡å¼
                this.currentLightMode = lightMode;
                if (this.remainTimeValue) {
                const minutes = Math.floor(remainTime / 60);
                const seconds = remainTime % 60;
                this.remainTimeValue.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
                if (this.lightModeValue) this.lightModeValue.textContent = this.mapLightMode(lightMode);
                if (this.deviceStatusTips) {
                    this.deviceStatusTips.style.display = 'block';
                    this.deviceStatusTips.className = 'status connected';
                    this.deviceStatusTips.textContent = 'å·²æ¥æ”¶è®¾å¤‡çŠ¶æ€å¹¶æ›´æ–°æ˜¾ç¤º';
                }
            }

            resetDeviceStatus() {
                if (this.batteryValue) this.batteryValue.textContent = '-';
                if (this.realTempValue) this.realTempValue.textContent = '-';
                if (this.setTempValue) this.setTempValue.textContent = '-';
                if (this.setTimeValue) this.setTimeValue.textContent = '-';
                if (this.remainTimeValue) this.remainTimeValue.textContent = '-';
                if (this.lightModeValue) this.lightModeValue.textContent = '-';
                if (this.deviceStatusTips) {
                    this.deviceStatusTips.style.display = 'none';
                    this.deviceStatusTips.textContent = '';
                }
            }

            mapLightMode(value) {
                const map = { 0: 'å…³é—­', 1: 'å¸¸äº®', 2: 'å‘¼å¸', 3: 'é—ªçƒ' };
                return Object.prototype.hasOwnProperty.call(map, value) ? map[value] : `æ¨¡å¼(${value})`;
            }

            // æ§åˆ¶çŠ¶æ€æ˜¾ç¤º
            showControlStatus(type, message) {
                if (!this.controlStatus) return;
                this.controlStatus.style.display = 'block';
                this.controlStatus.className = `status ${type}`;
                this.controlStatus.textContent = message;
            }

            // æ„å»º A9 æ§åˆ¶å¸§: A9 07 lightMode set_temp(high) set_temp(low) set_time A9
            buildA9Frame(lightMode, setTempCelsius, setTimeMinutes) {
                const START = 0xA9, END = 0xA9;
                const buf = new Uint8Array(7);
                buf[0] = START;
                buf[1] = 0x07;
                const lm = Math.max(0, Math.min(5, (lightMode || 0) | 0));
                const tempRaw = Math.max(150, Math.min(300, Math.round((setTempCelsius || 150))));
                const timeMin = Math.max(30, Math.min(120, (setTimeMinutes || 30) | 0));
                buf[2] = lm;
                buf[3] = (tempRaw >> 8) & 0xFF;
                buf[4] = tempRaw & 0xFF;
                buf[5] = timeMin & 0xFF;
                buf[6] = END;
                return buf;
            }

            // å‘é€æ§åˆ¶æŒ‡ä»¤
            async sendControlCommand(lightMode, tempC, timeMin) {
                try {
                    if (!this.connectedServer) {
                        this.showControlStatus('error', 'è®¾å¤‡æœªè¿æ¥');
                        return;
                    }
                    if (!this.txCharacteristic) {
                        this.showControlStatus('error', 'æœªæ‰¾åˆ°å¯å†™ç‰¹å¾ï¼Œè¯·ç¡®ä¿è®¾å¤‡å­˜åœ¨æ”¯æŒå†™å…¥çš„ç‰¹å¾');
                        return;
                    }
                    // âœ… æ‰“å°ç‰¹å¾å¯¹è±¡åŠå…¶å±æ€§
                    console.log('ğŸ” txCharacteristic å¯¹è±¡:', this.txCharacteristic);
                    console.log('ğŸ” txCharacteristic å±æ€§:', {
                        uuid: this.txCharacteristic.uuid,
                        properties: this.txCharacteristic.properties,
                        service: this.txCharacteristic.service?.uuid || '(æœªçŸ¥æœåŠ¡)',
                        value: this.txCharacteristic.value ? new Uint8Array(this.txCharacteristic.value.buffer) : '(æ— å€¼)'
                    });





                    const frame = this.buildA9Frame(lightMode, tempC, timeMin);
                    const supportsWriteWithout = this.txCharacteristic.properties.writeWithoutResponse;
                    if (supportsWriteWithout && this.txCharacteristic.writeValueWithoutResponse) {
                        await this.txCharacteristic.writeValueWithoutResponse(frame);
                    } else if (this.txCharacteristic.writeValue) {
                        await this.txCharacteristic.writeValue(frame);
                    } else {
                        this.showControlStatus('error', 'è¯¥ç‰¹å¾ä¸æ”¯æŒå†™å…¥');
                        return;
                    }
                    this.showControlStatus('connected', `å·²å‘é€æ§åˆ¶æŒ‡ä»¤: æ¨¡å¼=${lightMode}, æ¸©åº¦=${tempC}â„ƒ, æ—¶é—´=${timeMin}min`);
                    this.log(`å‘é€ A9 å¸§: ${this.formatHex(frame)}`);
                } catch (e) {
                    this.showControlStatus('error', `å‘é€å¤±è´¥: ${e.message || e}`);
                    this.log(`å‘é€æ§åˆ¶æŒ‡ä»¤å¤±è´¥: ${e.message || e}`);
                }
            }

            // å‘é€é˜²æŠ–ï¼šåœ¨æ»šè½®å˜åŒ–æ—¶å»¶è¿Ÿå‘é€ï¼Œé¿å…é«˜é¢‘å†™å…¥
            scheduleDebouncedSend() {
                if (this.debounceTimer) {
                    clearTimeout(this.debounceTimer);
                }
                this.debounceTimer = setTimeout(() => {
                    const mode = this.currentLightMode || 0;
                    const temp = parseInt(this.setTempInput?.value || '200', 10);
                    const time = parseInt(this.setTimeInput?.value || '60', 10);
                    this.sendControlCommand(mode, temp, time);
                    this.debounceTimer = null;
                }, 400);
            }

            showStatus(type, message) {
                this.scanStatus.style.display = 'block';
                this.scanStatus.className = `status ${type}`;
                this.scanStatus.textContent = message;
                
                if (type !== 'scanning') {
                    setTimeout(() => {
                        this.scanStatus.style.display = 'none';
                    }, 5000);
                }
            }

            // B1 UI æ›´æ–°
            updateB1UI({ preHeatTemp, rampUpTemp, steadyTemp, boostTemp, cooldownTemp, preHeatTime, rampUpTime, steadyTime, boostTime, cooldownTime }) {
                if (this.b1PreHeatTemp) this.b1PreHeatTemp.value = String(preHeatTemp);
                if (this.b1RampUpTemp) this.b1RampUpTemp.value = String(rampUpTemp);
                if (this.b1SteadyTemp) this.b1SteadyTemp.value = String(steadyTemp);
                if (this.b1BoostTemp) this.b1BoostTemp.value = String(boostTemp);
                if (this.b1CooldownTemp) this.b1CooldownTemp.value = String(cooldownTemp);
                if (this.b1PreHeatTime) this.b1PreHeatTime.value = String(preHeatTime);
                if (this.b1RampUpTime) this.b1RampUpTime.value = String(rampUpTime);
                if (this.b1SteadyTime) this.b1SteadyTime.value = String(steadyTime);
                if (this.b1BoostTime) this.b1BoostTime.value = String(boostTime);
                if (this.b1CooldownTime) this.b1CooldownTime.value = String(cooldownTime);
                if (this.b1Status) {
                    this.b1Status.style.display = 'block';
                    this.b1Status.className = 'status connected';
                    this.b1Status.textContent = 'å·²æ¥æ”¶å¹¶æ›´æ–° B1 é˜¶æ®µå‚æ•°';
                }
            }

            // B2 UI æ›´æ–°
            updateB2UI({ preHeatTemp, rampUpTemp, steadyTemp, boostTemp, cooldownTemp, preHeatTime, rampUpTime, steadyTime, boostTime, cooldownTime }) {
                if (this.b2PreHeatTemp) this.b2PreHeatTemp.value = String(preHeatTemp);
                if (this.b2RampUpTemp) this.b2RampUpTemp.value = String(rampUpTemp);
                if (this.b2SteadyTemp) this.b2SteadyTemp.value = String(steadyTemp);
                if (this.b2BoostTemp) this.b2BoostTemp.value = String(boostTemp);
                if (this.b2CooldownTemp) this.b2CooldownTemp.value = String(cooldownTemp);
                if (this.b2PreHeatTime) this.b2PreHeatTime.value = String(preHeatTime);
                if (this.b2RampUpTime) this.b2RampUpTime.value = String(rampUpTime);
                if (this.b2SteadyTime) this.b2SteadyTime.value = String(steadyTime);
                if (this.b2BoostTime) this.b2BoostTime.value = String(boostTime);
                if (this.b2CooldownTime) this.b2CooldownTime.value = String(cooldownTime);
                if (this.b2Status) {
                    this.b2Status.style.display = 'block';
                    this.b2Status.className = 'status connected';
                    this.b2Status.textContent = 'å·²æ¥æ”¶å¹¶æ›´æ–° B2 é˜¶æ®µå‚æ•°';
                }
            }
            // æ„å»º A1 å¸§: A1 12 10å­—èŠ‚æ¸©åº¦(äº”æ®µé«˜ä½ä½) + 5å­—èŠ‚æ—¶é—´ + A1
            buildA1Frame(params) {
                const START = 0xA1, END = 0xA1;
                const buf = new Uint8Array(19);
                buf[0] = START;
                buf[1] = 0x12;
                const clampTemp = (v) => Math.max(70, Math.min(300, Math.round(v || 70)));
                const clampTime = (v) => Math.max(0, Math.min(120, (v || 0) | 0));
                const temps = [params.preHeatTemp, params.rampUpTemp, params.steadyTemp, params.boostTemp, params.cooldownTemp].map(clampTemp);
                const times = [params.preHeatTime, params.rampUpTime, params.steadyTime, params.boostTime, params.cooldownTime].map(clampTime);
                let i = 2;
                for (const t of temps) { buf[i++] = (t >> 8) & 0xFF; buf[i++] = t & 0xFF; }
                for (const tm of times) { buf[i++] = tm & 0xFF; }
                buf[i++] = END;
                return buf;
            }
            // æ„å»º A2 å¸§: A2 12 10å­—èŠ‚æ¸©åº¦(äº”æ®µé«˜ä½ä½) + 5å­—èŠ‚æ—¶é—´ + A2
            buildA2Frame(params) {
                const START = 0xA2, END = 0xA2;
                const buf = new Uint8Array(19);
                buf[0] = START;
                buf[1] = 0x12;
                const clampTemp = (v) => Math.max(70, Math.min(300, Math.round(v || 70)));
                const clampTime = (v) => Math.max(0, Math.min(120, (v || 0) | 0));
                const temps = [params.preHeatTemp, params.rampUpTemp, params.steadyTemp, params.boostTemp, params.cooldownTemp].map(clampTemp);
                const times = [params.preHeatTime, params.rampUpTime, params.steadyTime, params.boostTime, params.cooldownTime].map(clampTime);
                let i = 2;
                for (const t of temps) { buf[i++] = (t >> 8) & 0xFF; buf[i++] = t & 0xFF; }
                for (const tm of times) { buf[i++] = tm & 0xFF; }
                buf[i++] = END;
                return buf;
            }

            // å‘é€ A1 å¸§ï¼ˆä» B1 å¡ç‰‡å½“å‰å‚æ•°ï¼‰
            async sendA1FrameFromUI() {
                if (!this.connectedServer) { this.showControlStatus('error', 'è®¾å¤‡æœªè¿æ¥'); return; }
                if (!this.txCharacteristic) { this.showControlStatus('error', 'æœªæ‰¾åˆ°å¯å†™ç‰¹å¾'); return; }
                const params = {
                    preHeatTemp: parseInt(this.b1PreHeatTemp?.value || '200', 10),
                    rampUpTemp: parseInt(this.b1RampUpTemp?.value || '200', 10),
                    steadyTemp: parseInt(this.b1SteadyTemp?.value || '200', 10),
                    boostTemp: parseInt(this.b1BoostTemp?.value || '200', 10),
                    cooldownTemp: parseInt(this.b1CooldownTemp?.value || '200', 10),
                    preHeatTime: parseInt(this.b1PreHeatTime?.value || '0', 10),
                    rampUpTime: parseInt(this.b1RampUpTime?.value || '0', 10),
                    steadyTime: parseInt(this.b1SteadyTime?.value || '0', 10),
                    boostTime: parseInt(this.b1BoostTime?.value || '0', 10),
                    cooldownTime: parseInt(this.b1CooldownTime?.value || '0', 10),
                };
                const frame = this.buildA1Frame(params);
                const supportsWriteWithout = this.txCharacteristic.properties.writeWithoutResponse;
                if (supportsWriteWithout && this.txCharacteristic.writeValueWithoutResponse) {
                    await this.txCharacteristic.writeValueWithoutResponse(frame);
                } else if (this.txCharacteristic.writeValue) {
                    await this.txCharacteristic.writeValue(frame);
                } else {
                    this.showControlStatus('error', 'è¯¥ç‰¹å¾ä¸æ”¯æŒå†™å…¥');
                    return;
                }
                this.showControlStatus('connected', 'å·²å‘é€ A1 é˜¶æ®µæ§åˆ¶');
                this.log(`å‘é€ A1 å¸§: ${this.formatHex(frame)}`);
            }
            scheduleDebouncedSendA1() {
                if (this.debounceTimerA1) clearTimeout(this.debounceTimerA1);
                this.debounceTimerA1 = setTimeout(() => {
                    this.sendA1FrameFromUI();
                }, 400);
            }

            async sendA2FrameFromUI() {
                if (!this.connectedServer) { this.showControlStatus('error', 'è®¾å¤‡æœªè¿æ¥'); return; }
                if (!this.txCharacteristic) { this.showControlStatus('error', 'æœªæ‰¾åˆ°å¯å†™ç‰¹å¾'); return; }
                const params = {
                    preHeatTemp: parseInt(this.b2PreHeatTemp?.value || '200', 10),
                    rampUpTemp: parseInt(this.b2RampUpTemp?.value || '200', 10),
                    steadyTemp: parseInt(this.b2SteadyTemp?.value || '200', 10),
                    boostTemp: parseInt(this.b2BoostTemp?.value || '200', 10),
                    cooldownTemp: parseInt(this.b2CooldownTemp?.value || '200', 10),
                    preHeatTime: parseInt(this.b2PreHeatTime?.value || '0', 10),
                    rampUpTime: parseInt(this.b2RampUpTime?.value || '0', 10),
                    steadyTime: parseInt(this.b2SteadyTime?.value || '0', 10),
                    boostTime: parseInt(this.b2BoostTime?.value || '0', 10),
                    cooldownTime: parseInt(this.b2CooldownTime?.value || '0', 10),
                };
                const frame = this.buildA2Frame(params);
                const supportsWriteWithout = this.txCharacteristic.properties.writeWithoutResponse;
                if (supportsWriteWithout && this.txCharacteristic.writeValueWithoutResponse) {
                    await this.txCharacteristic.writeValueWithoutResponse(frame);
                } else if (this.txCharacteristic.writeValue) {
                    await this.txCharacteristic.writeValue(frame);
                } else {
                    this.showControlStatus('error', 'è¯¥ç‰¹å¾ä¸æ”¯æŒå†™å…¥');
                    return;
                }
                this.showControlStatus('connected', 'å·²å‘é€ A2 é˜¶æ®µæ§åˆ¶');
                this.log(`å‘é€ A2 å¸§: ${this.formatHex(frame)}`);
            }
            scheduleDebouncedSendA2() {
                if (this.debounceTimerA2) clearTimeout(this.debounceTimerA2);
                this.debounceTimerA2 = setTimeout(() => {
                    this.sendA2FrameFromUI();
                }, 400);
            }

            // å‘é€ A3 å¯åŠ¨ WiFiï¼šA3 03 A3
            async sendA3StartFromUI() {
                if (!this.connectedServer) { this.showControlStatus('error', 'è®¾å¤‡æœªè¿æ¥'); return; }
                if (!this.txCharacteristic) { this.showControlStatus('error', 'æœªæ‰¾åˆ°å¯å†™ç‰¹å¾'); return; }
                const frame = new Uint8Array([0xA3, 0x03, 0xA3]);
                const supportsWriteWithout = this.txCharacteristic.properties.writeWithoutResponse;
                try {
                    if (supportsWriteWithout && this.txCharacteristic.writeValueWithoutResponse) {
                        await this.txCharacteristic.writeValueWithoutResponse(frame);
                    } else if (this.txCharacteristic.writeValue) {
                        await this.txCharacteristic.writeValue(frame);
                    } else {
                        this.showControlStatus('error', 'è¯¥ç‰¹å¾ä¸æ”¯æŒå†™å…¥');
                        return;
                    }
                    this.showControlStatus('connected', 'å·²å‘é€ A3 WiFi Start');
                    this.log(`å‘é€ A3 å¸§: ${this.formatHex(frame)}`);
                } catch (err) {
                    this.showControlStatus('error', `å‘é€ A3 å¤±è´¥: ${err.message}`);
                }
            }

            // WiFi Startï¼šA3 20 ssidå‰åŠæ®µ A3ï¼›A4 20 ssidååŠæ®µ A4ï¼›A5 20 password A5
            async sendWifiConfigFromUI() {
                if (!this.connectedServer) { this.showControlStatus('error', 'è®¾å¤‡æœªè¿æ¥'); return; }
                if (!this.txCharacteristic) { this.showControlStatus('error', 'æœªæ‰¾åˆ°å¯å†™ç‰¹å¾'); return; }
                const ssid = (document.getElementById('ssidInput')?.value || '').trim();
                const password = (document.getElementById('passwordInput')?.value || '').trim();
                const enc = new TextEncoder();
                const ssidBytes = enc.encode(ssid);
                const pwdBytes = enc.encode(password);
                const pad17 = (bytes) => {
                    const out = new Uint8Array(17);
                    out.set(bytes.slice(0, 17));
                    return out;
                };
                const firstHalf = pad17(ssidBytes.slice(0, 17));
                const secondHalf = pad17(ssidBytes.slice(17, 34));
                const pwdPadded = pad17(pwdBytes);

                const buildFrame = (head, payload, tail) => {
                    const frame = new Uint8Array(20);
                    frame[0] = head; frame[1] = 0x14; frame.set(payload, 2); frame[19] = tail;
                    return frame;
                };

                const frameA3 = buildFrame(0xA3, firstHalf, 0xA3);
                const frameA4 = buildFrame(0xA4, secondHalf, 0xA4);
                const frameA5 = buildFrame(0xA5, pwdPadded, 0xA5);

                const supportsWriteWithout = this.txCharacteristic.properties.writeWithoutResponse;
                const write = async (frame) => {
                    if (supportsWriteWithout && this.txCharacteristic.writeValueWithoutResponse) {
                        await this.txCharacteristic.writeValueWithoutResponse(frame);
                    } else if (this.txCharacteristic.writeValue) {
                        await this.txCharacteristic.writeValue(frame);
                    } else {
                        throw new Error('è¯¥ç‰¹å¾ä¸æ”¯æŒå†™å…¥');
                    }
                };
                const sleep = (ms) => new Promise(r => setTimeout(r, ms));

                try {
                    this.showControlStatus('scanning', 'å‘é€WiFié…ç½®ä¸­...');
                    await write(frameA3);
                    this.log(`å‘é€ A3 å¸§: ${this.formatHex(frameA3)} | SSIDå‰åŠæ®µ`);
                    await sleep(100);
                    await write(frameA4);
                    this.log(`å‘é€ A4 å¸§: ${this.formatHex(frameA4)} | SSIDååŠæ®µ`);
                    await sleep(100);
                    await write(frameA5);
                    this.log(`å‘é€ A5 å¸§: ${this.formatHex(frameA5)} | Password`);
                    this.showControlStatus('connected', 'WiFié…ç½®å‘é€å®Œæˆ');
                } catch (err) {
                    this.showControlStatus('error', `å‘é€WiFié…ç½®å¤±è´¥: ${err.message}`);
                }
            }

            // OTA Startï¼šA6 03 A6
            async sendA6StartFromUI() {
                if (!this.connectedServer) { this.showControlStatus('error', 'è®¾å¤‡æœªè¿æ¥'); return; }
                if (!this.txCharacteristic) { this.showControlStatus('error', 'æœªæ‰¾åˆ°å¯å†™ç‰¹å¾'); return; }
                const frame = new Uint8Array([0xA6, 0x03, 0xA6]);
                const supportsWriteWithout = this.txCharacteristic.properties.writeWithoutResponse;
                try {
                    if (supportsWriteWithout && this.txCharacteristic.writeValueWithoutResponse) {
                        await this.txCharacteristic.writeValueWithoutResponse(frame);
                    } else if (this.txCharacteristic.writeValue) {
                        await this.txCharacteristic.writeValue(frame);
                    } else {
                        this.showControlStatus('error', 'è¯¥ç‰¹å¾ä¸æ”¯æŒå†™å…¥');
                        return;
                    }
                    this.showControlStatus('connected', 'å·²å‘é€ A6 OTA Start');
                    this.log(`å‘é€ A6 å¸§: ${this.formatHex(frame)}`);
                } catch (err) {
                    this.showControlStatus('error', `å‘é€ A6 å¤±è´¥: ${err.message}`);
                }
            }

        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            new BluetoothDeviceManager();
        });
    </script>
</body>
</html>