<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JW203 è“ç‰™è®¾å¤‡ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .scan-section {
            text-align: center;
        }

        .scan-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .scan-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .scan-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-weight: 500;
        }

        .status.scanning {
            background: #e6f3ff;
            color: #0066cc;
            border: 1px solid #b3d9ff;
        }

        .status.connected {
            background: #e6ffe6;
            color: #006600;
            border: 1px solid #b3ffb3;
        }

        .status.error {
            background: #ffe6e6;
            color: #cc0000;
            border: 1px solid #ffb3b3;
        }

        .status.info {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .device-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .device-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .device-item:hover {
            background: #e3f2fd;
            border-color: #667eea;
            transform: translateX(5px);
        }

        .device-item.connected {
            background: #e8f5e8;
            border-color: #4caf50;
        }

        .device-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .device-id {
            font-size: 0.9rem;
            color: #6c757d;
            font-family: 'Courier New', monospace;
        }

        .characteristics-section {
            grid-column: 1 / -1;
        }

        .characteristics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .characteristic-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .characteristic-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .characteristic-uuid {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-family: 'Courier New', monospace;
        }

        .characteristic-properties {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .property-tag {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .characteristic-value {
            background: #ffffff;
            border: 1px solid #ced4da;
            border-radius: 5px;
            padding: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            word-break: break-all;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* æ“ä½œæ—¥å¿—æ ·å¼ */
        .log-section {
            margin-top: 12px;
            text-align: left;
        }
        .log-label {
            display: inline-block;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 6px;
        }
        .log-output {
            background: #0b1e3b;
            color: #a7ff83;
            border-radius: 8px;
            padding: 10px;
            min-height: 90px;
            max-height: 220px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            box-shadow: inset 0 0 6px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .characteristics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”µ JW203 è“ç‰™è®¾å¤‡ç®¡ç†</h1>
            <p>æ‰«æå¹¶è¿æ¥BLEè“ç‰™è®¾å¤‡ï¼ŒæŸ¥çœ‹è®¾å¤‡ç‰¹å¾ä¿¡æ¯</p>
        </div>

        <div class="main-content">
            <div class="card scan-section">
                <h2>ğŸ” è®¾å¤‡æ‰«æ</h2>
                <button id="scanBtn" class="scan-btn">å¼€å§‹æ‰«æè®¾å¤‡</button>
                <div style="margin-top: 12px">
                    <label for="extraServicesInput" class="log-label" style="margin-bottom: 6px; display:block;">é™„åŠ æœåŠ¡UUIDï¼ˆç”¨äºè®¢é˜…é€šçŸ¥ï¼Œé€—å·åˆ†éš”ï¼‰</label>
                    <input id="extraServicesInput" type="text" placeholder="ä¾‹å¦‚ï¼šffe0, fff0 æˆ– 0000ffe0-0000-1000-8000-00805f9b34fb" style="width:100%; padding:10px; border:1px solid #dee2e6; border-radius:8px;">
                    <div style="color:#6c757d; font-size: 0.9rem; margin-top: 6px;">æç¤ºï¼šå¦‚è®¾å¤‡ä½¿ç”¨è‡ªå®šä¹‰æœåŠ¡ï¼Œè¯·åœ¨æ‰«æå‰å¡«å…¥å¯¹åº”æœåŠ¡UUIDï¼›çŸ­UUIDä¼šè‡ªåŠ¨è½¬æ¢ä¸º128ä½ã€‚</div>
                </div>
                <div id="scanStatus" class="status" style="display: none;"></div>
                <div class="log-section">
                    <label class="log-label">æ“ä½œæ—¥å¿—</label>
                    <pre id="opLog" class="log-output"></pre>
                </div>
            </div>
        </div>

        <div class="card characteristics-section">
            <h2>ğŸ”§ è®¾å¤‡ç‰¹å¾ä¿¡æ¯ (0x2A24-0x2A29)</h2>
            <div id="characteristicsContainer">
                <p style="text-align: center; color: #6c757d; padding: 20px;">è¯·å…ˆè¿æ¥è®¾å¤‡ä»¥æŸ¥çœ‹ç‰¹å¾ä¿¡æ¯</p>
            </div>
        </div>

        <div class="card notify-section">
            <h2>ğŸ”” é€šçŸ¥æ¶ˆæ¯</h2>
            <div id="notifyStatus" class="status info" style="display: none;"></div>
            <div id="notifyList" class="characteristics-grid"></div>
            <pre id="notifyLog" class="log-output" style="min-height: 120px"></pre>
        </div>
    </div>

    <script>
        class BluetoothDeviceManager {
            constructor() {
                this.connectedDevice = null;
                this.connectedServer = null;
                this.scanBtn = document.getElementById('scanBtn');
                this.scanStatus = document.getElementById('scanStatus');
                this.characteristicsContainer = document.getElementById('characteristicsContainer');
                this.logOutput = document.getElementById('opLog');
                this.notifyLog = document.getElementById('notifyLog');
                this.notifyList = document.getElementById('notifyList');
                this.notifyStatus = document.getElementById('notifyStatus');
                this.subscribedNotifyUUIDs = new Set();
                this.extraServicesInput = document.getElementById('extraServicesInput');
                
                this.init();
            }

            init() {
                this.scanBtn.addEventListener('click', () => this.scanForDevices());
                
                // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒWeb Bluetooth
                if (!navigator.bluetooth) {
                    this.showStatus('error', 'æ­¤æµè§ˆå™¨ä¸æ”¯æŒWeb Bluetooth API');
                    this.scanBtn.disabled = true;
                }
                this.log('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            }

            // ç»Ÿä¸€æ—¥å¿—è¾“å‡º
            log(message) {
                const ts = new Date().toLocaleTimeString();
                const text = `[${ts}] ${message}`;
                if (this.logOutput) {
                    const line = document.createElement('div');
                    line.textContent = text;
                    this.logOutput.appendChild(line);
                    this.logOutput.scrollTop = this.logOutput.scrollHeight;
                }
                console.log(text);
            }

            // é€šçŸ¥æ—¥å¿—è¾“å‡º
            notify(message) {
                const ts = new Date().toLocaleTimeString();
                const text = `[${ts}] ${message}`;
                if (this.notifyLog) {
                    const line = document.createElement('div');
                    line.textContent = text;
                    this.notifyLog.appendChild(line);
                    this.notifyLog.scrollTop = this.notifyLog.scrollHeight;
                }
                console.log('[NOTIFY]', text);
            }

            // å­—èŠ‚æ•°ç»„è½¬ HEX æ–‡æœ¬
            formatHex(bytes) {
                return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join(' ');
            }

            // ç‰¹å¾å±æ€§è½¬å­—ç¬¦ä¸²
            formatProperties(props) {
                return Object.keys(props).filter(k => props[k]).join(',');
            }

            // è§„èŒƒåŒ–UUIDåˆ°128ä½æˆ–ä¿ç•™å·²è¯†åˆ«åˆ«å
            normalizeUuid(u) {
                const v = (u || '').trim().toLowerCase();
                if (!v) return '';
                if (/^[0-9a-f]{4}$/.test(v)) {
                    return `0000${v}-0000-1000-8000-00805f9b34fb`;
                }
                if (/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/.test(v)) {
                    return v;
                }
                // å…è®¸å·²çŸ¥åˆ«åï¼ˆå¦‚ device_informationï¼‰ç›´æ¥è¿”å›
                return v;
            }

            // è§£æç”¨æˆ·è¾“å…¥çš„é™„åŠ æœåŠ¡UUIDåˆ—è¡¨
            parseExtraServices() {
                const raw = this.extraServicesInput ? this.extraServicesInput.value : '';
                const parts = raw.split(/[\s,;ï¼Œï¼›]+/).filter(Boolean).map(p => this.normalizeUuid(p));
                return parts.filter(Boolean);
            }

            async scanForDevices() {
                try {
                    this.showStatus('scanning', 'æ­£åœ¨æ‰«æè®¾å¤‡...');
                    this.log('å¼€å§‹æ‰«æè®¾å¤‡');
                    this.scanBtn.disabled = true;
                    this.scanBtn.innerHTML = '<span class="loading"></span> æ‰«æä¸­...';

                    const defaultServices = ['generic_access', 'generic_attribute', 'device_information', '0000180a-0000-1000-8000-00805f9b34fb'];
                    const commonNotifyServices = [
                        '0000ffe0-0000-1000-8000-00805f9b34fb',
                        '0000fff0-0000-1000-8000-00805f9b34fb'
                    ];
                    const extra = this.parseExtraServices();
                    const optionalServices = Array.from(new Set([...defaultServices, ...commonNotifyServices, ...extra]));

                    this.log(`é™„åŠ æœåŠ¡è¾“å…¥: ${this.extraServicesInput && this.extraServicesInput.value ? this.extraServicesInput.value : '(ç©º)'}`);
                    this.log(`è¯·æ±‚çš„å¯é€‰æœåŠ¡: ${optionalServices.join(', ')}`);

                    const device = await navigator.bluetooth.requestDevice({
                        acceptAllDevices: true,
                        optionalServices
                    });

                    this.showStatus('scanning', `æ­£åœ¨è¿æ¥: ${device.name || 'æœªçŸ¥è®¾å¤‡'}`);
                    this.log(`å‘ç°è®¾å¤‡ï¼š${device.name || 'æœªçŸ¥è®¾å¤‡'} (ID: ${device.id})`);
                    await this.connectToDevice(device);
                    
                } catch (error) {
                    console.error('æ‰«æè®¾å¤‡å¤±è´¥:', error);
                    
                    // åŒºåˆ†ä¸åŒç±»å‹çš„é”™è¯¯
                    let errorMessage = '';
                    
                    if (error.name === 'NotFoundError') {
                        // ç”¨æˆ·å–æ¶ˆé€‰æ‹©è®¾å¤‡
                        errorMessage = 'ç”¨æˆ·å–æ¶ˆäº†è®¾å¤‡é€‰æ‹©';
                        this.showStatus('info', errorMessage);
                        this.log(errorMessage);
                    } else if (error.name === 'SecurityError') {
                        // æƒé™é—®é¢˜
                        errorMessage = 'è“ç‰™æƒé™è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®';
                        this.showStatus('error', errorMessage);
                        this.log(errorMessage);
                    } else if (error.name === 'NotSupportedError') {
                        // è®¾å¤‡ä¸æ”¯æŒ
                        errorMessage = 'å½“å‰è®¾å¤‡ä¸æ”¯æŒè“ç‰™åŠŸèƒ½';
                        this.showStatus('error', errorMessage);
                        this.log(errorMessage);
                    } else if (error.name === 'InvalidStateError') {
                        // è“ç‰™çŠ¶æ€å¼‚å¸¸
                        errorMessage = 'è“ç‰™çŠ¶æ€å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥è“ç‰™æ˜¯å¦å·²å¼€å¯';
                        this.showStatus('error', errorMessage);
                        this.log(errorMessage);
                    } else {
                        // å…¶ä»–æœªçŸ¥é”™è¯¯
                        errorMessage = `æ‰«æå¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`;
                        this.showStatus('error', errorMessage);
                        this.log(errorMessage);
                    }
                } finally {
                    this.scanBtn.disabled = false;
                    this.scanBtn.innerHTML = 'å¼€å§‹æ‰«æè®¾å¤‡';
                    this.log('æ‰«æç»“æŸ');
                }
            }

            async connectToDevice(device) {
                try {
                    this.showStatus('scanning', 'æ­£åœ¨è¿æ¥è®¾å¤‡...');
                    this.log(`å°è¯•è¿æ¥è®¾å¤‡ï¼š${device.name || 'æœªçŸ¥è®¾å¤‡'} (ID: ${device.id})`);
                    
                    // æ–­å¼€ä¹‹å‰çš„è¿æ¥
                    if (this.connectedServer) {
                        this.connectedServer.disconnect();
                    }

                    // è¿æ¥åˆ°è®¾å¤‡
                    const server = await device.gatt.connect();
                    this.connectedDevice = device;
                    this.connectedServer = server;

                    // æ¸…ç©ºé€šçŸ¥åŒºå¹¶é‡ç½®å·²è®¢é˜…åˆ—è¡¨
                    this.subscribedNotifyUUIDs.clear();
                    if (this.notifyLog) this.notifyLog.textContent = '';
                    if (this.notifyList) this.notifyList.innerHTML = '';

                    this.showStatus('connected', `å·²è¿æ¥åˆ°: ${device.name || 'æœªçŸ¥è®¾å¤‡'}`);
                    this.log('è®¾å¤‡è¿æ¥æˆåŠŸ');
                    
                    // è¯»å–è®¾å¤‡ç‰¹å¾
                    await this.readDeviceCharacteristics(server);
                    this.log('è¯»å–è®¾å¤‡ç‰¹å¾å®Œæˆ');

                    if (this.subscribedNotifyUUIDs.size === 0 && this.notifyStatus) {
                        this.notifyStatus.style.display = 'block';
                        this.notifyStatus.className = 'status info';
                        this.notifyStatus.textContent = 'æœªè®¢é˜…åˆ°é€šçŸ¥ç‰¹å¾ã€‚è‹¥è®¾å¤‡ä½¿ç”¨è‡ªå®šä¹‰æœåŠ¡ï¼Œè¯·åœ¨æ‰«æå‰æ·»åŠ å¯¹åº”æœåŠ¡UUIDï¼ˆå¦‚ ffe0/fff0 æˆ– 128-bitï¼‰ã€‚';
                    }
                    
                } catch (error) {
                    console.error('è¿æ¥è®¾å¤‡å¤±è´¥:', error);
                    
                    // åŒºåˆ†ä¸åŒç±»å‹çš„è¿æ¥é”™è¯¯
                    let errorMessage = '';
                    
                    if (error.name === 'NetworkError') {
                        // ç½‘ç»œè¿æ¥é—®é¢˜
                        errorMessage = 'è®¾å¤‡è¿æ¥è¶…æ—¶ï¼Œè¯·ç¡®ä¿è®¾å¤‡åœ¨èŒƒå›´å†…ä¸”å¯è¿æ¥';
                    } else if (error.name === 'NotSupportedError') {
                        // è®¾å¤‡ä¸æ”¯æŒGATT
                        errorMessage = 'è®¾å¤‡ä¸æ”¯æŒGATTè¿æ¥';
                    } else if (error.name === 'SecurityError') {
                        // å®‰å…¨æƒé™é—®é¢˜
                        errorMessage = 'è¿æ¥è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥è®¾å¤‡æƒé™è®¾ç½®';
                    } else if (error.name === 'InvalidStateError') {
                        // è®¾å¤‡çŠ¶æ€å¼‚å¸¸
                        errorMessage = 'è®¾å¤‡çŠ¶æ€å¼‚å¸¸ï¼Œè¯·é‡æ–°æ‰«æè®¾å¤‡';
                    } else if (error.message && error.message.includes('GATT Server is disconnected')) {
                        // GATTæœåŠ¡å™¨æ–­å¼€
                        errorMessage = 'è®¾å¤‡è¿æ¥å·²æ–­å¼€ï¼Œè¯·é‡æ–°è¿æ¥';
                    } else {
                        // å…¶ä»–æœªçŸ¥é”™è¯¯
                        errorMessage = `è¿æ¥å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯ï¼Œè¯·é‡è¯•'}`;
                    }
                    
                    this.showStatus('error', errorMessage);
                    this.log(errorMessage);
                    
                    // æ¸…ç†è¿æ¥çŠ¶æ€
                    this.connectedDevice = null;
                    this.connectedServer = null;
                }
            }

            async readDeviceCharacteristics(server) {
                try {
                    this.characteristicsContainer.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">æ­£åœ¨è¯»å–è®¾å¤‡ç‰¹å¾...</p>';
                    this.log('å¼€å§‹è¯»å–è®¾å¤‡ç‰¹å¾');
                    
                    const services = await server.getPrimaryServices();
                    this.log(`è¯»å–åˆ°æœåŠ¡æ•°é‡ï¼š${services.length}`);
                    const targetCharacteristics = [];
                    
                    // ç›®æ ‡UUIDèŒƒå›´ (0x2A24-0x2A29)
                    const targetUUIDs = [
                        '00002a24-0000-1000-8000-00805f9b34fb', // Model Number String
                        '00002a25-0000-1000-8000-00805f9b34fb', // Serial Number String
                        '00002a26-0000-1000-8000-00805f9b34fb', // Firmware Revision String
                        '00002a27-0000-1000-8000-00805f9b34fb', // Hardware Revision String
                        '00002a28-0000-1000-8000-00805f9b34fb', // Software Revision String
                        '00002a29-0000-1000-8000-00805f9b34fb'  // Manufacturer Name String
                    ];

                    for (const service of services) {
                        try {
                            this.log(`æœåŠ¡: ${service.uuid}`);
                            const characteristics = await service.getCharacteristics();
                            // è®°å½•æœåŠ¡çš„ç‰¹å¾æ•°é‡
                            this.log(`æœåŠ¡ç‰¹å¾æ•°é‡ï¼š${characteristics.length}`);
                            for (const characteristic of characteristics) {
                                const uuid = characteristic.uuid.toLowerCase();
                                const propsStr = this.formatProperties(characteristic.properties);
                                this.log(`  ç‰¹å¾: ${uuid} [${propsStr}]`);

                                // è®¢é˜…é€šçŸ¥å‹ç‰¹å¾
                                if ((characteristic.properties.notify || characteristic.properties.indicate) && !this.subscribedNotifyUUIDs.has(uuid)) {
                                    try {
                                        await characteristic.startNotifications();
                                        characteristic.addEventListener('characteristicvaluechanged', (event) => {
                                            const dv = event.target.value;
                                            const bytes = new Uint8Array(dv.buffer);
                                            const ascii = new TextDecoder('utf-8').decode(bytes).replace(/\0+$/g, '');
                                            const hex = this.formatHex(bytes);
                                            this.notify(`${uuid} -> ASCII: ${ascii}`);
                                            this.notify(`${uuid} -> HEX: ${hex}`);
                                        });
                                        this.subscribedNotifyUUIDs.add(uuid);
                                        this.updateNotifyList(uuid, propsStr);
                                        if (this.notifyStatus) {
                                            this.notifyStatus.style.display = 'block';
                                            this.notifyStatus.className = 'status connected';
                                            this.notifyStatus.textContent = 'å·²è®¢é˜…é€šçŸ¥ç‰¹å¾ï¼Œç­‰å¾…æ¶ˆæ¯...';
                                        }
                                        this.log(`å·²è®¢é˜…é€šçŸ¥ç‰¹å¾: ${uuid}`);
                                    } catch (e) {
                                        this.log(`è®¢é˜…é€šçŸ¥å¤±è´¥: ${uuid} (${e.name || 'Error'}: ${e.message || ''})`);
                                    }
                                }
                                
                                // æ£€æŸ¥æ˜¯å¦åœ¨ç›®æ ‡èŒƒå›´å†…
                                if (targetUUIDs.includes(uuid)) {
                                    let value = 'N/A';
                                    
                                    try {
                                        if (characteristic.properties.read) {
                                            const dataView = await characteristic.readValue();
                                            const bytes = new Uint8Array(dataView.buffer);
                                            value = new TextDecoder('utf-8').decode(bytes).replace(/\0+$/g, '');
                                            // æ‰“å°ç›®æ ‡ç‰¹å¾çš„å€¼
                                            this.log(`    å€¼(ASCII): ${value}`);
                                            this.log(`    å€¼(HEX): ${this.formatHex(bytes)}`);
                                            this.log(`è¯»å–ç‰¹å¾æˆåŠŸï¼š${this.getCharacteristicName(uuid)}`);
                                        }
                                    } catch (readError) {
                                        console.warn(`æ— æ³•è¯»å–ç‰¹å¾ ${uuid}:`, readError);
                                        this.log(`è¯»å–ç‰¹å¾å¤±è´¥ï¼š${uuid} (${readError.name || 'Error'}: ${readError.message || ''})`);
                                        value = 'è¯»å–å¤±è´¥';
                                    }
                                    
                                    targetCharacteristics.push({
                                        uuid: uuid,
                                        properties: characteristic.properties,
                                        value: value,
                                        name: this.getCharacteristicName(uuid)
                                    });
                                    this.log(`å‘ç°ç›®æ ‡ç‰¹å¾ï¼š${this.getCharacteristicName(uuid)}`);
                                } else {
                                    // éç›®æ ‡ç‰¹å¾ä¹Ÿå°è¯•æ‰“å°å…¶å€¼ï¼ˆè‹¥å¯è¯»ï¼‰
                                    try {
                                        if (characteristic.properties.read) {
                                            const dv = await characteristic.readValue();
                                            const bytes = new Uint8Array(dv.buffer);
                                            const ascii = new TextDecoder('utf-8').decode(bytes).replace(/\0+$/g, '');
                                            this.log(`    å€¼(ASCII): ${ascii}`);
                                            this.log(`    å€¼(HEX): ${this.formatHex(bytes)}`);
                                        }
                                    } catch (e) {
                                        this.log(`    è¯»å–å€¼å¤±è´¥ (${e.name || 'Error'}: ${e.message || ''})`);
                                    }
                                }
                            }

                        } catch (serviceError) {
                            console.warn('è¯»å–æœåŠ¡ç‰¹å¾å¤±è´¥:', serviceError);
                            this.log('è¯»å–æœåŠ¡ç‰¹å¾å¤±è´¥');
                        }
                    }
                    
                    this.displayCharacteristics(targetCharacteristics);
                    
                } catch (error) {
                    console.error('è¯»å–è®¾å¤‡ç‰¹å¾å¤±è´¥:', error);
                    this.log(`è¯»å–è®¾å¤‡ç‰¹å¾å¤±è´¥ï¼š${error.message}`);
                    this.characteristicsContainer.innerHTML = `<p style="text-align: center; color: #cc0000; padding: 20px;">è¯»å–ç‰¹å¾å¤±è´¥: ${error.message}</p>`;
                }
            }

            // åœ¨é€šçŸ¥å¡ç‰‡ä¸­è®°å½•å·²è®¢é˜…ç‰¹å¾
            updateNotifyList(uuid, propsStr) {
                if (!this.notifyList) return;
                const item = document.createElement('div');
                item.className = 'characteristic-item';
                const properties = propsStr
                    .split(',')
                    .filter(Boolean)
                    .map(p => `<span class="property-tag">${p}</span>`) 
                    .join('');
                item.innerHTML = `
                    <div class="characteristic-uuid">${uuid}</div>
                    <div class="characteristic-properties">${properties}</div>
                    <div class="characteristic-value" style="font-size:0.9rem;color:#6c757d">å·²å¼€å§‹æ¥æ”¶é€šçŸ¥...</div>
                `;
                this.notifyList.appendChild(item);
            }

            getCharacteristicName(uuid) {
                const names = {
                    '00002a24-0000-1000-8000-00805f9b34fb': 'Model Number String',
                    '00002a25-0000-1000-8000-00805f9b34fb': 'Serial Number String',
                    '00002a26-0000-1000-8000-00805f9b34fb': 'Firmware Revision String',
                    '00002a27-0000-1000-8000-00805f9b34fb': 'Hardware Revision String',
                    '00002a28-0000-1000-8000-00805f9b34fb': 'Software Revision String',
                    '00002a29-0000-1000-8000-00805f9b34fb': 'Manufacturer Name String'
                };
                return names[uuid] || 'Unknown Characteristic';
            }

            displayCharacteristics(characteristics) {
                if (characteristics.length === 0) {
                    this.characteristicsContainer.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">æœªå‘ç°0x2A24-0x2A29èŒƒå›´å†…çš„ç‰¹å¾</p>';
                    return;
                }

                const grid = document.createElement('div');
                grid.className = 'characteristics-grid';

                characteristics.forEach(char => {
                    const charElement = document.createElement('div');
                    charElement.className = 'characteristic-item';
                    
                    const properties = Object.keys(char.properties)
                        .filter(prop => char.properties[prop])
                        .map(prop => `<span class="property-tag">${prop}</span>`)
                        .join('');

                    charElement.innerHTML = `
                        <div class="characteristic-uuid">${char.name}</div>
                        <div class="characteristic-uuid" style="font-size: 0.8rem; color: #6c757d;">${char.uuid}</div>
                        <div class="characteristic-properties">${properties}</div>
                        <div class="characteristic-value">${char.value}</div>
                    `;

                    grid.appendChild(charElement);
                });

                this.characteristicsContainer.innerHTML = '';
                this.characteristicsContainer.appendChild(grid);
            }

            showStatus(type, message) {
                this.scanStatus.style.display = 'block';
                this.scanStatus.className = `status ${type}`;
                this.scanStatus.textContent = message;
                
                if (type !== 'scanning') {
                    setTimeout(() => {
                        this.scanStatus.style.display = 'none';
                    }, 5000);
                }
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            new BluetoothDeviceManager();
        });
    </script>
</body>
</html>