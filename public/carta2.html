<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>è“ç‰™è®¾å¤‡çŠ¶æ€é¢æ¿</title>
  <style>
    body { font-family: sans-serif; background: #f8fbff; padding: 2em; }
    h2 { margin-bottom: 1em; }
    .panel { background: #fff; padding: 1em; border-radius: 10px; box-shadow: 0 0 6px #ccc; max-width: 500px; }
    .row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed #ddd; }
    .row:last-child { border: none; }
    label { font-weight: bold; }
    .val { font-family: monospace; }
    button, input { margin: 0.5em 0; padding: 0.6em; font-size: 1em; }
    .form { margin-top: 1em; }
  </style>
</head>
<body>

<h2>ğŸ“¡ è“ç‰™çŠ¶æ€é¢æ¿</h2>
<button id="connectBtn">ğŸ”— è¿æ¥è“ç‰™è®¾å¤‡</button>

<div class="form">
  <label for="ssid">SSID:</label>
  <input type="text" id="ssid" placeholder="è¯·è¾“å…¥WiFi SSID">
  <label for="password">Password:</label>
  <input type="text" id="password" placeholder="è¯·è¾“å…¥WiFiå¯†ç ">
  <button id="startWifiBtn">ğŸš€ Start WiFi</button>
</div>

<div class="panel" id="statusPanel">
  <div class="row"><label>é›¾åŒ–å™¨ç±»å‹:</label><span class="val" id="atomizer">--</span></div>
  <div class="row"><label>Dry Herb Preset:</label><span class="val" id="dryPreset">--</span></div>
  <div class="row"><label>Gesso Preset:</label><span class="val" id="gessoPreset">--</span></div>
  <div class="row"><label>å€’è®¡æ—¶:</label><span class="val" id="countdown">--</span></div>
  <div class="row"><label>å½“å‰æ¸©åº¦:</label><span class="val" id="curTemp">--</span></div>
  <div class="row"><label>é¢„è®¾æ¸©åº¦:</label><span class="val" id="presetTemp">--</span></div>
  <div class="row"><label>ç”µæ± ç”µé‡:</label><span class="val" id="battery">--</span></div>
  <div class="row"><label>LED Preset:</label><span class="val" id="ledPreset">--</span></div>
  <div class="row"><label>Dry Herb Time:</label><span class="val" id="dryTime">--</span></div>
  <div class="row"><label>Gesso Time:</label><span class="val" id="gessoTime">--</span></div>
</div>

<script>
let characteristicToWrite = null; // ä¿å­˜å¯å†™ç‰¹å¾å€¼

function set(id, value) {
  document.getElementById(id).textContent = value;
}

document.getElementById('connectBtn').addEventListener('click', async () => {
  try {
    const device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: ['1011123e-8535-b5a0-7140-a304d2495cb7']
    });

    const server = await device.gatt.connect();
    const service = await server.getPrimaryService('1011123e-8535-b5a0-7140-a304d2495cb7');
    const characteristics = await service.getCharacteristics();

    for (const char of characteristics) {
      if (char.properties.notify) {
        await char.startNotifications();
        char.addEventListener('characteristicvaluechanged', event => {
          const d = new Uint8Array(event.target.value.buffer);
          if (d.length < 16) return;
          if (d[0] != 0x99)  return;
          const byte2 = d[2];
          const byte3 = d[3];
          const byte4 = d[4];
          const byte5 = d[5];
          const temp = (d[6] << 8) | d[7];
          const dryTemp = (d[8] << 8) | d[9];
          const gessoTemp = (d[10] << 8) | d[11];
          const battery = d[12];
          const ledPreset = d[13] >> 4;
          const dryTime = d[14];
          const gessoTime = d[15];
          
          let presetTemp = 0;
          if(byte2 == 0x40)  presetTemp = dryTemp;
          if(byte2 == 0x60)  presetTemp = gessoTemp;
          if(byte2 == 0xA0)  presetTemp = dryTemp;
          if(byte2 == 0x30)  presetTemp = gessoTemp;

          const atomizerMap = {
            0x40: 'Gesso', 0x60: 'Gesso', 0xA0: 'Dry Herb', 0x30: 'Gesso Max', 0x00: 'No Atomizer'
          };
          const unitMap = {
            0x11: 'â„‰', 0x22: 'â„ƒ'
          };

          set('atomizer', atomizerMap[byte2] || `0x${byte2.toString(16)}`);
          set('dryPreset', byte4 >> 4);
          set('gessoPreset', byte4 & 0x0F);
          set('countdown', `${byte5}s`);
          set('curTemp', temp + unitMap[byte3]);
          set('presetTemp', presetTemp + unitMap[byte3]);
          set('battery', `${battery}%`);
          set('ledPreset', ledPreset);
          set('dryTime', `${dryTime}s`);
          set('gessoTime', `${gessoTime}s`);
        });
      }

      if (char.properties.write) {
        characteristicToWrite = char;
      }
    }

    alert("è“ç‰™è®¾å¤‡è¿æ¥æˆåŠŸï¼");

  } catch (e) {
    alert('è¿æ¥å¤±è´¥: ' + e);
  }
});

document.getElementById('startWifiBtn').addEventListener('click', async () => {
  const ssid = document.getElementById('ssid').value.trim();
  const password = document.getElementById('password').value.trim();
  if (!ssid) {
    alert("è¯·è¾“å…¥ SSID");
    return;
  }

  if (!characteristicToWrite) {
    alert("æœªæ‰¾åˆ°å¯å†™ç‰¹å¾å€¼ï¼Œè¯·å…ˆè¿æ¥è®¾å¤‡");
    return;
  }

  const data = new TextEncoder().encode(`wifi_${ssid} ${password}`);
  try {
    await characteristicToWrite.writeValue(data);
    alert("WiFi é…ç½®å·²å‘é€");
  } catch (e) {
    alert("å‘é€å¤±è´¥: " + e);
  }
});
</script>

</body>
</html>
