<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Switch 2 Tool</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5.5.2/dist/iro.min.js"></script>
    <style>
        :root {
            --primary-color: #667eea;
            --primary-dark: #5a67d8;
            --secondary-color: #764ba2;
            --success-color: #48bb78;
            --warning-color: #ed8936;
            --danger-color: #f56565;
            --info-color: #4299e1;
            --light-bg: #f7fafc;
            --white: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --border-radius-lg: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            color: var(--gray-800);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow-xl);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 400;
        }

        .grid {
            display: grid;
            gap: 24px;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            margin-bottom: 24px;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        @media (max-width: 1200px) {
            .grid-3 {
                grid-template-columns: 1fr;
            }
        }

        @media (min-width: 768px) and (max-width: 1200px) {
            .grid-3 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ‰∏âÂàóÂ∏ÉÂ±ÄÊó∂ÁöÑÂç°ÁâáÂÜÖÂÆπ‰ºòÂåñ */
        .grid-3 .card {
            min-height: 300px;
        }

        .grid-3 .card .table {
            font-size: 0.85rem;
        }

        .grid-3 .card .table td {
            padding: 8px 4px;
        }

        .grid-3 .card .card-header h3 {
            font-size: 1.1rem;
        }

        .grid-3 .card .controls {
            gap: 8px;
        }

        .grid-3 .card .btn {
            padding: 8px 16px;
            font-size: 0.8rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: var(--transition);
            position: relative;
            overflow: visible;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--gray-200);
        }

        .card-header i {
            font-size: 1.5rem;
            margin-right: 12px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .card-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            min-width: 120px;
            gap: 8px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s ease, height 0.3s ease;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #38a169);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #e53e3e);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--gray-500), var(--gray-600));
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn:disabled {
            background: var(--gray-300);
            color: var(--gray-500);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn:disabled::before {
            display: none;
        }

        .status {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            gap: 8px;
        }

        .status-connected {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: var(--success-color);
            border: 1px solid #c3e6cb;
        }

        .status-disconnected {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: var(--danger-color);
            border: 1px solid #f5c6cb;
        }

        .status i {
            font-size: 0.875rem;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
        }

        .form-control {
            padding: 12px 16px;
            border: 2px solid var(--gray-200);
            border-radius: var(--border-radius-sm);
            font-size: 0.875rem;
            transition: var(--transition);
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-control:disabled {
            background: var(--gray-100);
            color: var(--gray-500);
            cursor: not-allowed;
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress {
            width: 100%;
            height: 12px;
            background: var(--gray-200);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            width: 0%;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .log {
            background: var(--gray-900);
            color: var(--gray-100);
            border-radius: var(--border-radius-sm);
            padding: 20px;
            height: 300px;
            overflow-y: auto;
            font-family: 'SF Mono', Monaco, 'Consolas', monospace;
            font-size: 0.8rem;
            line-height: 1.5;
            border: 1px solid var(--gray-700);
            position: relative;
        }

        .log::-webkit-scrollbar {
            width: 8px;
        }

        .log::-webkit-scrollbar-track {
            background: var(--gray-800);
            border-radius: 4px;
        }

        .log::-webkit-scrollbar-thumb {
            background: var(--gray-600);
            border-radius: 4px;
        }

        .log::-webkit-scrollbar-thumb:hover {
            background: var(--gray-500);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .status-group {
            background: var(--gray-50);
            padding: 20px;
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--gray-200);
        }

        .status-group h4 {
            margin: 0 0 16px 0;
            color: var(--gray-700);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 12px 0;
            font-size: 0.875rem;
        }

        .status-item strong {
            color: var(--gray-600);
            font-weight: 500;
        }

        .status-item span {
            color: var(--primary-color);
            font-weight: 600;
        }

        .file-upload {
            border: 2px dashed var(--gray-300);
            border-radius: var(--border-radius);
            padding: 40px 20px;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .file-upload:hover {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.05);
        }

        .file-upload.dragover {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.1);
        }

        .file-upload i {
            font-size: 3rem;
            color: var(--gray-400);
            margin-bottom: 16px;
        }

        .file-upload:hover i {
            color: var(--primary-color);
        }

        .file-info {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding: 16px;
            border-radius: var(--border-radius-sm);
            margin: 16px 0;
            border-left: 4px solid var(--info-color);
        }

        .temp-preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .preset-card {
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: var(--border-radius-sm);
            padding: 16px 12px;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
        }

        .preset-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .preset-card:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
            transition: all 0.1s ease;
        }

        .preset-card.heating-disabled {
            opacity: 0.6;
            pointer-events: none;
            background: var(--gray-50);
        }

        .preset-title {
            
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-600);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .temp-input {
            width: 100%;
            border: none;
            background: transparent;
            text-align: center;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-800);
            margin: 8px 0;
        }

        .temp-input:focus {
            outline: none;
        }

        .temp-unit {
            font-size: 0.75rem;
            color: var(--gray-500);
            font-weight: 500;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-300);
            transition: var(--transition);
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: var(--transition);
            border-radius: 50%;
            box-shadow: var(--shadow-sm);
        }

        input:checked + .slider {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px 20px;
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow-lg);
            border-left: 4px solid var(--success-color);
            transform: translateX(100%);
            transition: var(--transition);
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .spinning {
            animation: spin 1s linear infinite;
        }


        @media (max-width: 768px) {
            .container {
                padding: 0 16px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .card {
                padding: 20px 16px;
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .temp-preset-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            

        }

        /* Âä†ÁÉ≠Áä∂ÊÄÅÁöÑÁâπÊÆäÊ†∑Âºè */
        .heating-active .preset-card {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border-color: var(--warning-color);
        }

        .heating-active .preset-card::after {
            content: "üî•";
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 0.875rem;
        }

        /* LEDÈÄâÊã©Âô®ÁöÑÁâπÊÆäÊ†∑Âºè */
        .led-selector {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 12px;
            align-items: center;
        }

        .led-preview {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }

        /* Êõ¥Â•ΩÁöÑÂìçÂ∫îÂºèË°®Ê†º */
        .responsive-table {
            overflow-x: auto;
            margin: 16px 0;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .table th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
        }

        /* Ê∑ªÂä†Êõ¥Â§öÂä®ÁîªÊïàÊûú */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-300);
            transition: var(--transition);
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: var(--transition);
            border-radius: 50%;
            box-shadow: var(--shadow-sm);
        }

        input:checked + .slider {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px 20px;
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow-lg);
            border-left: 4px solid var(--success-color);
            transform: translateX(100%);
            transition: var(--transition);
            z-index: 1000;
            min-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            border-left-color: var(--danger-color);
        }

        .notification.warning {
            border-left-color: var(--warning-color);
        }

        .notification.info {
            border-left-color: var(--info-color);
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .spinning {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .bounce {
            animation: bounce 0.6s ease-in-out;
        }

        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        /* Áä∂ÊÄÅÊåáÁ§∫Âô® */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.connected {
            background: var(--success-color);
            animation: pulse 2s infinite;
        }

        .status-indicator.disconnected {
            background: var(--danger-color);
        }

        .status-indicator.connecting {
            background: var(--warning-color);
            animation: spin 1s linear infinite;
        }

        /* ‰ºòÂåñÊñá‰ª∂ÊãñÊãΩÊ†∑Âºè */
        .file-upload.dragover {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.02);
        }

        /* ‰ºòÂåñËøõÂ∫¶Êù° */
        .progress-bar.pulse {
            animation: progressPulse 1.5s infinite;
        }

        @keyframes progressPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* Ê∏©Â∫¶Âç°ÁâáÊÇ¨ÂÅúÊïàÊûú */
        .preset-card:hover .temp-input {
            color: var(--primary-color);
        }

        /* LEDÈ¢ÑËßàÊ†∑Âºè */
        .led-preview.clam { background: #f5f5f5; border-color: #ccc; }
        .led-preview.stealth { background: #2d3748; }
        .led-preview.purple { background: #805ad5; }
        .led-preview.blue { background: #3182ce; }
        .led-preview.cyan { background: #00b5d8; }
        .led-preview.green { background: #38a169; }
        .led-preview.yellow { background: #d69e2e; }
        .led-preview.orange { background: #dd6b20; }
        .led-preview.red { background: #e53e3e; }
        .led-preview.pink { background: #d53f8c; }
        .led-preview.cali-sunset { background: linear-gradient(45deg, #ff6b6b, #ffa500); }
        .led-preview.purple-haze { background: linear-gradient(45deg, #9f7aea, #b794f6); }
        .led-preview.northern-nights { background: linear-gradient(45deg, #2d3748, #4a5568); }
        .led-preview.vegas-nights { background: linear-gradient(45deg, #ed8936, #f6ad55); }
        .led-preview.blue-dream { background: linear-gradient(45deg, #3182ce, #63b3ed); }
        .led-preview.strawberry-cough { background: linear-gradient(45deg, #e53e3e, #fc8181); }
        .led-preview.florida-groves { background: linear-gradient(45deg, #38a169, #68d391); }
        .led-preview.lime-light { background: linear-gradient(45deg, #68d391, #9ae6b4); }

        /* ÂìçÂ∫îÂºè‰ºòÂåñ */
        @media (max-width: 1024px) {
            .status-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .temp-preset-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Â∑•ÂÖ∑ÊèêÁ§∫ */
        .tooltip {
            position: relative;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 8px;
        }

        .tooltip:hover::after {
            opacity: 1;
        }

        /* Âä†ËΩΩÁä∂ÊÄÅ */
        .loading {
            position: relative;
            pointer-events: none;
        }

        .loading::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid transparent;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 1;
        }

        .loading * {
            opacity: 0.5;
        }

        /* PresetÊéß‰ª∂Ê†∑Âºè */
        .preset-controls {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--gray-200);
        }

        .preset-control-item {
            margin-bottom: 8px;
        }

        .preset-control-label {
            display: block;
        }

        /* PresetÂç°ÁâáÈÄâ‰∏≠Áä∂ÊÄÅÊ†∑Âºè */
        .preset-card.selected {
            background-color: #dcfce7; /* ÊµÖÁªøËâ≤ËÉåÊôØ */
            border-color: #22c55e; /* ÁªøËâ≤ËæπÊ°Ü */
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2); /* ÁªøËâ≤Èò¥ÂΩ± */
            transform: translateY(-2px); /* ËΩªÂæÆ‰∏äÁßªÊïàÊûú */
            transition: all 0.3s ease;
        }

        .preset-card.selected .preset-title {
            color: #15803d; /* Ê∑±ÁªøËâ≤Ê†áÈ¢ò */
            font-weight: 600;
        }

        .preset-card.selected .temp-input {
            border-color: #22c55e;
            background-color: #f0fdf4;
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--gray-600);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .preset-control-input {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .preset-slider {
            flex: 1;
            height: 4px;
            background: var(--gray-200);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .preset-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .preset-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .preset-slider:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .preset-value {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--primary-color);
            min-width: 28px;
            text-align: right;
        }

        .preset-mode-select {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            font-size: 0.7rem;
            background: white;
            color: var(--gray-700);
            cursor: pointer;
            transition: var(--transition);
        }

        .preset-mode-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .preset-mode-select:disabled {
            background: var(--gray-100);
            color: var(--gray-500);
            cursor: not-allowed;
        }

        /* Âä†ÁÉ≠Áä∂ÊÄÅ‰∏ãÁöÑÁ¶ÅÁî®Ê†∑Âºè */
        .preset-slider.heating-disabled,
        .preset-mode-select.heating-disabled {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="grid grid-3">
            <!-- ËìùÁâôËøûÊé•Âç°Áâá -->
            <div class="card fade-in">
                <div class="card-header">
                    <i class="fa-solid fa-signal"></i>
                    <h3>Bluetooth Connection</h3>
                </div>
                <div id="connectionStatus" class="status status-disconnected">
                    <span class="status-indicator disconnected" id="statusIndicator"></span>
                    <i class="fas fa-unlink" id="statusIcon"></i>
                    <span id="statusText">Device Not Connected</span>
                </div>
                <div class="controls">
                    <!-- <button id="connectBtn" class="btn btn-primary tooltip" onclick="connectDevice()" data-tooltip="Connect to PY32F071 Bluetooth device">
                        <i class="fas fa-link"></i>
                        Connect Device
                    </button> -->

                    <span class="tooltip" data-tooltip="Connect to switch2 Bluetooth device">
                    <button id="connectBtn" class="btn btn-primary" onclick="connectDevice()">
                        <i class="fas fa-link"></i> Connect Device
                    </button>
                    </span>

                    <span class="tooltip" data-tooltip="Disconnect from switch2 Bluetooth device">
                        <button id="disconnectBtn" class="btn btn-danger" onclick="disconnectDevice()">
                            <i class="fas fa-unlink"></i>
                            Disconnect
                        </button>
                    </span>

                    <!-- Âõ∫‰ª∂ÁâàÊú¨ÈÄâÊã©Âô® -->
                    <div class="input-group" style="min-width: 180px;">
                        <label for="firmwareSelect">Firmware Version</label>
                        <select id="firmwareSelect" class="form-control">
                            <option value="firmware1.0">firmware V1.0</option>
                            <option value="firmware2.0">firmware V2.0</option>
                        </select>
                    </div>

                </div>
            </div>

            <!-- ËÆæÂ§á‰ø°ÊÅØÂç°Áâá -->
            <div class="card fade-in" id="deviceInfoCard" style="display: none;">
                <div class="card-header">
                    <i class="fas fa-info-circle"></i>
                    <h3>Device Information</h3>
                </div>
                <div class="responsive-table">
                    <table class="table">
                        <tr>
                            <td><strong>Model Number:</strong></td>
                            <td><span id="modelNumber">--</span></td>
                        </tr>
                        <tr>
                            <td><strong>Serial Number:</strong></td>
                            <td><span id="serialNumber">--</span></td>
                        </tr>
                        <tr>
                            <td><strong>Hardware Version:</strong></td>
                            <td><span id="hardwareVersion">--</span></td>
                        </tr>
                        <tr>
                            <td><strong>Software Revision:</strong></td>
                            <td><span id="softwareRevision">--</span></td>
                        </tr>
                        <tr>
                            <td><strong>Manufacturer:</strong></td>
                            <td><span id="manufacturerName">--</span></td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- ‰ΩøÁî®ÁªüËÆ°‰ø°ÊÅØÂç°Áâá -->
            <div class="card fade-in" id="deviceStatsCard" style="display: none;">
                <div class="card-header">
                    <i class="fas fa-chart-bar"></i>
                    <h3>Device Usage Statistics</h3>
                </div>
                <div class="responsive-table">
                    <table class="table">
                        <tr>
                            <td><strong>Favorite Temperature:</strong></td>
                            <td><span id="favoriteTemp">--</span></td>
                        </tr>
                        <tr>
                            <td><strong>Total Heating Cycles:</strong></td>
                            <td><span id="totalHeatingCycles">--</span></td>
                        </tr>
                        <tr>
                            <td><strong>Most Cycles in Day:</strong></td>
                            <td><span id="mostCyclesInDay">--</span></td>
                        </tr>
                        <tr>
                            <td><strong>Charge Cycles:</strong></td>
                            <td><span id="chargeCycles">--</span></td>
                        </tr>
                        <tr>
                            <td><strong>Profile:</strong></td>
                            <td><span id="profile">--</span></td>
                        </tr>
                        <tr>
                            <td><strong>Light Mode:</strong></td>
                            <td><span id="lightMode">--</span></td>
                        </tr>
                        <tr>
                            <td><strong>Device Resets:</strong></td>
                            <td><span id="deviceResets">--</span></td>
                        </tr>
                        <tr>
                            <td><strong>Favorite Heating Time:</strong></td>
                            <td><span id="favoriteHeatingTime">--</span></td>
                        </tr>
                        <tr>
                            <td><strong>Session Total Time:</strong></td>
                            <td><span id="sessionTotalTime">--</span></td>
                        </tr>
                        <tr>
                            <td><strong>DeviceOn Time:</strong></td>
                            <td><span id="DeviceOnTime">--</span></td>
                        </tr>
                        <tr>
                            <td><strong>Preset 1 Cycles:</strong></td>
                            <td><span id="presetCycles1">--</span></td>
                        </tr>
                        <tr>
                            <td><strong>Preset 2 Cycles:</strong></td>
                            <td><span id="presetCycles2">--</span></td>
                        </tr>
                        <tr>
                            <td><strong>Preset 3 Cycles:</strong></td>
                            <td><span id="presetCycles3">--</span></td>
                        </tr>
                        <tr>
                            <td><strong>Preset 4 Cycles:</strong></td>
                            <td><span id="presetCycles4">--</span></td>
                        </tr>
                        <tr>
                            <td><strong>Preset 5 Cycles:</strong></td>
                            <td><span id="presetCycles5">--</span></td>
                        </tr>

                    </table>
                </div>
                <div style="margin-top: 16px;">
                    <button class="btn btn-primary" onclick="requestDeviceStats()" id="refreshStatsBtn" disabled>
                        <i class="fas fa-sync-alt"></i>
                        Refresh Statistics
                    </button>
                </div>
            </div>

        </div>

        <!-- ËÆæÂ§áÁä∂ÊÄÅÁõëÊéß -->
        <div class="card fade-in">
            <div class="card-header">
                <i class="fas fa-chart-line"></i>
                <h3>Device Status Monitor</h3>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label class="toggle-switch">
                    <input type="checkbox" id="notifyToggle" onchange="toggleNotifications()">
                    <span class="slider"></span>
                </label>
                <span style="margin-left: 12px; font-weight: 500;">
                    Real-time Monitoring
                    <span id="notifyStatus" style="margin-left: 8px; font-size: 0.875rem; color: var(--gray-500);">Disabled</span>
                </span>
            </div>
            
            <div id="deviceStatusInfo" style="display: none;">
                <div class="status-grid">
                    <div class="status-group">
                        <h4><i class="fas fa-thermometer-half"></i> Temperature</h4>
                        <div class="status-item">
                            <strong>Preset:</strong> 
                            <button id="presetBtn" class="btn btn-primary" onclick="switchPreset()" disabled style="min-width: 60px; padding: 6px 12px;">--</button>
                        </div>
                        <div class="status-item">
                            <strong>Target:</strong>
                            <span id="tempSetting">--</span>
                        </div>
                        <div class="status-item">
                            <strong>Current:</strong> 
                            <span id="realTemp">--</span>
                        </div>
                        <div class="status-item">
                            <strong>Preset Mode:</strong>
                            <span id="currentPresetMode" style="color: var(--primary-color); font-weight: 600;">Steady</span>
                        </div>
                    </div>
                    
                    <div class="status-group">
                        <h4><i class="fas fa-battery-half"></i> Power</h4>
                        <div class="status-item">
                            <strong>Battery:</strong>
                            <span id="batteryLevel">--</span>
                        </div>
                        <div class="status-item">
                            <strong>Charge State:</strong> 
                            <span id="chargeState">--</span>
                        </div>
                        <div class="status-item">
                            <strong>Brightness:</strong>
                            <input type="range" id="brightness" min="0" max="100" value="25" 
                                   style="width: 80px;" 
                                   oninput="updateBrightnessDisplay(this.value)" 
                                   onchange="setBrightness(this.value); endSliderDrag('brightness')"
                                   onmousedown="startSliderDrag('brightness')"
                                   ontouchstart="startSliderDrag('brightness')" 
                                   disabled>
                            <span id="brightnessDisplay" style="font-size: 0.8rem; margin-left: 8px;">25</span>
                        </div>
                    </div>
                    
                    <div class="status-group">
                        <h4><i class="fas fa-fire"></i> Session</h4>
                        <div style="margin-bottom: 16px; text-align: center;">
                            <button id="sessionControlBtn" class="btn btn-success" onclick="toggleSession()" disabled style="min-width: 150px;">
                                <i class="fas fa-play"></i>
                                Press to Heat
                            </button>
                        </div>
                        <div style="margin-bottom: 16px; text-align: center;">
                            <button id="cleaningAssistBtn" class="btn btn-secondary" onclick="toggleCleaningAssist()" disabled style="min-width: 150px;">
                                <i class="fas fa-broom"></i>
                                Cleaning Assist
                            </button>
                        </div>
                        <div class="status-item">
                            <strong>Auto Shut:</strong>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="range" id="autoShutTime" min="0" max="30" value="2" 
                                       style="width: 80px;" 
                                       oninput="updateAutoShutDisplay(this.value)" 
                                       onchange="setAutoShutTime(this.value); endSliderDrag('autoShutTime')"
                                       onmousedown="startSliderDrag('autoShutTime')"
                                       ontouchstart="startSliderDrag('autoShutTime')" 
                                       disabled>
                                <span id="autoShutDisplay" style="font-size: 0.8rem; margin-left: 8px;">2 min</span>
                            </div>
                        </div>

                        <div class="status-item">
                            <strong>Countdown:</strong> 
                            <span id="remainTime">--</span>s
                        </div>
                        <div class="status-item">
                            <strong>Session Time:</strong> 
                            <span id="sessionRemainTime">--</span>s
                        </div>
                    </div>
                    
                    <div class="status-group">
                        <h4><i class="fas fa-cog"></i> Settings</h4>
                        <div class="status-item">
                            <strong>LED Mode:</strong>
                            <div class="led-selector">
                                <select id="ledPresetSelect" class="form-control" onchange="setLedPreset(this.value)" style="font-size: 0.8rem;">
                                    <option value="0x00">Clam</option>
                                    <option value="0x01">Stealth</option>
                                    <option value="0x02">Purple</option>
                                    <option value="0x03">Blue</option>
                                    <option value="0x04">Cyan</option>
                                    <option value="0x05">Green</option>
                                    <option value="0x06">Yellow</option>
                                    <option value="0x07">Orange</option>
                                    <option value="0x08">Red</option>
                                    <option value="0x09">Pink</option>
                                    <option value="0x0A">Cali Sunset</option>
                                    <option value="0x0B">Purple Haze</option>
                                    <option value="0x0C">Northern Nights</option>
                                    <option value="0x0D">Vegas Nights</option>
                                    <option value="0x0E">Blue Dream</option>
                                    <option value="0x0F">Strawberry Cough</option>
                                    <option value="0x10">Florida Groves</option>
                                    <option value="0x11">Lime Light</option>
                                    <!-- <option value="0x14">Candy corn</option>
                                    <option value="0x15">Redrum</option>
                                    <option value="0x16">Skull&Bones</option>
                                    <option value="0x17">Witches Brew</option> -->

                                    <!-- <option value="0x18">Candy cane</option>
                                    <option value="0x19">Deck the Halls</option>
                                    <option value="0x25">poinsettia</option>
                                    <option value="0x26">Icicle</option>
                                    <option value="0x27">Sleigh Bells</option>
                                    <option value="0x28">Wintergreen</option> -->
                                </select>
                                <div class="led-preview" id="ledPreview"></div>
                            </div>
                        </div>
                        <div class="status-item">
                            <strong>Current:</strong> 
                            <span id="ledPreset">--</span>
                        </div>
                        <div class="status-item">
                            <strong>Haptic:</strong> 
                            <button id="hapticBtn" class="btn btn-success" onclick="toggleHaptic()" disabled style="min-width: 80px; padding: 6px 12px; font-size: 0.8rem;">
                                On
                            </button>
                        </div>
                        <div class="status-item">
                            <strong>Boost:</strong> 
                            <button id="boostBtn" class="btn btn-secondary tooltip" onclick="toggleBoost()" disabled 
                                    style="min-width: 80px; padding: 6px 12px; font-size: 0.8rem;"
                                    data-tooltip="Click to send incremental boost value (+1 each click)">
                                Boost
                            </button>
                        </div>
                        <div class="status-item">
                            <strong>Firmware:</strong> 
                            <button id="updateFirmwareBtn" class="btn btn-warning tooltip" onclick="startFirmwareUpdate()" disabled 
                                    style="min-width: 150px; padding: 6px 12px; font-size: 0.8rem;"
                                    data-tooltip="Update device firmware using simple_ota.bin">
                                <i class="fas fa-download"></i>
                                Update Firmware
                            </button>
                        </div>
                        <div class="status-item" id="firmwareStatusContainer" style="display: none;">
                            <strong>Status:</strong>
                            <span id="firmwareStatusText" style="font-size: 0.8rem; font-weight: 600;"></span>
                        </div>
                        <div class="status-item" id="otaProgressContainer" style="display: none;">
                            <strong>OTA Progress:</strong>
                            <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
                                <div class="progress" style="flex: 1; height: 8px;">
                                    <div class="progress-bar" id="otaProgressBar" style="width: 0%;"></div>
                                </div>
                                <span id="otaProgressText" style="font-size: 0.8rem; color: var(--primary-color);">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mode Control -->
                    <div class="status-group" style="margin-bottom: 20px; display: none;">
                        <h4><i class="fas fa-arrows-alt-v"></i> Mode Control</h4>
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                            <div>
                                <strong>Current Mode:</strong>
                                <span id="currentModeDisplay" style="margin-left: 8px;">Steady</span>
                            </div>
                            <button id="modeControlBtn" class="btn btn-primary" onclick="switchMode()" disabled style="min-width: 120px;">
                                <i class="fas fa-sync-alt"></i>
                                Switch Mode
                            </button>
                        </div>
                        <div style="margin-top: 8px; text-align: center; font-size: 0.8rem; color: var(--gray-500);">
                            <span id="modeSequence">Steady ‚Üí Ascent ‚Üí Descent ‚Üí Valley ‚Üí Hill</span>
                        </div>
                        <div class="status-item" style="margin-top: 12px;">
                            <strong>Hold Time:</strong>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="range" id="holdTime" min="10" max="90" value="30" 
                                       style="width: 80px;" 
                                       oninput="updateHoldTimeDisplay(this.value)" 
                                       onchange="setHoldTime(this.value); endSliderDrag('holdTime')"
                                       onmousedown="startSliderDrag('holdTime')"
                                       ontouchstart="startSliderDrag('holdTime')" 
                                       disabled>
                                <span id="holdTimeDisplay" style="font-size: 0.8rem; margin-left: 8px;">30 sec</span>
                            </div>
                        </div>
                    </div>

                     <!-- LED Color Points ËÆæÁΩÆÂç°Áâá -->
                    <div class="grid">
                        <div class="card fade-in">
                        <div class="card-header">
                            <i class="fas fa-palette"></i>
                            <h3>LED Color Points</h3>
                        </div>
                        <div style="display: flex; gap: 32px; justify-content: center; align-items: center; margin: 24px 0;">
                            <div>
                            <label>Color Point 1</label><br>
                            <button id="colorPointBtn1" style="width: 48px; height: 48px; border-radius: 50%; border: 2px solid #ccc; background: #ff0000; cursor: pointer;" onclick="openColorPicker(1)"></button>
                            </div>
                            <div>
                            <label>Color Point 2</label><br>
                            <button id="colorPointBtn2" style="width: 48px; height: 48px; border-radius: 50%; border: 2px solid #ccc; background: #00ff00; cursor: pointer;" onclick="openColorPicker(2)"></button>
                            </div>
                            <div>
                            <label>Color Point 3</label><br>
                            <button id="colorPointBtn3" style="width: 48px; height: 48px; border-radius: 50%; border: 2px solid #ccc; background: #0000ff; cursor: pointer;" onclick="openColorPicker(3)"></button>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÂÆûÊó∂Ê∏©Â∫¶ÂõæË°® - Áã¨Á´ãÁöÑÂÖ®ÂÆΩÂå∫Âüü -->
        <div class="grid">
            <div class="card fade-in">
                <div class="card-header">
                    <i class="fas fa-chart-line"></i>
                    <h3>Real-time Temperature Chart</h3>
                    <button id="clearChartBtn" class="btn btn-secondary" onclick="clearTemperatureChart()" 
                            style="margin-left: auto; padding: 6px 12px; font-size: 0.8rem;">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                </div>
                <div style="position: relative; height: 300px; width: 100%; padding: 16px;">
                    <canvas id="temperatureChart"></canvas>
                </div>
                <div style="text-align: center; font-size: 0.8rem; color: var(--gray-500); padding-bottom: 16px;">
                    <span id="chartInfo">Real-time temperature monitoring</span>
                </div>
            </div>
        </div>

        <!-- Ê∏©Â∫¶È¢ÑËÆæ -->
        <div class="grid">
            <div class="card fade-in">
                <div class="card-header">
                    <i class="fas fa-sliders-h"></i>
                    <h3>Temperature Presets (250-650¬∞F)</h3>
                </div>
                <div class="temp-preset-grid" id="tempPresets">
                    <div class="preset-card" onclick="selectPreset(1)">
                        <div class="preset-title">Preset 1</div>
                        <input type="number" id="tempF1" min="250" max="650" value="450" 
                               class="temp-input" onchange="setTemperature(1, this.value)">
                        <div class="temp-unit">¬∞F</div>
                        <div class="preset-controls">
                            <div class="preset-control-item">
                                <label class="preset-control-label">Hold Time:</label>
                                <div class="preset-control-input">
                                    <input type="range" id="presetHoldTime1" min="10" max="90" value="30" 
                                           class="preset-slider" 
                                           oninput="updatePresetHoldTimeDisplay(1, this.value)" 
                                           onchange="setPresetHoldTime(1, this.value); endSliderDrag('presetHoldTime1')"
                                           onmousedown="startSliderDrag('presetHoldTime1')"
                                           ontouchstart="startSliderDrag('presetHoldTime1')" 
                                           disabled>
                                    <span id="presetHoldTimeDisplay1" class="preset-value">30s</span>
                                </div>
                            </div>
                            <div class="preset-control-item">
                                <label class="preset-control-label">Mode:</label>
                                <select id="presetMode1" class="preset-mode-select" onchange="setPresetMode(1, this.value)" disabled>
                                    <option value="0xA1">Steady</option>
                                    <option value="0xB1">Ascent</option>
                                    <option value="0xC1">Descent</option>
                                    <option value="0xD1">Valley</option>
                                    <option value="0xE1">Hill</option>
                                    <option value="0xF1">Custom</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="preset-card" onclick="selectPreset(2)">
                        <div class="preset-title">Preset 2</div>
                        <input type="number" id="tempF2" min="250" max="650" value="500" 
                               class="temp-input" onchange="setTemperature(2, this.value)">
                        <div class="temp-unit">¬∞F</div>
                        <div class="preset-controls">
                            <div class="preset-control-item">
                                <label class="preset-control-label">Hold Time:</label>
                                <div class="preset-control-input">
                                    <input type="range" id="presetHoldTime2" min="10" max="90" value="30" 
                                           class="preset-slider" 
                                           oninput="updatePresetHoldTimeDisplay(2, this.value)" 
                                           onchange="setPresetHoldTime(2, this.value); endSliderDrag('presetHoldTime2')"
                                           onmousedown="startSliderDrag('presetHoldTime2')"
                                           ontouchstart="startSliderDrag('presetHoldTime2')" 
                                           disabled>
                                    <span id="presetHoldTimeDisplay2" class="preset-value">30s</span>
                                </div>
                            </div>
                            <div class="preset-control-item">
                                <label class="preset-control-label">Mode:</label>
                                <select id="presetMode2" class="preset-mode-select" onchange="setPresetMode(2, this.value)" disabled>
                                    <option value="0xA1">Steady</option>
                                    <option value="0xB1">Ascent</option>
                                    <option value="0xC1">Descent</option>
                                    <option value="0xD1">Valley</option>
                                    <option value="0xE1">Hill</option>
                                    <option value="0xF1">Custom</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="preset-card" onclick="selectPreset(3)">
                        <div class="preset-title">Preset 3</div>
                        <input type="number" id="tempF3" min="250" max="650" value="550" 
                               class="temp-input" onchange="setTemperature(3, this.value)">
                        <div class="temp-unit">¬∞F</div>
                        <div class="preset-controls">
                            <div class="preset-control-item">
                                <label class="preset-control-label">Hold Time:</label>
                                <div class="preset-control-input">
                                    <input type="range" id="presetHoldTime3" min="10" max="90" value="30" 
                                           class="preset-slider" 
                                           oninput="updatePresetHoldTimeDisplay(3, this.value)" 
                                           onchange="setPresetHoldTime(3, this.value); endSliderDrag('presetHoldTime3')"
                                           onmousedown="startSliderDrag('presetHoldTime3')"
                                           ontouchstart="startSliderDrag('presetHoldTime3')" 
                                           disabled>
                                    <span id="presetHoldTimeDisplay3" class="preset-value">30s</span>
                                </div>
                            </div>
                            <div class="preset-control-item">
                                <label class="preset-control-label">Mode:</label>
                                <select id="presetMode3" class="preset-mode-select" onchange="setPresetMode(3, this.value)" disabled>
                                    <option value="0xA1">Steady</option>
                                    <option value="0xB1">Ascent</option>
                                    <option value="0xC1">Descent</option>
                                    <option value="0xD1">Valley</option>
                                    <option value="0xE1">Hill</option>
                                    <option value="0xF1">Custom</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="preset-card" onclick="selectPreset(4)">
                        <div class="preset-title">Preset 4</div>
                        <input type="number" id="tempF4" min="250" max="650" value="600" 
                               class="temp-input" onchange="setTemperature(4, this.value)">
                        <div class="temp-unit">¬∞F</div>
                        <div class="preset-controls">
                            <div class="preset-control-item">
                                <label class="preset-control-label">Hold Time:</label>
                                <div class="preset-control-input">
                                    <input type="range" id="presetHoldTime4" min="10" max="90" value="30" 
                                           class="preset-slider" 
                                           oninput="updatePresetHoldTimeDisplay(4, this.value)" 
                                           onchange="setPresetHoldTime(4, this.value); endSliderDrag('presetHoldTime4')"
                                           onmousedown="startSliderDrag('presetHoldTime4')"
                                           ontouchstart="startSliderDrag('presetHoldTime4')" 
                                           disabled>
                                    <span id="presetHoldTimeDisplay4" class="preset-value">30s</span>
                                </div>
                            </div>
                            <div class="preset-control-item">
                                <label class="preset-control-label">Mode:</label>
                                <select id="presetMode4" class="preset-mode-select" onchange="setPresetMode(4, this.value)" disabled>
                                    <option value="0xA1">Steady</option>
                                    <option value="0xB1">Ascent</option>
                                    <option value="0xC1">Descent</option>
                                    <option value="0xD1">Valley</option>
                                    <option value="0xE1">Hill</option>
                                    <option value="0xF1">Custom</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="preset-card" onclick="selectPreset(5)">
                        <div class="preset-title">Preset 5</div>
                        <input type="number" id="tempF5" min="250" max="650" value="613" 
                               class="temp-input" onchange="setTemperature(5, this.value)">
                        <div class="temp-unit">¬∞F</div>
                        <div class="preset-controls">
                            <div class="preset-control-item">
                                <label class="preset-control-label">Hold Time:</label>
                                <div class="preset-control-input">
                                    <input type="range" id="presetHoldTime5" min="10" max="90" value="30" 
                                           class="preset-slider" 
                                           oninput="updatePresetHoldTimeDisplay(5, this.value)" 
                                           onchange="setPresetHoldTime(5, this.value); endSliderDrag('presetHoldTime5')"
                                           onmousedown="startSliderDrag('presetHoldTime5')"
                                           ontouchstart="startSliderDrag('presetHoldTime5')" 
                                           disabled>
                                    <span id="presetHoldTimeDisplay5" class="preset-value">30s</span>
                                </div>
                            </div>
                            <div class="preset-control-item">
                                <label class="preset-control-label">Mode:</label>
                                <select id="presetMode5" class="preset-mode-select" onchange="setPresetMode(5, this.value)" disabled>
                                    <option value="0xA1">Steady</option>
                                    <option value="0xB1">Ascent</option>
                                    <option value="0xC1">Descent</option>
                                    <option value="0xD1">Valley</option>
                                    <option value="0xE1">Hill</option>
                                    <option value="0xF1">Custom</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom setting -->
        <div class="grid">
            <div class="card fade-in" id="customConfigCard">
                <div class="card-header">
                    <i class="fas fa-cogs"></i>
                    <h3>Custom setting</h3>
                    <h4>  (Please set time 1-8 first then set temp,Set unnecessary points to 0.) </h4>

                </div>
                <div style="padding: 16px;">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                        <template id="customConfigRowTemplate">
                            <div class="custom-config-row">
                                <label>point<span class="custom-index"></span>Ôºö</label>
                                <input type="number" class="custom-temp" min="250" max="650" step="1" style="width: 70px;" placeholder="Ê∏©Â∫¶">
                                <span>¬∞</span>
                                <input type="number" class="custom-time" min="0" max="255" step="1" style="width: 50px;" placeholder="Êó∂Èó¥">
                                <span>s</span>
                            </div>
                        </template>
                        <!-- 8ÁªÑËæìÂÖ•Ê°Ü -->
                        <div class="custom-config-row">
                            <label>point1Ôºö</label>
                            <input type="number" class="custom-temp" min="250" max="650" step="1" value="400" style="width: 70px;">
                            <span>¬∞</span>
                            <input type="number" class="custom-time" min="0" max="0" step="1" value="0" style="width: 50px;" readonly>
                            <span>s</span>
                        </div>
                        <div class="custom-config-row">
                            <label>point2Ôºö</label>
                            <input type="number" class="custom-temp" min="250" max="650" step="1" value="410" style="width: 70px;">
                            <span>¬∞</span>
                            <input type="number" class="custom-time" min="1" max="90" step="1" value="20" style="width: 50px;">
                            <span>s</span>
                        </div>
                        <div class="custom-config-row">
                            <label>point3Ôºö</label>
                            <input type="number" class="custom-temp" min="250" max="650" step="1" value="420" style="width: 70px;">
                            <span>¬∞</span>
                            <input type="number" class="custom-time" min="0" max="90" step="1" value="30" style="width: 50px;">
                            <span>s</span>
                        </div>
                        <div class="custom-config-row">
                            <label>point4Ôºö</label>
                            <input type="number" class="custom-temp" min="250" max="650" step="1" value="430" style="width: 70px;">
                            <span>¬∞</span>
                            <input type="number" class="custom-time" min="0" max="90" step="1" value="40" style="width: 50px;">
                            <span>s</span>
                        </div>
                        <div class="custom-config-row">
                            <label>point5Ôºö</label>
                            <input type="number" class="custom-temp" min="250" max="650" step="1" value="440" style="width: 70px;">
                            <span>¬∞</span>
                            <input type="number" class="custom-time" min="0" max="90" step="1" value="50" style="width: 50px;">
                            <span>s</span>
                        </div>
                        <div class="custom-config-row">
                            <label>point6Ôºö</label>
                            <input type="number" class="custom-temp" min="250" max="650" step="1" value="450" style="width: 70px;">
                            <span>¬∞</span>
                            <input type="number" class="custom-time" min="0" max="90" step="1" value="60" style="width: 50px;">
                            <span>s</span>
                        </div>
                        <div class="custom-config-row">
                            <label>point7Ôºö</label>
                            <input type="number" class="custom-temp" min="250" max="650" step="1" value="460" style="width: 70px;">
                            <span>¬∞</span>
                            <input type="number" class="custom-time" min="0" max="90" step="1" value="70" style="width: 50px;">
                            <span>s</span>
                        </div>
                        <div class="custom-config-row">
                            <label>point8Ôºö</label>
                            <input type="number" class="custom-temp" min="250" max="650" step="1" value="470" style="width: 70px;">
                            <span>¬∞</span>
                            <input type="number" class="custom-time" min="0" max="90" step="1" value="80" style="width: 50px;">
                            <span>s</span>
                        </div>
                        <div class="custom-config-row">
                            <label>point9Ôºö</label>
                            <input type="number" class="custom-temp" min="250" max="650" step="1" value="480" style="width: 70px;">
                            <span>¬∞</span>
                            <input type="number" class="custom-time" min="0" max="90" step="1" value="90" style="width: 50px;">
                            <span>s</span>
                        </div>
                        <div class="custom-config-row">
                            <label>point10Ôºö</label>
                            <input type="number" class="custom-temp" min="250" max="650" step="1" value="490" style="width: 70px;">
                            <span>¬∞</span>
                            <input type="number" class="custom-time" min="0" max="90" step="1" value="100" style="width: 50px;">
                            <span>s</span>
                        </div>
                    </div>
                    <div style="margin-top: 18px; text-align: right;">
                        <button class="btn btn-primary" id="sendCustomProfileBtn" style="min-width: 180px;">send custom</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Raw Data -->
        <div class="grid">
            <div class="card fade-in">
                <div class="card-header">
                    <i class="fas fa-code"></i>
                    <h3>Raw Data</h3>
                </div>
                <div class="responsive-table">
                    <table class="table">
                        <tr>
                            <td><strong>Last Packet:</strong></td>
                            <td><span id="rawData" style="font-family: monospace; font-size: 0.8rem;">No data</span></td>
                        </tr>
                        <tr>
                            <td><strong>Packet Count:</strong></td>
                            <td><span id="packetCount">0</span></td>
                        </tr>
                        <tr>
                            <td><strong>Last Updated:</strong></td>
                            <td><span id="lastUpdate">Never</span></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>



        </div>

        <!-- Á≥ªÁªüÊó•Âøó -->
        <div class="grid">
            <div class="card fade-in">
                <div class="card-header">
                    <i class="fas fa-terminal"></i>
                    <h3>System Log</h3>
                    <button class="btn btn-secondary" onclick="clearLog()" style="margin-left: auto; padding: 6px 12px; font-size: 0.8rem;">
                        <i class="fas fa-trash"></i>
                        Clear
                    </button>
                </div>
                <div id="logOutput" class="log"></div>
            </div>
        </div>


    </div>

    <!-- ÈÄöÁü•ÁªÑ‰ª∂ -->
    <div id="notification" class="notification">
        <div style="display: flex; align-items: center; gap: 12px;">
            <i class="fas fa-check-circle" style="color: var(--success-color);"></i>
            <span id="notificationText">Operation completed successfully!</span>
        </div>
    </div>

    <!-- IRO.jsÂúÜÂΩ¢Ë∞ÉËâ≤ÁõòÂºπÁ™ó -->
    <div id="colorPickerModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:2000; align-items:center; justify-content:center;">
      <div id="colorPickerContainer" style="background:#fff; border-radius:16px; padding:32px 24px 16px 24px; box-shadow:0 8px 32px rgba(0,0,0,0.18); position:relative; min-width:320px;">
        <div id="iroColorPicker"></div>
        <div id="colorPickerRgbInfo" style="margin: 12px 0; text-align: center; font-size: 1.1em; color: #333;"></div>
        <div id="colorPickerRgbInputs" style="display:flex; align-items:center; justify-content:center; gap:8px; margin:8px 0;">
          <label for="picker_r" style="font-size:0.9em;">R</label>
          <input type="number" id="picker_r" min="0" max="255" value="0" class="form-control" style="width:70px; padding:4px 8px;">
          <label for="picker_g" style="font-size:0.9em;">G</label>
          <input type="number" id="picker_g" min="0" max="255" value="0" class="form-control" style="width:70px; padding:4px 8px;">
          <label for="picker_b" style="font-size:0.9em;">B</label>
          <input type="number" id="picker_b" min="0" max="255" value="0" class="form-control" style="width:70px; padding:4px 8px;">
        </div>
        <div style="text-align:right; margin-top:18px;">
          <button id="colorPickerOkBtn" class="btn btn-primary">setting</button>
          <button id="colorPickerCancelBtn" class="btn btn-secondary" style="margin-left:12px;">back</button>
        </div>
      </div>
    </div>

    <!-- 1. ÂÖàÂä†ËΩΩiro.js‰æùËµñ -->
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5.5.2/dist/iro.min.js"></script>
    <!-- 2. ‰∏ªJS‰ª£Á†ÅÔºåÂåÖÂê´ÊâÄÊúâwindow.addEventListener('load', ...)ÂíåÂÖ®Â±ÄÂáΩÊï∞ -->
    <script>
        let bluetoothDevice;
        let characteristic;

        // NotifyÁõëÂê¨Áõ∏ÂÖ≥ÂèòÈáè
        let rxCharacteristic = null;
        let notificationsEnabled = false;
        let notifyPacketCount = 0;
        let globalPresetIndex = 0;
        let globalTempF = [0,0,0,0,0,0];
        let globalTempC = [0,0,0,0,0,0];
        let currentPreset = 1; // ÂΩìÂâçÈ¢ÑËÆæÂÄº (1-5)
        let holdTime = 30;
        let cleaningAssistEnabled = false; // Ê∏ÖÊ¥ÅÂä©ÊâãÁä∂ÊÄÅ
        
        // ÊØè‰∏™presetÁã¨Á´ãÁöÑHold TimeÂíåModeÂ≠òÂÇ® (preset 1-5)
        let presetHoldTimes = [0, 30, 30, 30, 30, 30]; // index 0 Êú™‰ΩøÁî®Ôºå1-5ÂØπÂ∫îpreset 1-5
        let presetModes = [0, 0xA1, 0xA1, 0xA1, 0xA1, 0xA1]; // index 0 Êú™‰ΩøÁî®Ôºå1-5ÂØπÂ∫îpreset 1-5ÔºåÈªòËÆ§SteadyÊ®°Âºè
        
        // Âõ∫‰ª∂ÁâàÊú¨ÈÖçÁΩÆ
        let TARGET_FIRMWARE_DATE = '251117'; // ÁõÆÊ†áÂõ∫‰ª∂ÁâàÊú¨Êó•Êúü (YYMMDDÊ†ºÂºè)
const FIRMWARE_DATE_MAP = { 'firmware1.0': '251118', 'firmware2.0': '251119' };
        
        // ÂΩìÂâçËÆæÂ§áÁä∂ÊÄÅË∑üË∏™ - B9ÂëΩ‰ª§ÁöÑÊâÄÊúâÂ≠óËäÇÁä∂ÊÄÅ
        let currentB9State = {
            byte3: 0x01,   // È¢ÑËÆæÂÄº (1-5)
            byte6: 0x00,   // LEDÂÄº
            byte8: 0x02,   // Auto Shut Time (0-30ÂàÜÈíü)
            byte10: 0x00,  // SessionÁä∂ÊÄÅ
            byte11: 0xAA,  // Haptic Feedback (0xAA=On, 0x00=Off)
            byte12: 0x00,  // Session Boost (0xAA=Enabled, 0x00=Disabled)
            byte13: 25,    // Brightness (0-100)
            // ÂêéÁª≠ÂèØ‰ª•ÁªßÁª≠Ê∑ªÂä†Êõ¥Â§öÂ≠óËäÇÔºöbyte14, byte15, byte16 Á≠âÁ≠â
        };
        
        // Â≠òÂÇ®5Â•ócustom settingÊï∞ÊçÆ (Êâ©Â±ïÂà∞10‰∏™ÁÇπ)
        let customSettings = {
            1: { temps: [400, 410, 420, 430, 440, 450, 460, 470, 480, 490], times: [0, 10, 20, 30, 40, 50, 60, 70, 80, 90] },
            2: { temps: [400, 410, 420, 430, 440, 450, 460, 470, 480, 490], times: [0, 10, 20, 30, 40, 50, 60, 70, 80, 90] },
            3: { temps: [400, 410, 420, 430, 440, 450, 460, 470, 480, 490], times: [0, 10, 20, 30, 40, 50, 60, 70, 80, 90] },
            4: { temps: [400, 410, 420, 430, 440, 450, 460, 470, 480, 490], times: [0, 10, 20, 30, 40, 50, 60, 70, 80, 90] },
            5: { temps: [400, 410, 420, 430, 440, 450, 460, 470, 480, 490], times: [0, 10, 20, 30, 40, 50, 60, 70, 80, 90] },
        };
        
        // ÊâìÂç∞customSettingsÂèòÂåñÁöÑËæÖÂä©ÂáΩÊï∞
        function logCustomSettingsChange(preset, action, details = '') {
            const timestamp = new Date().toLocaleTimeString();
            const presetData = customSettings[preset];
            if (presetData) {
                console.log(`[${timestamp}] CustomSettingsÂèòÂåñ - Preset ${preset} ${action}:`);
                console.log(`  Ê∏©Â∫¶: [${presetData.temps.join(', ')}]`);
                console.log(`  Êó∂Èó¥: [${presetData.times.join(', ')}]`);
                if (details) {
                    console.log(`  ËØ¶ÊÉÖ: ${details}`);
                }
                log(`CustomSettings Preset ${preset} ${action} - Ê∏©Â∫¶:[${presetData.temps.join(', ')}] Êó∂Èó¥:[${presetData.times.join(', ')}]${details ? ' - ' + details : ''}`);
            }
        }
        


        // Ê®°ÂºèÊò†Â∞Ñ
        const MODE_TYPES = {
            0xA1: 'Steady',
            0xB1: 'Ascent', 
            0xC1: 'Descent',
            0xD1: 'Valley',
            0xE1: 'Hill',
            0xF1: 'Custom'
        };

        let currentMode = 0xA1; // ÈªòËÆ§Ê®°Âºè‰∏∫ Steady
        
        // ÊªëÂùóÊãñÂä®Áä∂ÊÄÅË∑üË∏™
        let isDraggingSlider = false;
        let sliderTimeouts = {}; // Â≠òÂÇ®‰∏çÂêåÊªëÂùóÁöÑË∂ÖÊó∂ID
        let draggingSliders = new Set(); // Ë∑üË∏™Ê≠£Âú®ÊãñÂä®ÁöÑÊªëÂùó

        // Ê∏©Â∫¶ÂõæË°®Áõ∏ÂÖ≥ÂèòÈáè
        let temperatureChart = null;
        let temperatureData = [];
        let chartStartTime = Date.now();
        const MAX_DATA_POINTS = 300; // ÊúÄÂ§ßÊï∞ÊçÆÁÇπÊï∞ÈáèÔºà5ÂàÜÈíü * 60ÁßíÔºâ
        let lastTemperatureUpdate = 0;

        // OTAÁõ∏ÂÖ≥ÂèòÈáè
        let otaWriteQueue = [];
        let otaCrc16Array = [];
        let otaChunkCounter = 0;
        let otaInProgress = false;
        const OTA_CHUNK_SIZE = 16;
        const OTA_BLOCK_SIZE = 2048;
        const OTA_CHUNKS_BEFORE_NOTIFY = 128;

        // LEDÈ¢úËâ≤Êò†Â∞Ñ
        const LED_COLORS = {
            0x00: 'Clam',
            0x01: 'Stealth',
            0x02: 'Purple',
            0x03: 'Blue',
            0x04: 'Cyan',
            0x05: 'Green',
            0x06: 'Yellow',
            0x07: 'Orange',
            0x08: 'Red',
            0x09: 'Pink',
            0x0A: 'Cali Sunset',
            0x0B: 'Purple Haze',
            0x0C: 'Northern Nights',
            0x0D: 'Vegas Nights',
            0x0E: 'Blue Dream',
            0x0F: 'Strawberry Cough',
            0x10: 'Florida Groves',
            0x11: 'Lime Light',
            // 0x14: 'Candy corn',
            // 0x15: 'Redrum',
            // 0x16: 'Skull&Bones',
            // 0x17: 'Witches Brew',
            0x18: 'Candy cane',
            0x19: 'Deck the Halls',
            0x25: 'poinsettia',
            0x26: 'Icicle',
            0x27: 'Sleigh Bells',
            0x28: 'Wintergreen',
            0x29: 'Icicle V2',
            0x2A: 'Wintergreen V2',
        };



        // ÊúçÂä°ÂíåÁâπÂæÅUUIDÔºàËØ∑Ê†πÊçÆÂÆûÈôÖÊÉÖÂÜµ‰øÆÊîπÔºâ
        const SERVICE_UUID = '0000fee7-0000-1000-8000-00805f9b34fb';
        const TX_CHARACTERISTIC_UUID = '0000fec1-0000-1000-8000-00805f9b34fb';
        const RX_CHARACTERISTIC_UUID = '0000fec2-0000-1000-8000-00805f9b34fb';
        
        // ËÆæÂ§á‰ø°ÊÅØÊúçÂä°UUID
        const DEVICE_INFO_SERVICE_UUID = '0000180a-0000-1000-8000-00805f9b34fb';
        const MODEL_NUMBER_UUID = '00002a24-0000-1000-8000-00805f9b34fb';
        const SERIAL_NUMBER_UUID = '00002a25-0000-1000-8000-00805f9b34fb';
        const HARDWARE_VERSION_UUID = '00002a27-0000-1000-8000-00805f9b34fb';
        const SOFTWARE_REVISION_UUID = '00002a28-0000-1000-8000-00805f9b34fb';
        const MANUFACTURER_NAME_UUID = '00002a29-0000-1000-8000-00805f9b34fb';

        function log(message) {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            logOutput.textContent += `[${timestamp}] ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logOutput').textContent = '';
        }

        // ÂàùÂßãÂåñÊ∏©Â∫¶ÂõæË°®
        function initTemperatureChart() {
            try {
                const canvas = document.getElementById('temperatureChart');
                if (!canvas) {
                    console.error('Temperature chart canvas element not found');
                    log('Error: Temperature chart canvas element not found');
                    return;
                }
                
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js library not loaded');
                    log('Error: Chart.js library not loaded');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.error('Failed to get 2D context from canvas');
                    log('Error: Failed to get 2D context from canvas');
                    return;
                }
                
                console.log('Initializing temperature chart...');
                log('Initializing temperature chart...');
                
                temperatureChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Temperature (¬∞F)',
                        data: [],
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 1,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                maxTicksLimit: 6,
                                font: {
                                    size: 10
                                }
                            }
                        },
                        y: {
                            display: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            },
                            min: 0,
                            max: 650 // Âõ∫ÂÆöÊúÄÂ§ßÂÄº‰∏∫650¬∞F
                        }
                    },
                    animation: {
                        duration: 0 // Á¶ÅÁî®Âä®Áîª‰ª•ÊèêÈ´òÊÄßËÉΩ
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
            
            console.log('Temperature chart initialized successfully');
            log('Temperature chart initialized successfully');
            
        } catch (error) {
            console.error('Failed to initialize temperature chart:', error);
            log(`Error initializing temperature chart: ${error.message}`);
            showNotification('Ê∏©Â∫¶ÂõæË°®ÂàùÂßãÂåñÂ§±Ë¥•', 'error', 3000);
        }
    }

        // Êõ¥Êñ∞ÂõæË°®‰ø°ÊÅØÊòæÁ§∫ÔºàYËΩ¥ÊúÄÂ§ßÂÄºÂ∑≤Âõ∫ÂÆö‰∏∫650¬∞FÔºâ
        function updateChartInfo() {
            const chartInfo = document.getElementById('chartInfo');
            if (chartInfo && temperatureData.length > 0) {
                const pointCount = temperatureData.length;
                const duration = Math.floor(pointCount / 60);
                chartInfo.textContent = `${pointCount} points, ~${duration}min data (Max: 650¬∞F)`;
            }
        }

        // Ê∑ªÂä†Ê∏©Â∫¶Êï∞ÊçÆÁÇπÂà∞ÂõæË°®
        function addTemperaturePoint(temperature) {
            const now = Date.now();
            
            // ÈÅøÂÖçËøá‰∫éÈ¢ëÁπÅÁöÑÊõ¥Êñ∞ÔºàÈôêÂà∂‰∏∫ÊØè500msÊõ¥Êñ∞‰∏ÄÊ¨°Ôºâ
            if (now - lastTemperatureUpdate < 500) {
                return;
            }
            lastTemperatureUpdate = now;
            
            const timeFromStart = Math.floor((now - chartStartTime) / 1000); // Áßí
            const timeLabel = formatTimeLabel(timeFromStart);
            
            // Ê∑ªÂä†Êñ∞Êï∞ÊçÆÁÇπ
            temperatureData.push({
                time: timeFromStart,
                temperature: temperature
            });
            
            // ÈôêÂà∂Êï∞ÊçÆÁÇπÊï∞Èáè
            if (temperatureData.length > MAX_DATA_POINTS) {
                temperatureData.shift();
                // ÈáçÊñ∞ËÆ°ÁÆóÊó∂Èó¥Ê†áÁ≠æ
                chartStartTime = now - (MAX_DATA_POINTS * 1000);
            }
            
            // Êõ¥Êñ∞ÂõæË°®‰ø°ÊÅØÊòæÁ§∫
            updateChartInfo();
            
            // Êõ¥Êñ∞ÂõæË°®
            if (temperatureChart) {
                temperatureChart.data.labels = temperatureData.map(point => formatTimeLabel(point.time));
                temperatureChart.data.datasets[0].data = temperatureData.map(point => point.temperature);
                temperatureChart.update('none'); // ‰ΩøÁî®'none'Ê®°ÂºèÈÅøÂÖçÂä®Áîª
            }
            
            // Êõ¥Êñ∞ÂõæË°®‰ø°ÊÅØ
            updateChartInfo();
        }

        // Ê†ºÂºèÂåñÊó∂Èó¥Ê†áÁ≠æ
        function formatTimeLabel(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            if (minutes > 0) {
                return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
            } else {
                return `${remainingSeconds}s`;
            }
        }

        // Ê∏ÖÈô§ÂõæË°®Êï∞ÊçÆ
        function clearTemperatureChart() {
            temperatureData = [];
            chartStartTime = Date.now();
            lastTemperatureUpdate = 0;
            
            if (temperatureChart) {
                temperatureChart.data.labels = [];
                temperatureChart.data.datasets[0].data = [];
                temperatureChart.update();
            }
            
            const chartInfo = document.getElementById('chartInfo');
            if (chartInfo) {
                chartInfo.textContent = 'Real-time temperature monitoring';
            }
            
            log('Temperature chart data cleared');
            showNotification('ÂõæË°®Êï∞ÊçÆÂ∑≤Ê∏ÖÈô§', 'info', 2000);
        }

        // Áé∞‰ª£ÂåñÈÄöÁü•Á≥ªÁªü
        function showNotification(message, type = 'success', duration = 3000) {
            const notification = document.getElementById('notification');
            const icon = notification.querySelector('i');
            const text = document.getElementById('notificationText');
            
            // ÈáçÁΩÆÁ±ªÂêç
            notification.className = 'notification';
            
            // ËÆæÁΩÆÂõæÊ†áÂíåÊ†∑Âºè
            switch(type) {
                case 'success':
                    icon.className = 'fas fa-check-circle';
                    notification.classList.add('show');
                    break;
                case 'error':
                    icon.className = 'fas fa-exclamation-circle';
                    notification.classList.add('show', 'error');
                    break;
                case 'warning':
                    icon.className = 'fas fa-exclamation-triangle';
                    notification.classList.add('show', 'warning');
                    break;
                case 'info':
                    icon.className = 'fas fa-info-circle';
                    notification.classList.add('show', 'info');
                    break;
            }
            
            text.textContent = message;
            
            // Ëá™Âä®ÈöêËóè
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        // Ê∑ªÂä†ËøûÊé•Áä∂ÊÄÅÂä®Áîª
        function updateConnectionStatusWithAnimation(connected, connecting = false) {
            const statusElement = document.getElementById('connectionStatus');
            const indicator = document.getElementById('statusIndicator');
            const icon = document.getElementById('statusIcon');
            const text = document.getElementById('statusText');
            
            // Ëé∑ÂèñÊéßÂà∂ÊåâÈíÆ
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            if (connecting) {
                statusElement.className = 'status status-disconnected';
                indicator.className = 'status-indicator connecting';
                icon.className = 'fas fa-spinner spinning';
                text.textContent = 'Connecting...';
                return;
            }
            
            if (connected) {
                statusElement.className = 'status status-connected bounce';
                indicator.className = 'status-indicator connected';
                icon.className = 'fas fa-link';
                text.textContent = 'Device Connected';
                
                // ÂêØÁî®ËøûÊé•Áä∂ÊÄÅÁöÑÊåâÈíÆ
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                
                // ÂêØÁî®ËÆæÂ§áÊéßÂà∂Áõ∏ÂÖ≥ÁöÑÊéß‰ª∂
                const sessionControlBtn = document.getElementById('sessionControlBtn');
                const presetBtn = document.getElementById('presetBtn');
                const autoShutTimeInput = document.getElementById('autoShutTime');
                const holdTimeInput = document.getElementById('holdTime');
                const brightnessInput = document.getElementById('brightness');
                const ledPresetSelect = document.getElementById('ledPresetSelect');
                const modeControlBtn = document.getElementById('modeControlBtn');
                const hapticBtn = document.getElementById('hapticBtn');
                const boostBtn = document.getElementById('boostBtn');
                const cleaningAssistBtn = document.getElementById('cleaningAssistBtn');
                const updateFirmwareBtn = document.getElementById('updateFirmwareBtn');
                
                if (sessionControlBtn) sessionControlBtn.disabled = false;
                if (presetBtn) presetBtn.disabled = false;
                if (autoShutTimeInput) autoShutTimeInput.disabled = false;
                if (holdTimeInput) holdTimeInput.disabled = false;
                if (brightnessInput) brightnessInput.disabled = false;
                if (ledPresetSelect) ledPresetSelect.disabled = false;
                if (modeControlBtn) modeControlBtn.disabled = false;
                if (hapticBtn) hapticBtn.disabled = false;
                if (cleaningAssistBtn) cleaningAssistBtn.disabled = false;
                if (updateFirmwareBtn) updateFirmwareBtn.disabled = false;
                // BoostÊåâÈíÆÂàùÂßãÁä∂ÊÄÅ‰∏∫Á¶ÅÁî®ÔºàÂè™ÊúâÂä†ÁÉ≠Êó∂ÊâçÂêØÁî®Ôºâ
                if (boostBtn) boostBtn.disabled = true;
                
                // ÂêØÁî®Ê∏©Â∫¶È¢ÑËÆæËæìÂÖ•Ê°Ü
                ['tempF1', 'tempF2', 'tempF3', 'tempF4', 'tempF5'].forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.disabled = false;
                        input.classList.remove('heating-disabled');
                        // ‰∏∫Áà∂ÂÆπÂô®‰πüÁßªÈô§Á¶ÅÁî®Á±ª
                        const container = input.closest('.preset-card');
                        if (container) container.classList.remove('heating-disabled');
                    }
                });
                
                // ÂêØÁî®presetÊéß‰ª∂ÔºàHold TimeÊªëÂùóÂíåModeÈÄâÊã©Âô®Ôºâ
                for (let i = 1; i <= 5; i++) {
                    const holdTimeSlider = document.getElementById(`presetHoldTime${i}`);
                    const modeSelect = document.getElementById(`presetMode${i}`);
                    if (holdTimeSlider) holdTimeSlider.disabled = false;
                    if (modeSelect) modeSelect.disabled = false;
                }
                
                showNotification('ËÆæÂ§áËøûÊé•ÊàêÂäüÔºÅ', 'success');
                
                // ÊòæÁ§∫ËÆæÂ§á‰ø°ÊÅØÂç°ÁâáÂíåÁªüËÆ°‰ø°ÊÅØÂç°Áâá
                document.getElementById('deviceInfoCard').style.display = 'block';
                document.getElementById('deviceStatsCard').style.display = 'block';
                
                // ÂêØÁî®ÁªüËÆ°‰ø°ÊÅØÂà∑Êñ∞ÊåâÈíÆ
                document.getElementById('refreshStatsBtn').disabled = false;
            } else {
                statusElement.className = 'status status-disconnected';
                indicator.className = 'status-indicator disconnected';
                icon.className = 'fas fa-unlink';
                text.textContent = 'Device Not Connected';
                
                // Á¶ÅÁî®ËøûÊé•Áä∂ÊÄÅÁöÑÊåâÈíÆ
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                
                // Á¶ÅÁî®ËÆæÂ§áÊéßÂà∂Áõ∏ÂÖ≥ÁöÑÊéß‰ª∂
                const sessionControlBtn = document.getElementById('sessionControlBtn');
                const presetBtn = document.getElementById('presetBtn');
                const autoShutTimeInput = document.getElementById('autoShutTime');
                const holdTimeInput = document.getElementById('holdTime');
                const brightnessInput = document.getElementById('brightness');
                const ledPresetSelect = document.getElementById('ledPresetSelect');
                const modeControlBtn = document.getElementById('modeControlBtn');
                const hapticBtn = document.getElementById('hapticBtn');
                const boostBtn = document.getElementById('boostBtn');
                const cleaningAssistBtn = document.getElementById('cleaningAssistBtn');
                const updateFirmwareBtn = document.getElementById('updateFirmwareBtn');
                
                if (sessionControlBtn) sessionControlBtn.disabled = true;
                if (presetBtn) presetBtn.disabled = true;
                if (updateFirmwareBtn) updateFirmwareBtn.disabled = true;
                if (autoShutTimeInput) {
                    autoShutTimeInput.disabled = true;
                    autoShutTimeInput.value = 2;
                    updateAutoShutDisplay(2);
                }
                if (holdTimeInput) {
                    holdTimeInput.disabled = true;
                    holdTimeInput.value = 30;
                    updateHoldTimeDisplay(30);
                }
                if (brightnessInput) {
                    brightnessInput.disabled = true;
                    brightnessInput.value = 25;
                    updateBrightnessDisplay(25);
                }
                if (ledPresetSelect) ledPresetSelect.disabled = true;
                if (modeControlBtn) modeControlBtn.disabled = true;
                if (hapticBtn) {
                    hapticBtn.disabled = true;
                    updateHapticButton(true); // ÈáçÁΩÆ‰∏∫ÈªòËÆ§Áä∂ÊÄÅ
                }
                if (boostBtn) {
                    boostBtn.disabled = true;
                    updateBoostButton(0); // ÈáçÁΩÆ‰∏∫ÈªòËÆ§Áä∂ÊÄÅ
                }
                if (cleaningAssistBtn) {
                    cleaningAssistBtn.disabled = true;
                    updateCleaningAssistButton(false); // ÈáçÁΩÆ‰∏∫ÈªòËÆ§Áä∂ÊÄÅ
                }
                
                // Á¶ÅÁî®Ê∏©Â∫¶È¢ÑËÆæËæìÂÖ•Ê°Ü
                ['tempF1', 'tempF2', 'tempF3', 'tempF4', 'tempF5'].forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.disabled = true;
                        // ÈáçÁΩÆÂÄº
                        const presetValues = [450, 500, 550, 600, 613];
                        const presetIndex = parseInt(id.replace('tempF', '')) - 1;
                        if (presetIndex >= 0 && presetIndex < presetValues.length) {
                            input.value = presetValues[presetIndex];
                        }
                    }
                });
                
                // Á¶ÅÁî®presetÊéß‰ª∂ÔºàHold TimeÊªëÂùóÂíåModeÈÄâÊã©Âô®ÔºâÂπ∂ÈáçÁΩÆÂÄº
                for (let i = 1; i <= 5; i++) {
                    const holdTimeSlider = document.getElementById(`presetHoldTime${i}`);
                    const modeSelect = document.getElementById(`presetMode${i}`);
                    if (holdTimeSlider) {
                        holdTimeSlider.disabled = true;
                        holdTimeSlider.value = 30;
                        updatePresetHoldTimeDisplay(i, 30);
                        presetHoldTimes[i] = 30; // ÈáçÁΩÆÊú¨Âú∞Â≠òÂÇ®
                    }
                    if (modeSelect) {
                        modeSelect.disabled = true;
                        modeSelect.value = '0xA1'; // ÈáçÁΩÆ‰∏∫SteadyÊ®°Âºè
                        presetModes[i] = 0xA1; // ÈáçÁΩÆÊú¨Âú∞Â≠òÂÇ®
                    }
                }
                
                // ÈáçÁΩÆnotifyÁä∂ÊÄÅ
                notificationsEnabled = false;
                const notifyToggle = document.getElementById('notifyToggle');
                if (notifyToggle) {
                    notifyToggle.checked = false;
                }
                document.getElementById('notifyStatus').textContent = 'Disabled';
                document.getElementById('deviceStatusInfo').style.display = 'none';
                
                // ÈöêËóèËÆæÂ§á‰ø°ÊÅØÂç°ÁâáÂíåÁªüËÆ°‰ø°ÊÅØÂç°ÁâáÂπ∂ÈáçÁΩÆ‰ø°ÊÅØ
                document.getElementById('deviceInfoCard').style.display = 'none';
                document.getElementById('deviceStatsCard').style.display = 'none';
                resetDeviceInfo();
                resetDeviceStats();
                
                // Á¶ÅÁî®ÁªüËÆ°‰ø°ÊÅØÂà∑Êñ∞ÊåâÈíÆ
                document.getElementById('refreshStatsBtn').disabled = true;
                
                // Ê∏ÖÈô§Ê∏©Â∫¶ÂõæË°®Êï∞ÊçÆ
                if (temperatureChart) {
                    clearTemperatureChart();
                }
            }
            
            // ÁßªÈô§Âä®ÁîªÁ±ª
            setTimeout(() => {
                statusElement.classList.remove('bounce');
            }, 600);
        }



        // Ê∑ªÂä†ÊåâÈíÆÂä†ËΩΩÁä∂ÊÄÅ
        function setButtonLoading(buttonId, loading = true) {
            const button = document.getElementById(buttonId);
            if (loading) {
                button.classList.add('loading');
                button.disabled = true;
            } else {
                button.classList.remove('loading');
            }
        }



        // LEDÈ¢úËâ≤È¢ÑËßàÂäüËÉΩ
        function updateLedPreview(colorValue) {
            const preview = document.getElementById('ledPreview');
            const colorName = LED_COLORS[colorValue] || 'unknown';
            
            // ÁßªÈô§ÊâÄÊúâÈ¢úËâ≤Á±ª
            preview.className = 'led-preview';
            
            // Ê∑ªÂä†ÂØπÂ∫îÁöÑÈ¢úËâ≤Á±ª
            const colorClass = colorName.toLowerCase().replace(/\s+/g, '-');
            preview.classList.add(colorClass);
        }

        // Êñ∞Â¢ûÔºöÂÖ®Â±ÄÂèòÈáèÁºìÂ≠òC1~C4ÂåÖÂÜÖÂÆπ
        let deviceInfoPackets = {
            c1: null,
            c2: null,
            c3: null,
            c4: null
        };

        function clearDeviceInfoPackets() {
            deviceInfoPackets = { c1: null, c2: null, c3: null, c4: null };
        }

        // Êñ∞Â¢ûÔºöËß£ÊûêC1~C4ÂåÖÂπ∂Êõ¥Êñ∞UI
        function handleDeviceInfoPacket(data) {
            if (data[0] === 0xC1) {
                deviceInfoPackets.c1 = data.slice(2, 19); // 17Â≠óËäÇ
            } else if (data[0] === 0xC2) {
                deviceInfoPackets.c2 = data.slice(2, 14); // 12Â≠óËäÇ
            } else if (data[0] === 0xC3) {
                deviceInfoPackets.c3 = data.slice(2, 10); // 8Â≠óËäÇ
            } else if (data[0] === 0xC4) {
                deviceInfoPackets.c4 = data.slice(2, 10); // 8Â≠óËäÇ
            }
            // Ê£ÄÊü•ÊòØÂê¶ÂÖ®ÈÉ®Êî∂Âà∞
            if (deviceInfoPackets.c1 && deviceInfoPackets.c2 && deviceInfoPackets.c3 && deviceInfoPackets.c4) {
                // ÊãºÊé•ËÆæÂ§áÂêç
                const nameArr = Array.from(deviceInfoPackets.c1).concat(Array.from(deviceInfoPackets.c2));
                const deviceName = String.fromCharCode(...nameArr).replace(/\0/g, '').trim();
                const serialNumber = String.fromCharCode(...deviceInfoPackets.c3).replace(/\0/g, '').trim();
                const modelNumber = String.fromCharCode(...deviceInfoPackets.c4).replace(/\0/g, '').trim();
                // Âè™Êõ¥Êñ∞model/serial
                document.getElementById('modelNumber').textContent = modelNumber || 'null';
                document.getElementById('serialNumber').textContent = serialNumber || 'null';
                // ‰∏çÂÜçË¶ÜÁõñhardwareVersion/softwareRevision/manufacturer
                clearDeviceInfoPackets();
            }
        }

        // ‰øÆÊîπhandleResponseÔºåÂ¢ûÂä†C1~C4ÂåÖÂ§ÑÁêÜ
        function handleResponse(event) {
            const data = new Uint8Array(event.target.value.buffer);
            
            // ‰ºòÂÖàÊ£ÄÊü•OTAÂìçÂ∫îÔºàÂú®OTAËøõË°å‰∏≠Ôºâ
            if (otaInProgress) {
                if (handleOTAResponse(data)) {
                    return; // OTAÂìçÂ∫îÂ∑≤Â§ÑÁêÜ
                }
            }
            
            // Ê£ÄÊü•C1~C4ÂåÖ
            if (data[0] === 0xC1 || data[0] === 0xC2 || data[0] === 0xC3 || data[0] === 0xC4) {
                handleDeviceInfoPacket(data);
                return;
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÊòØËÆæÂ§áÁä∂ÊÄÅnotifyÊï∞ÊçÆÂåÖ (20Â≠óËäÇÔºåÂåÖÂ§¥ÂåÖÂ∞æÈÉΩÊòØ0xA9)
            if (data.length === 20 && data[0] === 0xA9 && data[19] === 0xA9) {
                // Â±èËîΩ0xA9 notifyÊï∞ÊçÆÂåÖÁöÑÊó•ÂøóËæìÂá∫ÔºåÈÅøÂÖçÊó•ÂøóË¢´Âà∑Â±è
                handleNotifyData(data);
                return;
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÊòØÊ®°ÂºèÁä∂ÊÄÅnotifyÊï∞ÊçÆÂåÖ (5Â≠óËäÇÔºåA5 05 preset mode A5)
            if (data.length === 5 && data[0] === 0xA5 && data[4] === 0xA5 && data[1] === 0x05) {
                const preset = data[2];
                if (preset === 0) {
                    // preset 0 = ÂÖ®Â±ÄÊ®°ÂºèÊéßÂà∂
                    handleModeNotifyData(data);
                } else if (preset >= 1 && preset <= 5) {
                    // preset 1-5 = ÂêÑÈ¢ÑËÆæÁöÑÊ®°ÂºèÊéßÂà∂
                    handlePresetModeData(data);
                }
                return;
            }
            
            // Êñ∞Â¢ûÔºöËá™ÂÆö‰πâÂèÇÊï∞ÂåÖÂ§ÑÁêÜÔºà0xaa/0xab/0xbcÂåÖÂ§¥ÂåÖÂ∞æÔºå16Â≠óËäÇÔºâ
            if ((data[0] === 0xaa && data[data.length-1] === 0xaa && data.length === 16) ||
                (data[0] === 0xab && data[data.length-1] === 0xab && data.length === 16) ||
                (data[0] === 0xac && data[data.length-1] === 0xac && data.length === 16)) {
                log(`Received response: length=${data.length} bytes, content=${Array.from(data).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' ')}`);
                handleCustomProfileData(data);
                return;
            }

            // Êñ∞Â¢ûÔºöÂ§ÑÁêÜLEDÈ¢úËâ≤ÁÇπnotify (ac/ad/ae)
            if (data.length === 6 && (data[0] === 0xad || data[0] === 0xae || data[0] === 0xaf) && data[5] === data[0]) {
                handleColorPointData(data);
                return;
            }
            
            // ÂØπ‰∫éÈùû0xA9Êï∞ÊçÆÂåÖÔºåÊâìÂç∞data 16ËøõÂà∂Êï∞ÊçÆÂíåÈïøÂ∫¶
            log(`Received response: length=${data.length} bytes, content=${Array.from(data).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' ')}`);
            
            // Ê£ÄÊü•ÊòØÂê¶ÊòØÊ∏©Â∫¶ËÆæÂÆöÊï∞ÊçÆÂåÖ (8Â≠óËäÇÔºåÂåÖÂ§¥ÂåÖÂ∞æÈÉΩÊòØ0xA3)
            if (data.length === 8 && data[0] === 0xA3 && data[7] === 0xA3) {
                handleTempSettingData(data);
                return;
            }
 
            // Ê£ÄÊü•ÊòØÂê¶ÊòØHold TimeÊï∞ÊçÆÂåÖ (6Â≠óËäÇÔºåA7 06 preset time_high time_low A7)
            if (data.length === 6 && data[0] === 0xA7 && data[5] === 0xA7 && data[1] === 0x06) {
                const preset = data[2];
                if (preset === 0) {
                    // preset 0 = ÂÖ®Â±ÄHold Time (ÊóßÊ†ºÂºèÔºå‰ΩÜdata[2]Â∫îËØ•ÊòØ0ËÄå‰∏çÊòØ1)
                    handleTempTimeData(data);
                } else if (preset >= 1 && preset <= 5) {
                    // preset 1-5 = ÂêÑÈ¢ÑËÆæÁöÑHold Time
                    handlePresetHoldTimeData(data);
                }
                return;
            }

            // Ê£ÄÊü•ÊòØÂê¶ÊòØÁªüËÆ°‰ø°ÊÅØÊï∞ÊçÆÂåÖ (A2ÂºÄÂ§¥)
            if (data.length >= 5 && data[0] === 0xA2) {
                handleDeviceStatsData(data);
                return;
            }

            // ËÆ∞ÂΩïÊú™Â§ÑÁêÜÁöÑÂìçÂ∫î
            const responseText = Array.from(data).map(b => String.fromCharCode(b)).join('');
            log(`Received unhandled response: ${responseText}`);
        }

        // Â§ÑÁêÜÊ®°ÂºèÁä∂ÊÄÅnotifyÊï∞ÊçÆ
        function handleModeNotifyData(data) {
            const mode = data[3];
            const modeName = MODE_TYPES[mode] || `Unknown (0x${mode.toString(16).padStart(2, '0')})`;
            
            // Êõ¥Êñ∞ÂΩìÂâçÊ®°Âºè
            currentMode = mode;
            
            // Êõ¥Êñ∞Ê®°ÂºèÊòæÁ§∫
            updateModeDisplay(mode, modeName);
            
            log(`Received global mode notify: ${modeName} (0x${mode.toString(16).padStart(2, '0')})`);
        }

        // OTAÁõ∏ÂÖ≥ÂáΩÊï∞
        function calculateOTACRC16(crc, data, length) {
            for (let i = 0; i < length; i++) {
                crc ^= (data[i] & 0xFF) << 8;
                for (let j = 0; j < 8; j++) {
                    if (crc & 0x8000) {
                        crc = (crc << 1) ^ 0x1021;
                    } else {
                        crc <<= 1;
                    }
                }
            }
            return crc & 0xFFFF;
        }

        async function loadOTABinFile() {
            try {
                const selectedFirmware = window.selectedFirmwareVersion || 'firmware1.0';
                const firmwareFileMap = { 'firmware1.0': './firmware_1_0.bin', 'firmware2.0': './firmware_2_0.bin' };
                const otaBinPath = firmwareFileMap[selectedFirmware] || './simple_ota.bin';
                const response = await fetch(otaBinPath);
                if (!response.ok) {
                    throw new Error(`Failed to load simple_ota.bin: ${response.statusText}`);
                }
                const arrayBuffer = await response.arrayBuffer();
                return new Uint8Array(arrayBuffer);
            } catch (error) {
                log(`‚úó Failed to load OTA file: ${error.message}`);
                showNotification(`Âä†ËΩΩÂõ∫‰ª∂Êñá‰ª∂Â§±Ë¥•: ${error.message}`, 'error');
                throw error;
            }
        }

        async function startFirmwareUpdate() {
            if (!characteristic) {
                log('Error: Device not connected');
                showNotification('ËÆæÂ§áÊú™ËøûÊé•ÔºåÊó†Ê≥ïÊõ¥Êñ∞Âõ∫‰ª∂', 'error');
                return;
            }

            if (otaInProgress) {
                log('OTA update already in progress');
                showNotification('Âõ∫‰ª∂Êõ¥Êñ∞Ê≠£Âú®ËøõË°å‰∏≠', 'warning');
                return;
            }

            try {
                // Á¶ÅÁî®ÊâÄÊúâÊéßÂà∂ÊåâÈíÆ
                setOTAModeUI(true);
                
                log('ÂºÄÂßãÂõ∫‰ª∂Êõ¥Êñ∞...');
                showNotification('Ê≠£Âú®Âä†ËΩΩÂõ∫‰ª∂Êñá‰ª∂...', 'info');
                
                // Âä†ËΩΩbinÊñá‰ª∂
                const data = await loadOTABinFile();
                log(`‚úì Loaded firmware file: ${data.length} bytes`);
                
                // ÂºÄÂßãOTA
                await startOTA(data);
                
            } catch (error) {
                log(`‚úó Firmware update failed: ${error.message}`);
                showNotification(`Âõ∫‰ª∂Êõ¥Êñ∞Â§±Ë¥•: ${error.message}`, 'error');
                setOTAModeUI(false);
            }
        }

        async function startOTA(data) {
            otaWriteQueue = [];
            otaInProgress = true;
            
            // Êï∞ÊçÆÂ°´ÂÖÖÂà∞16Â≠óËäÇÊï¥Êï∞ÂÄç
            const paddedDataLength = Math.ceil(data.length / OTA_CHUNK_SIZE) * OTA_CHUNK_SIZE;
            const paddedData = new Uint8Array(paddedDataLength).fill(0xFF);
            paddedData.set(data);
            
            log(`‚úì Padded data length: ${paddedDataLength} bytes`);
            
            // È™åËØÅÊñá‰ª∂Â§ßÂ∞èÔºà‰∏ªÂõ∫‰ª∂Â∫îËØ•Â§ß‰∫é120KBÔºâ
            if (paddedDataLength < 120000) {
                throw new Error('Âõ∫‰ª∂Êñá‰ª∂ËøáÂ∞èÔºåÂèØËÉΩ‰∏çÊòØÊúâÊïàÁöÑ‰∏ªÂõ∫‰ª∂Êñá‰ª∂');
            }
            
            // ËÆ°ÁÆóÊï¥‰ΩìCRC16
            const crc16 = calculateOTACRC16(0xFFFF, paddedData, paddedData.length);
            log(`‚úì File CRC16: 0x${crc16.toString(16).padStart(4, '0')}`);
            
            // ËÆ°ÁÆóÊØè‰∏™2KBÂùóÁöÑCRC16
            let blockCrc16 = 0xFFFF;
            otaCrc16Array = [];
            for (let i = 0; i < paddedDataLength; i += OTA_BLOCK_SIZE) {
                const blockData = paddedData.subarray(i, Math.min(i + OTA_BLOCK_SIZE, paddedDataLength));
                blockCrc16 = calculateOTACRC16(blockCrc16, blockData, blockData.length);
                otaCrc16Array.push(blockCrc16);
                log(`Block ${i / OTA_BLOCK_SIZE} CRC16: 0x${blockCrc16.toString(16).padStart(4, '0')}`);
            }
            
            // ÊûÑÈÄ†ÂºÄÂßãÂëΩ‰ª§
            const startCommand = new Uint8Array(20).fill(0xFF);
            const commandBytes = new TextEncoder().encode("ota start");
            startCommand.set(commandBytes);
            startCommand[10] = (paddedDataLength >> 24) & 0xFF;
            startCommand[11] = (paddedDataLength >> 16) & 0xFF;
            startCommand[12] = (paddedDataLength >> 8) & 0xFF;
            startCommand[13] = paddedDataLength & 0xFF;
            startCommand[14] = (crc16 >> 8) & 0xFF;
            startCommand[15] = crc16 & 0xFF;
            otaWriteQueue.push(startCommand);
            
            // ÂàÜÂåÖÊï∞ÊçÆ
            const totalChunks = paddedDataLength / OTA_CHUNK_SIZE;
            for (let i = 0; i < totalChunks; i++) {
                const chunkWithAddress = new Uint8Array(20).fill(0xFF);
                chunkWithAddress[0] = (i >> 24) & 0xFF;
                chunkWithAddress[1] = (i >> 16) & 0xFF;
                chunkWithAddress[2] = (i >> 8) & 0xFF;
                chunkWithAddress[3] = i & 0xFF;
                const chunkData = paddedData.subarray(i * OTA_CHUNK_SIZE, (i + 1) * OTA_CHUNK_SIZE);
                chunkWithAddress.set(chunkData, 4);
                otaWriteQueue.push(chunkWithAddress);
            }
            
            // Ê∑ªÂä†ÁªìÊùüÂëΩ‰ª§
            const endCommand = new TextEncoder().encode("ota finish");
            const endCommandArray = new Uint8Array(20).fill(0xFF);
            endCommandArray.set(endCommand);
            otaWriteQueue.push(endCommandArray);
            
            // ÂàùÂßãÂåñËøõÂ∫¶
            updateOTAProgress(0, totalChunks);
            
            // ÂºÄÂßãÂèëÈÄÅ
            otaChunkCounter = -1;
            log(`‚úì Starting OTA transmission: ${totalChunks} chunks`);
            showNotification('ÂºÄÂßãÂõ∫‰ª∂‰º†Ëæì...', 'info');
            
            writeNextOTAChunk();
        }

        async function writeNextOTAChunk() {
            if (otaWriteQueue.length > 0) {
                const chunk = otaWriteQueue.shift();
                try {
                    await characteristic.writeValueWithoutResponse(chunk);
                    
                    if (otaChunkCounter === -1) {
                        // ÂèëÈÄÅ‰∫ÜÂºÄÂßãÂëΩ‰ª§ÔºåÁ≠âÂæÖ1ÁßíÂêéÁªßÁª≠
                        otaChunkCounter = 0;
                        setTimeout(() => {
                            writeNextOTAChunk();
                        }, 1000);
                    } else {
                        otaChunkCounter++;
                        
                        // Êõ¥Êñ∞ËøõÂ∫¶
                        const totalChunks = otaChunkCounter + otaWriteQueue.length;
                        updateOTAProgress(otaChunkCounter, totalChunks);
                        
                        // ÊØè128ÂåÖÁ≠âÂæÖÂìçÂ∫î
                        if (otaChunkCounter % OTA_CHUNKS_BEFORE_NOTIFY === 0) {
                            log(`Waiting for OK notification (chunk ${otaChunkCounter})...`);
                        } else {
                            setTimeout(() => {
                                writeNextOTAChunk();
                            }, 10);
                        }
                    }
                } catch (error) {
                    log(`‚úó Failed to send OTA chunk: ${error.message}`);
                    showNotification(`Âõ∫‰ª∂‰º†ËæìÂ§±Ë¥•: ${error.message}`, 'error');
                    setOTAModeUI(false);
                }
            } else {
                // OTAÂÆåÊàê
                otaInProgress = false;
                log('‚úì OTA Update Complete');
                showNotification('Âõ∫‰ª∂Êõ¥Êñ∞ÂÆåÊàêÔºÅ', 'success');
                setOTAModeUI(false);
                updateOTAProgress(100, 100, true);
            }
        }

        function handleOTAResponse(data) {
            // Ê£ÄÊü•ÊòØÂê¶ÊòØOTAÁöÑ"OK"ÂìçÂ∫î
            if (data.length >= 2 && data[0] === 0x4F && data[1] === 0x4B) { // "OK"
                let receivedCrcTransmit = 0xFFFF;
                let receivedCrcFlash = 0xFFFF;
                
                if (data.length > 3) {
                    receivedCrcTransmit = (data[2] << 8) | data[3];
                    log(`Received CRC transmit: 0x${receivedCrcTransmit.toString(16).padStart(4, '0')}`);
                }
                
                if (data.length > 5) {
                    receivedCrcFlash = (data[4] << 8) | data[5];
                    log(`Received CRC flash: 0x${receivedCrcFlash.toString(16).padStart(4, '0')}`);
                }
                
                if (data.length > 3) {
                    // È™åËØÅCRC
                    const currentBlockIndex = Math.floor(otaChunkCounter / (OTA_BLOCK_SIZE / OTA_CHUNK_SIZE)) - 1;
                    const expectedCrc = otaCrc16Array[currentBlockIndex];
                    
                    if (receivedCrcTransmit === expectedCrc && receivedCrcFlash === expectedCrc) {
                        log('‚úì CRC check passed, continuing...');
                        writeNextOTAChunk();
                    } else {
                        log(`‚úó CRC check failed: expected 0x${expectedCrc.toString(16).padStart(4, '0')}`);
                        showNotification('CRCÊ†°È™åÂ§±Ë¥•ÔºåÂÅúÊ≠¢‰º†Ëæì', 'error');
                        setOTAModeUI(false);
                    }
                } else {
                    // ÁÆÄÂçïÁöÑOKÂìçÂ∫îÔºåÁªßÁª≠‰º†Ëæì
                    writeNextOTAChunk();
                }
                
                return true; // Ë°®Á§∫Â∑≤Â§ÑÁêÜOTAÂìçÂ∫î
            }
            
            return false; // ‰∏çÊòØOTAÂìçÂ∫î
        }

        function updateOTAProgress(current, total, completed = false) {
            const progressContainer = document.getElementById('otaProgressContainer');
            const progressBar = document.getElementById('otaProgressBar');
            const progressText = document.getElementById('otaProgressText');
            
            if (completed) {
                progressContainer.style.display = 'none';
                return;
            }
            
            const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
            
            progressContainer.style.display = 'block';
            progressBar.style.width = percentage + '%';
            progressText.textContent = `${percentage}% (${current}/${total})`;
        }

        function setOTAModeUI(otaMode) {
            const updateBtn = document.getElementById('updateFirmwareBtn');
            const buttons = [
                'connectBtn', 'disconnectBtn', 'sessionControlBtn', 'presetBtn',
                'modeControlBtn', 'hapticBtn', 'boostBtn', 'cleaningAssistBtn',
                'refreshStatsBtn', 'sendCustomProfileBtn'
            ];
            
            if (otaMode) {
                // OTAÊ®°ÂºèÔºöÁ¶ÅÁî®ÊâÄÊúâÊåâÈíÆÈô§‰∫ÜÂõ∫‰ª∂Êõ¥Êñ∞ÊåâÈíÆ
                updateBtn.textContent = 'Updating...';
                updateBtn.disabled = true;
                updateBtn.classList.add('loading');
                
                buttons.forEach(btnId => {
                    const btn = document.getElementById(btnId);
                    if (btn) btn.disabled = true;
                });
                
                // Á¶ÅÁî®ÊâÄÊúâËæìÂÖ•Êéß‰ª∂
                const inputs = document.querySelectorAll('input, select');
                inputs.forEach(input => {
                    input.disabled = true;
                });
                
            } else {
                // ÊÅ¢Â§çÊ≠£Â∏∏Ê®°Âºè
                updateBtn.innerHTML = '<i class="fas fa-download"></i> Update Firmware';
                updateBtn.disabled = !characteristic; // Âè™ÊúâËøûÊé•Êó∂ÊâçÂêØÁî®
                updateBtn.classList.remove('loading');
                
                // ÊÅ¢Â§çÂõ∫‰ª∂Áä∂ÊÄÅÊ£ÄÊü•
                if (characteristic) {
                    const softwareRevision = document.getElementById('softwareRevision').textContent;
                    updateFirmwareStatus(softwareRevision);
                }
                
                // ÈáçÊñ∞ËÆæÁΩÆÊåâÈíÆÁä∂ÊÄÅÔºàÈúÄË¶ÅËÄÉËôëËøûÊé•Áä∂ÊÄÅÔºâ
                if (characteristic) {
                    buttons.forEach(btnId => {
                        const btn = document.getElementById(btnId);
                        if (btn && btnId !== 'connectBtn') {
                            btn.disabled = false;
                        }
                    });
                    
                    // ÈáçÊñ∞ÂêØÁî®ËæìÂÖ•Êéß‰ª∂
                    const inputs = document.querySelectorAll('input, select');
                    inputs.forEach(input => {
                        input.disabled = false;
                    });
                    
                    // Á¶ÅÁî®ËøûÊé•ÊåâÈíÆÔºåÂêØÁî®Êñ≠ÂºÄÊåâÈíÆ
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                } else {
                    // ËÆæÂ§áÊú™ËøûÊé•ÔºåÂè™ÂêØÁî®ËøûÊé•ÊåâÈíÆ
                    document.getElementById('connectBtn').disabled = false;
                    buttons.forEach(btnId => {
                        const btn = document.getElementById(btnId);
                        if (btn && btnId !== 'connectBtn') {
                            btn.disabled = true;
                        }
                    });
                }
                
                // ÈöêËóèËøõÂ∫¶Êù°ÂíåÂõ∫‰ª∂Áä∂ÊÄÅ
                document.getElementById('otaProgressContainer').style.display = 'none';
                document.getElementById('firmwareStatusContainer').style.display = 'none';
            }
        }

        // Â§ÑÁêÜËÆæÂ§áÁä∂ÊÄÅnotifyÊï∞ÊçÆ
        function handleNotifyData(data) {
            notifyPacketCount++;
            
            // È™åËØÅÊï∞ÊçÆÂåÖÊ†ºÂºè
            if (data[1] !== 20) {
                log(`Invalid notify packet length field: ${data[1]}`);
                return;
            }
            
            // Ëß£ÊûêÊï∞ÊçÆÂåÖ
            const preset = data[3];
            const tempSetting =    globalTempF[preset];//data[4];
            const ledPreset = data[6];
            const sessionEnable = data[7];
            const autoShutTime = data[8];
            const remainTime = data[9];
            const realTemp = (data[10] << 8) | data[11]; // Ê∏©Â∫¶ÂêàÂπ∂
            const tempUnit = data[12] === 0x0f ? '‚Ñâ' : '‚ÑÉ'; // 0x0f=ÂçéÊ∞èÂ∫¶, 0x0c=ÊëÑÊ∞èÂ∫¶
            const sessionRemainTime = data[13];
            const hapticFeedback = data[14];
            const sessionBoost = data[15];
            const batteryLevel = data[16];
            const chargeState = data[17];
            const brightness = data[18];
            
            // Êõ¥Êñ∞ÊòæÁ§∫ÔºàÂ¶ÇÊûúÊ≤°ÊúâÂú®ÊãñÂä®ÊªëÂùóÔºâ
            updateDeviceStatus({
                preset,
                tempSetting,
                realTemp,
                tempUnit,
                ledPreset,
                sessionEnable,
                autoShutTime,
                remainTime,
                sessionRemainTime,
                hapticFeedback,
                sessionBoost,
                batteryLevel,
                chargeState,
                brightness
            }, isDraggingSlider); // ‰º†ÈÄíÊãñÂä®Áä∂ÊÄÅ
            
            // Êõ¥Êñ∞Ê∏©Â∫¶ÂõæË°®
            if (realTemp > 0 && notificationsEnabled) {
                addTemperaturePoint(realTemp);
            }
            
            // Êõ¥Êñ∞ÂéüÂßãÊï∞ÊçÆÊòæÁ§∫
            const rawDataHex = Array.from(data).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' ');
            document.getElementById('rawData').textContent = rawDataHex;
            document.getElementById('packetCount').textContent = notifyPacketCount;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            
            //log(`Received device status notify: temp=${realTemp}¬∞${tempUnit}, battery=${batteryLevel}%, preset=${preset}`);
        }


        
        function handleTempTimeData(data) {
            if (data[1] !== 6) {
                log(`Invalid temp time packet length field: ${data[1]}`);
                return;
            }    
            holdTime = (data[3] << 8) | data[4];
            
            // Êõ¥Êñ∞Hold TimeËæìÂÖ•Ê°ÜÔºàÂè™Âú®‰∏çÊãñÂä®Êó∂Êõ¥Êñ∞Ôºâ
            if (!draggingSliders.has('holdTime')) {
                const holdTimeElement = document.getElementById('holdTime');
                if (holdTimeElement) {
                    holdTimeElement.value = holdTime;
                    updateHoldTimeDisplay(holdTime);
                } else {
                    console.error('holdTime element not found in handleGlobalHoldTimeData');
                }
            }
            
            log(`Received global hold time: ${holdTime} seconds`);
        }

        // Â§ÑÁêÜÊ∏©Â∫¶ËÆæÂÆöÊï∞ÊçÆÂåÖ - Ê†ºÂºè: 0xA3 + ÈïøÂ∫¶(8) + È¢ÑËÆæÁ¥¢Âºï + ÂçéÊ∞èÊ∏©Â∫¶(2Â≠óËäÇ) + ÊëÑÊ∞èÊ∏©Â∫¶(2Â≠óËäÇ) + 0xA3
        function handleTempSettingData(data) {
            // È™åËØÅÊï∞ÊçÆÂåÖÊ†ºÂºè
            if (data[1] !== 8) {
                log(`Invalid temp setting packet length field: ${data[1]}`);
                return;
            }
            
            // Ëß£ÊûêÊï∞ÊçÆÂåÖ
            const presetIndex = data[2]; // È¢ÑËÆæÁ¥¢Âºï (1-5)
            const tempF = (data[3] << 8) | data[4]; // ÂçéÊ∞èÊ∏©Â∫¶
            const tempC = (data[5] << 8) | data[6]; // ÊëÑÊ∞èÊ∏©Â∫¶
            
            // È™åËØÅÈ¢ÑËÆæÁ¥¢ÂºïËåÉÂõ¥
            if (presetIndex < 1 || presetIndex > 5) {
                log(`Invalid preset index: ${presetIndex}`);
                return;
            }
            
            // ‰øùÂ≠òÂà∞ÂÖ®Â±ÄÂèòÈáè
            globalPresetIndex = presetIndex;
            globalTempF[presetIndex] = tempF;
            globalTempC[presetIndex] = tempC;
            
            // Êõ¥Êñ∞Ê∏©Â∫¶È¢ÑËÆæËæìÂÖ•Ê°Ü
            document.getElementById(`tempF${presetIndex}`).value = tempF;
            
            // ÊòæÁ§∫ÂéüÂßãÊï∞ÊçÆ
            const rawDataHex = Array.from(data).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' ');
            
            log(`Received temp setting for preset ${presetIndex}: ${tempF}¬∞F`);
            log(`  Raw data: ${rawDataHex}`);
        }

        // ËØ∑Ê±ÇËÆæÂ§áÁªüËÆ°‰ø°ÊÅØ - ÂèëÈÄÅB2ÂëΩ‰ª§
        async function requestDeviceStats() {
            if (!characteristic) {
                log('Error: Device not connected');
                showNotification('ËÆæÂ§áÊú™ËøûÊé•ÔºåÊó†Ê≥ïËé∑ÂèñÁªüËÆ°‰ø°ÊÅØ', 'error');
                return;
            }

            try {
                // ÊûÑÈÄ†B2ÂëΩ‰ª§Êï∞ÊçÆÂåÖÔºö0xB2 + 0x04 + 0xFF + 0xB2
                const statsCommand = new Uint8Array([0xB2, 0x04, 0xFF, 0xB2]);
                
                // ÂèëÈÄÅÁªüËÆ°‰ø°ÊÅØËØ∑Ê±ÇÂëΩ‰ª§
                await characteristic.writeValue(statsCommand);
                
                const packetHex = Array.from(statsCommand).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' ');
                
                log(`‚úì Device statistics request sent`);
                log(`  Packet data: ${packetHex}`);
                
                showNotification('Ê≠£Âú®Ëé∑ÂèñËÆæÂ§áÁªüËÆ°‰ø°ÊÅØ...', 'info', 2000);
                
            } catch (error) {
                log(`‚úó Failed to request device statistics: ${error.message}`);
                showNotification(`Ëé∑ÂèñÁªüËÆ°‰ø°ÊÅØÂ§±Ë¥•: ${error.message}`, 'error');
            }
        }

        // Â§ÑÁêÜËÆæÂ§áÁªüËÆ°‰ø°ÊÅØÊï∞ÊçÆÂåÖ - Ê†ºÂºè: 0xA2 + ÈïøÂ∫¶ + Êï∞ÊçÆ + 0xA2
        function handleDeviceStatsData(data) {
            // ÊòæÁ§∫ÂéüÂßãÊï∞ÊçÆ
            const rawDataHex = Array.from(data).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' ');
            log(`Received device statistics data (${data.length} bytes):`);
            log(`  Raw data: ${rawDataHex}`);
            
            // È™åËØÅA2Êï∞ÊçÆÂåÖÊ†ºÂºèÔºöËá≥Â∞ë3Â≠óËäÇÔºà0xA2 + ÈïøÂ∫¶ + 0xA2Ôºâ
            if (data.length < 3) {
                log(`‚úó A2 packet too short: ${data.length} bytes`);
                return;
            }
            
            // È™åËØÅÂåÖÂ§¥ÂíåÂåÖÂ∞æ
            if (data[0] !== 0xA2 || data[data.length - 1] !== 0xA2) {
                log(`‚úó Invalid A2 packet format - missing header/footer`);
                return;
            }
            
            // È™åËØÅÈïøÂ∫¶Â≠óÊÆµ
            const declaredLength = data[1];
            if (declaredLength !== data.length) {
                log(`‚úó A2 packet length mismatch - declared: ${declaredLength}, actual: ${data.length}`);
                return;
            }
            
            // Ëß£Êûê‰∏çÂêåÁ±ªÂûãÁöÑA2Êï∞ÊçÆÂåÖ
            if (data.length === 19) {
                // 19Â≠óËäÇÁöÑÁªüËÆ°‰ø°ÊÅØÊï∞ÊçÆÂåÖ
                try {
                    // ‰ªéÊï∞ÊçÆÂåÖ‰∏≠ÊèêÂèñÁªüËÆ°‰ø°ÊÅØÔºàÊ†πÊçÆÊñ∞ÁöÑA2 13Êï∞ÊçÆÁªìÊûÑÔºâ
                    const stats = {
                        favoriteTempF: (data[2] << 8) | data[3],       // ÂñúÁà±Ê∏©Â∫¶ÂçéÊ∞èÂ∫¶
                        favoriteTempC: (data[4] << 8) | data[5],       // ÂñúÁà±Ê∏©Â∫¶ÊëÑÊ∞èÂ∫¶
                        totalHeatingCycles: (data[6] << 8) | data[7],  // ÊÄªÂä†ÁÉ≠Ê¨°Êï∞
                        mostCyclesInDay: (data[8] << 8) | data[9],     // ÂçïÊó•ÊúÄÂ§öÂä†ÁÉ≠Ê¨°Êï∞
                        chargeCycles: (data[10] << 8) | data[11],      // ÂÖÖÁîµÂæ™ÁéØÊ¨°Êï∞
                        profile: data[12],                             // ÈÖçÁΩÆÊñá‰ª∂
                        lightMode: data[13],                           // ÁÅØÂÖâÊ®°Âºè
                        deviceResets: (data[14] << 8) | data[15],      // ËÆæÂ§áÈáçÁΩÆÊÄªÊ¨°Êï∞
                        favoriteHeatingTime: (data[16] << 8) | data[17] // ÂñúÁà±Âä†ÁÉ≠Êó∂Èó¥
                    };
                    
                    // Êõ¥Êñ∞ÊòæÁ§∫
                    updateDeviceStatsDisplay(stats);
                    
                    log(`‚úì Device statistics parsed successfully:`);
                    log(`  Favorite Temperature: ${stats.favoriteTempF}¬∞F (${stats.favoriteTempC}¬∞C)`);
                    log(`  Total Heating Cycles: ${stats.totalHeatingCycles}`);
                    log(`  Most Cycles in Day: ${stats.mostCyclesInDay}`);
                    log(`  Charge Cycles: ${stats.chargeCycles}`);
                    log(`  Profile: ${stats.profile}`);
                    log(`  Light Mode: ${stats.lightMode}`);
                    log(`  Device Resets: ${stats.deviceResets}`);
                    log(`  Favorite Heating Time: ${stats.favoriteHeatingTime}s`);
                    
                    showNotification('ËÆæÂ§áÁªüËÆ°‰ø°ÊÅØËé∑ÂèñÊàêÂäüÔºÅ', 'success', 2000);
                    
                } catch (error) {
                    log(`‚úó Failed to parse 19-byte A2 statistics: ${error.message}`);
                    showNotification('ÁªüËÆ°‰ø°ÊÅØËß£ÊûêÂ§±Ë¥•', 'error');
                }
            } else if (data.length === 0x0B) {
                // 7Â≠óËäÇÁöÑA2Êï∞ÊçÆÂåÖ - Session Total Time
                try {
                    // Ëß£ÊûêSession Total Time (4Â≠óËäÇÔºåÂ§ßÁ´ØÂ∫è)
                    const sessionTotalTime = (data[2] << 24) | (data[3] << 16) | (data[4] << 8) | data[5];
                    const deviceOnTime = (data[6] << 24) | data[7] << 16 | data[8] << 8 | data[9];
                    // Êõ¥Êñ∞Session Total TimeÊòæÁ§∫
                    updateSessionTotalTimeDisplay(sessionTotalTime, deviceOnTime);
                    
                    log(`‚úì Session Total Time received: ${sessionTotalTime} seconds, Device On Time: ${deviceOnTime} seconds`);
                    log(`  Raw time data: ${Array.from(data.slice(2, -1)).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' ')}`);
                    
                } catch (error) {
                    log(`‚úó Failed to parse 7-byte A2 session time: ${error.message}`);
                }
            } 
            else if (data.length === 0x0D) {
                const presetCycles_1 = (data[2] << 8) | data[3];   
                const presetCycles_2 = (data[4] << 8) | data[5];   
                const presetCycles_3 = (data[6] << 8) | data[7];
                const presetCycles_4 = (data[8] << 8) | data[9];
                const presetCycles_5 = (data[10] << 8) | data[11];
                document.getElementById('presetCycles1').textContent = `${presetCycles_1}`; 
                document.getElementById('presetCycles2').textContent = `${presetCycles_2}`;
                document.getElementById('presetCycles3').textContent = `${presetCycles_3}`;
                document.getElementById('presetCycles4').textContent = `${presetCycles_4}`;
                document.getElementById('presetCycles5').textContent = `${presetCycles_5}`;  
            }
            else {
                // ÂÖ∂‰ªñÈïøÂ∫¶ÁöÑA2Êï∞ÊçÆÂåÖ
                log(`‚úì Received A2 packet (${data.length} bytes) - data: ${Array.from(data.slice(2, -1)).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' ')}`);
            }
        }

        // Êõ¥Êñ∞ËÆæÂ§áÁªüËÆ°‰ø°ÊÅØÊòæÁ§∫
        function updateDeviceStatsDisplay(stats) {
            document.getElementById('favoriteTemp').textContent = `${stats.favoriteTempF}¬∞F (${stats.favoriteTempC}¬∞C)`;
            document.getElementById('totalHeatingCycles').textContent = stats.totalHeatingCycles;
            document.getElementById('mostCyclesInDay').textContent = stats.mostCyclesInDay;
            document.getElementById('chargeCycles').textContent = stats.chargeCycles;
            
            // Profile: ÊòæÁ§∫Êï∞Â≠óÂØπÂ∫îÁöÑÊ®°ÂºèÊñáÂ≠ó (Ê†πÊçÆMODE_TYPESÊò†Â∞Ñ)
            const PROFILE_MODE_MAP = {
                0xA1: 'Steady',
                0xB1: 'Ascent', 
                0xC1: 'Descent',
                0xD1: 'Valley',
                0xE1: 'Hill',
                0xF1: 'Custom'
            };
            const profileText = PROFILE_MODE_MAP[stats.profile] || `Unknown (${stats.profile})`;
            document.getElementById('profile').textContent = profileText;
            
            // Light Mode: ÊòæÁ§∫ÁÅØÂÖâÂØπÂ∫îÊ®°ÂºèÊñáÂ≠ó
            const lightModeText = LED_COLORS[stats.lightMode] || `Unknown (${stats.lightMode})`;
            document.getElementById('lightMode').textContent = lightModeText;
            
            document.getElementById('deviceResets').textContent = stats.deviceResets;
            document.getElementById('favoriteHeatingTime').textContent = `${stats.favoriteHeatingTime}s`;
        }

        // Êõ¥Êñ∞Session Total TimeÊòæÁ§∫
        function updateSessionTotalTimeDisplay(totalTimeSeconds,deviceTimeSeconds) {
            // Â∞ÜÁßíÊï∞ËΩ¨Êç¢‰∏∫Êõ¥ÊòìËØªÁöÑÊ†ºÂºè
            const hours = Math.floor(totalTimeSeconds / 3600);
            const minutes = Math.floor((totalTimeSeconds % 3600) / 60);
            const seconds = totalTimeSeconds % 60;
  
            const hours2 = Math.floor(deviceTimeSeconds / 3600);
            const minutes2 = Math.floor((deviceTimeSeconds % 3600) / 60);
            const seconds2 = deviceTimeSeconds % 60;


            let timeStr = '';
            if (hours > 0) {
                timeStr = `${hours}h ${minutes}m ${seconds}s`;
            } else if (minutes > 0) {
                timeStr = `${minutes}m ${seconds}s`;
            } else {
                timeStr = `${seconds}s`;
            }
    
            let timeStr2 = '';
            if (hours2 > 0) {
                timeStr2 = `${hours2}h ${minutes2}m ${seconds2}s`;
            } else if (minutes2 > 0) {
                timeStr2 = `${minutes2}m ${seconds2}s`;
            } else {
                timeStr2 = `${seconds2}s`;
            }


            document.getElementById('sessionTotalTime').textContent = timeStr;
            document.getElementById('DeviceOnTime').textContent = timeStr2;
        }

        // ÈáçÁΩÆËÆæÂ§áÁªüËÆ°‰ø°ÊÅØÊòæÁ§∫
        function resetDeviceStats() {
            document.getElementById('favoriteTemp').textContent = '--';
            document.getElementById('totalHeatingCycles').textContent = '--';
            document.getElementById('mostCyclesInDay').textContent = '--';
            document.getElementById('chargeCycles').textContent = '--';
            document.getElementById('profile').textContent = '--';
            document.getElementById('lightMode').textContent = '--';
            document.getElementById('deviceResets').textContent = '--';
            document.getElementById('favoriteHeatingTime').textContent = '--';
            document.getElementById('sessionTotalTime').textContent = '--';
            document.getElementById('DeviceOnTime').textContent = '--';
            document.getElementById('presetCycles1').textContent = '--';
            document.getElementById('presetCycles2').textContent = '--';
            document.getElementById('presetCycles3').textContent = '--';
            document.getElementById('presetCycles4').textContent = '--';
            document.getElementById('presetCycles5').textContent = '--';

        }

                // Êõ¥Êñ∞ËÆæÂ§áÁä∂ÊÄÅÊòæÁ§∫
        function updateDeviceStatus(status, skipSliderUpdate = false) {
            // Êõ¥Êñ∞È¢ÑËÆæÊòæÁ§∫ÂíåÂêåÊ≠•ÂΩìÂâçÈ¢ÑËÆæÂÄº
            currentPreset = status.preset;
            document.getElementById('presetBtn').textContent = status.preset;
            
            // Êõ¥Êñ∞presetÂç°ÁâáÈÄâ‰∏≠Áä∂ÊÄÅ
            updatePresetCardSelection(status.preset);
            
            document.getElementById('tempSetting').textContent = status.tempSetting + '¬∞F';
            document.getElementById('realTemp').textContent = status.realTemp + '¬∞F';
            
            // Êõ¥Êñ∞ÂΩìÂâçpresetÂØπÂ∫îÁöÑÊ®°ÂºèÊòæÁ§∫
            updateCurrentPresetModeDisplay(status.preset);
           //  document.getElementById('tempUnit').textContent = status.tempUnit;
           
            // Êõ¥Êñ∞ÂõæË°®‰ø°ÊÅØÊòæÁ§∫
            setTimeout(() => updateChartInfo(), 100);
            
            // Êõ¥Êñ∞LEDÈ¢ÑËÆæÊòæÁ§∫ÂíåÈÄâÊã©Ê°Ü
            const ledColorName = LED_COLORS[status.ledPreset] || `Unknown (0x${status.ledPreset.toString(16).padStart(2, '0')})`;
            document.getElementById('ledPreset').textContent = ledColorName;
            
            // Êõ¥Êñ∞ÈÄâÊã©Ê°Ü
            const ledSelect = document.getElementById('ledPresetSelect');
            const ledHexValue = '0x' + status.ledPreset.toString(16).padStart(2, '0').toUpperCase();
            ledSelect.value = ledHexValue;
            
            // Êõ¥Êñ∞LEDÈ¢úËâ≤È¢ÑËßà
            updateLedPreview(status.ledPreset);
            
            // ÂêåÊ≠•Áä∂ÊÄÅË∑üË∏™ÂèòÈáè
            currentB9State.byte3 = status.preset;
            currentB9State.byte6 = status.ledPreset;
            currentB9State.byte8 = status.autoShutTime;
            currentB9State.byte10 = status.sessionEnable ? 0xaa : 0x00;
            currentB9State.byte11 = status.hapticFeedback ? 0xAA : 0x00;
            currentB9State.byte12 = status.sessionBoost;
            currentB9State.byte13 = status.brightness;
            
            // Êõ¥Êñ∞SessionÊéßÂà∂ÊåâÈíÆ
            updateSessionControlButton(status.sessionEnable);
            
            // Âè™Âú®ÈùûÊãñÂä®Áä∂ÊÄÅ‰∏ãÊõ¥Êñ∞ÊªëÂùóÂÄº
            if (!skipSliderUpdate) {
                // Âè™Êõ¥Êñ∞‰∏çÂú®ÊãñÂä®‰∏≠ÁöÑÊªëÂùó
                if (!draggingSliders.has('autoShutTime')) {
                    const autoShutTimeElement = document.getElementById('autoShutTime');
                    if (autoShutTimeElement) {
                        autoShutTimeElement.value = status.autoShutTime;
                        updateAutoShutDisplay(status.autoShutTime);
                    } else {
                        console.error('autoShutTime element not found in updateDeviceStatus');
                    }
                }
                
                if (!draggingSliders.has('brightness')) {
                    const brightnessElement = document.getElementById('brightness');
                    if (brightnessElement) {
                        brightnessElement.value = status.brightness;
                        updateBrightnessDisplay(status.brightness);
                    } else {
                        console.error('brightness element not found in updateDeviceStatus');
                    }
                }
            }
            
            document.getElementById('remainTime').textContent = status.remainTime;
            document.getElementById('sessionRemainTime').textContent = status.sessionRemainTime;
            document.getElementById('batteryLevel').textContent = status.batteryLevel + '%';
            
            // Êõ¥Êñ∞HapticÂíåBoostÊåâÈíÆÊòæÁ§∫
            updateHapticButton(status.hapticFeedback);
            updateBoostButton(currentB9State.byte12);
            
            // ÂÖÖÁîµÁä∂ÊÄÅÊòæÁ§∫
            const chargeStateText = status.chargeState === 0XAA ? 'Charging' : 'Not Charging';
            document.getElementById('chargeState').textContent = chargeStateText;
        }



        // ÊóßÁöÑupdateConnectionStatusÂáΩÊï∞Â∑≤Ë¢´updateConnectionStatusWithAnimationÊõø‰ª£

        async function connectDevice() {
            try {
                updateConnectionStatusWithAnimation(false, true); // ÊòæÁ§∫ËøûÊé•‰∏≠Áä∂ÊÄÅ
                setButtonLoading('connectBtn', true);
                log('Searching for Bluetooth devices...');
                
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [
                        { services: ['0000fee7-0000-1000-8000-00805f9b34fb'] }
                    ],
                    optionalServices: [SERVICE_UUID, DEVICE_INFO_SERVICE_UUID]
                });

                log(`Found device: ${bluetoothDevice.name}`);
                
                const server = await bluetoothDevice.gatt.connect();
                log('GATT server connected successfully');
                
                const service = await server.getPrimaryService(SERVICE_UUID);
                log('Service obtained successfully');
                
                characteristic = await service.getCharacteristic(TX_CHARACTERISTIC_UUID);
                log('TX characteristic obtained successfully');
                
                // Get RX characteristic for listening to responses
                rxCharacteristic = await service.getCharacteristic(RX_CHARACTERISTIC_UUID);
                log('RX characteristic obtained successfully');
                
                // Enable notifications to receive responses
                await rxCharacteristic.startNotifications();
                rxCharacteristic.addEventListener('characteristicvaluechanged', handleResponse);
                log('Response listener enabled successfully');

                // Listen for device disconnection
                bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
                
                updateConnectionStatusWithAnimation(true);
                log('Bluetooth device connected successfully!');
                
                // Êñ∞Â¢ûÔºöËøûÊé•ÊàêÂäüÂêéËá™Âä®ÂèëÈÄÅB1Êåá‰ª§Ëé∑ÂèñËÆæÂ§á‰ø°ÊÅØ
                setTimeout(async () => {
                    if (characteristic) {
                        clearDeviceInfoPackets();
                        const b1Cmd = new Uint8Array([0xB1, 0x04, 0xFF, 0xB1]);
                        await characteristic.writeValue(b1Cmd);
                        log('B1Êåá‰ª§Â∑≤ÂèëÈÄÅÔºåÁ≠âÂæÖËÆæÂ§á‰ø°ÊÅØC1~C4ÂåÖ...');
                    }
                }, 500);
                
                // Êñ∞Â¢ûÔºöËá™Âä®ËØªÂèñsoftware revisionÂíåmanufacturer
                setTimeout(async () => {
                    await readSoftwareAndManufacturer(server);
                }, 700);
                
                // Ëá™Âä®ÂêåÊ≠•Êó∂Èó¥
                setTimeout(async () => {
                    await syncTime();
                }, 1000); // Âª∂Ëøü1ÁßíÂêéËá™Âä®ÂêåÊ≠•Êó∂Èó¥
                
                // Ëá™Âä®ÂêØÁî®ÂÆûÊó∂ÁõëÊéß
                setTimeout(async () => {
                    if (rxCharacteristic && !notificationsEnabled) {
                        await toggleNotifications();
                    }
                }, 1500); // Âª∂Ëøü1.5ÁßíÂêéËá™Âä®ÂêØÁî®ÂÆûÊó∂ÁõëÊéß
                
                // Ëé∑ÂèñËÆæÂ§áÁªüËÆ°‰ø°ÊÅØ
                setTimeout(async () => {
                    await requestDeviceStats();
                }, 2000); // Âª∂Ëøü2ÁßíÂêéËé∑ÂèñËÆæÂ§áÁªüËÆ°‰ø°ÊÅØ
                
            } catch (error) {
                log(`Connection failed: ${error.message}`);
                updateConnectionStatusWithAnimation(false);
                showNotification(`ËøûÊé•Â§±Ë¥•: ${error.message}`, 'error');
            } finally {
                setButtonLoading('connectBtn', false);
            }
        }

        function onDisconnected() {
            log('Device disconnected');
            updateConnectionStatusWithAnimation(false);
            bluetoothDevice = null;
            characteristic = null;
            rxCharacteristic = null;
        }

        async function disconnectDevice() {
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
                log('Device disconnected actively');
            }
            updateConnectionStatusWithAnimation(false);
            rxCharacteristic = null;
        }









        // Check browser support
        if (!navigator.bluetooth) {
            log('Error: This browser does not support Web Bluetooth API');
            log('Please use Chrome, Edge, or other browsers that support Web Bluetooth');
            document.getElementById('connectBtn').disabled = true;
        } else {
            log('Browser supports Web Bluetooth API');
        }

        // Page load initialization
        window.addEventListener('load', function() {
            
            // ËÆæÁΩÆHold TimeÈªòËÆ§ÂÄº
            const holdTimeElement = document.getElementById('holdTime');
            if (holdTimeElement) {
                holdTimeElement.value = holdTime;
                updateHoldTimeDisplay(holdTime);
            } else {
                console.error('holdTime element not found');
            }
            
            // ËÆæÁΩÆAuto Shut TimeÈªòËÆ§ÂÄº
            const autoShutTimeElement = document.getElementById('autoShutTime');
            if (autoShutTimeElement) {
                autoShutTimeElement.value = currentB9State.byte8;
                updateAutoShutDisplay(currentB9State.byte8);
            } else {
                console.error('autoShutTime element not found');
            }
            
            // ËÆæÁΩÆBrightnessÈªòËÆ§ÂÄº
            const brightnessElement = document.getElementById('brightness');
            if (brightnessElement) {
                brightnessElement.value = currentB9State.byte13;
                updateBrightnessDisplay(currentB9State.byte13);
            } else {
                console.error('brightness element not found');
            }
            
            // ÂàùÂßãÂåñLEDÈ¢ÑËßà
            updateLedPreview(0x00);
            
            // ÂàùÂßãÂåñÊ®°ÂºèÊòæÁ§∫
            updateModeDisplay(currentMode, MODE_TYPES[currentMode]);
            
            // ÂàùÂßãÂåñHapticÂíåBoostÊåâÈíÆÊòæÁ§∫
            updateHapticButton(currentB9State.byte11 === 0xAA);
            updateBoostButton(currentB9State.byte12);
            
            // ÂàùÂßãÂåñCleaningAssistÊåâÈíÆÊòæÁ§∫
            updateCleaningAssistButton(cleaningAssistEnabled);
            
            // ÂàùÂßãÂåñpresetÊéß‰ª∂ÊòæÁ§∫
            for (let i = 1; i <= 5; i++) {
                updatePresetHoldTimeDisplay(i, presetHoldTimes[i]);
                // ModeÈÄâÊã©Âô®ÈªòËÆ§ÂÄºÂ∑≤Âú®HTML‰∏≠ËÆæÁΩÆÔºåËøôÈáå‰∏çÈúÄË¶ÅÁâπÂà´Â§ÑÁêÜ
            }
            
            // ÂàùÂßãÂåñÂΩìÂâçpresetÂØπÂ∫îÁöÑÊ®°ÂºèÊòæÁ§∫
            updateCurrentPresetModeDisplay(currentPreset);
            
            // ÂàùÂßãÂåñpresetÂç°ÁâáÈÄâ‰∏≠Áä∂ÊÄÅ
            updatePresetCardSelection(currentPreset);
            
            // Á°Æ‰øùBoostÊåâÈíÆÂàùÂßãÁä∂ÊÄÅ‰∏∫Á¶ÅÁî®ÔºàÂè™ÊúâÂä†ÁÉ≠Êó∂ÊâçËÉΩ‰ΩøÁî®Ôºâ
            document.getElementById('boostBtn').disabled = true;
            
            // ÂàùÂßãÂåñÊ∏©Â∫¶ÂõæË°®
            setTimeout(() => {
                initTemperatureChart();
                log('Temperature chart initialized');
            }, 500); // Âª∂ËøüÂàùÂßãÂåñ‰ª•Á°Æ‰øùDOMÂÆåÂÖ®Âä†ËΩΩ
            
            // ÂàùÂßãÂåñCustom Preset UI
            updateCustomUI();
            
            // Ê∑ªÂä†È°µÈù¢Âä†ËΩΩÂä®Áîª
            const cards = document.querySelectorAll('.card');
            cards.forEach((card, index) => {
                card.style.animationDelay = `${index * 0.1}s`;
            });
            
            // ÊòæÁ§∫Ê¨¢ËøéÈÄöÁü•
            setTimeout(() => {
                showNotification('PY32F071 ËÆæÂ§áÊéßÂà∂Â∑•ÂÖ∑Â∑≤Â∞±Áª™', 'info', 2000);
            }, 1000);

            // ÂàùÂßãÂåñÂõ∫‰ª∂ÁâàÊú¨ÈÄâÊã©Âô®
            const firmwareSelect = document.getElementById('firmwareSelect');
            if (firmwareSelect) {
                window.selectedFirmwareVersion = firmwareSelect.value;
                TARGET_FIRMWARE_DATE = FIRMWARE_DATE_MAP[firmwareSelect.value] || '251117';
                log(`Â∑≤ÈÄâÊã©Âõ∫‰ª∂: ${window.selectedFirmwareVersion}ÔºåÊó•Êúü: ${TARGET_FIRMWARE_DATE}`);

                // Ê†πÊçÆÂõ∫‰ª∂ÁâàÊú¨Âä®ÊÄÅË∞ÉÊï¥LEDÈ¢ÑËÆæÈÄâÈ°πÔºà0x14‚Äì0x18Ôºâ
                const applyLedPresetOptionsByFirmware = (selected) => {
                    const ledSelect = document.getElementById('ledPresetSelect');
                    if (!ledSelect) return;
                    const halloweenValues = ['0x14','0x15','0x16','0x17','0x18'];
                    // ÂÖàÁßªÈô§ÁõÆÊ†áÂå∫Èó¥ÂÜÖÁöÑÂ∑≤ÊúâÈÄâÈ°π
                    halloweenValues.forEach(val => {
                        const idx = Array.from(ledSelect.options).findIndex(o => o.value === val);
                        if (idx >= 0) ledSelect.remove(idx);
                    });
                    if (selected === 'firmware2.0') {
                        // Âè™‰øùÁïô0x17ÔºåÂêçÁß∞Êîπ‰∏∫ custom animation
                        const opt = document.createElement('option');
                        opt.value = '0x17';
                        opt.textContent = 'custom animation';
                        ledSelect.appendChild(opt);
                        // Â¶ÇÊûúÂΩìÂâçÂÄº‰∏çÂú®ÂàóË°®‰∏≠ÔºåÈªòËÆ§ÈÄâ‰∏≠0x17
                        if (!Array.from(ledSelect.options).some(o => o.value === ledSelect.value)) {
                            ledSelect.value = '0x17';
                        }
                    } else {
                        // ÊÅ¢Â§çÂéüÂßãÈÄâÈ°π‰∏éÂêçÁß∞
                        const originals = [
                            // { value: '0x14', text: 'Candy corn' },
                            // { value: '0x15', text: 'Redrum' },
                            // { value: '0x16', text: 'Skull&Bones' },
                            // { value: '0x17', text: 'Witches Brew' },
                            { value: '0x18', text: 'Candy cane' },
                            { value: '0x19', text: 'Deck the Halls' },
                            { value: '0x25', text: 'poinsettia' },
                            { value: '0x26', text: 'Icicle' },
                            { value: '0x27', text: 'Sleigh Bells' },
                            { value: '0x28', text: 'Wintergreen' },
                            { value: '0x29', text: 'Icicle V2' },
                            { value: '0x2A', text: 'Wintergreen V2' }
                        ];
                        originals.forEach(({value, text}) => {
                            const opt = document.createElement('option');
                            opt.value = value;
                            opt.textContent = text;
                            ledSelect.appendChild(opt);
                        });
                        // Ëã•ÂΩìÂâçÂÄº‰∏çÂ≠òÂú®ÂàôÈªòËÆ§ÈÄâ‰∏≠0x18
                        if (!Array.from(ledSelect.options).some(o => o.value === ledSelect.value)) {
                            ledSelect.value = '0x14';
                        }
                    }
                };

                // ÂàùÂßãÂåñÂ∫îÁî®‰∏ÄÊ¨°
                applyLedPresetOptionsByFirmware(window.selectedFirmwareVersion);

                firmwareSelect.addEventListener('change', (e) => {
                    window.selectedFirmwareVersion = e.target.value;
                    TARGET_FIRMWARE_DATE = FIRMWARE_DATE_MAP[e.target.value] || '251117';
                    log(`Â∑≤ÈÄâÊã©Âõ∫‰ª∂: ${window.selectedFirmwareVersion}ÔºåÊó•Êúü: ${TARGET_FIRMWARE_DATE}`);
                    // ÂèòÊõ¥ÂêéÊõ¥Êñ∞LEDÈ¢ÑËÆæÈÄâÈ°π
                    applyLedPresetOptionsByFirmware(window.selectedFirmwareVersion);
                });
            }

        });

        // ÂàáÊç¢notificationsÂºÄÂÖ≥
        async function toggleNotifications() {
            if (!rxCharacteristic) {
                log('Error: RX characteristic not available');
                showNotification('ËÆæÂ§áÊú™ËøûÊé•ÔºåÊó†Ê≥ïÂêØÁî®ÁõëÊéß', 'error');
                return;
            }

            try {
                const toggle = document.getElementById('notifyToggle');
                
                if (notificationsEnabled) {
                    // Á¶ÅÁî®notifications
                    await rxCharacteristic.stopNotifications();
                    notificationsEnabled = false;
                    document.getElementById('notifyStatus').textContent = 'Disabled';
                    document.getElementById('deviceStatusInfo').style.display = 'none';
                    toggle.checked = false;
                    log('Device status notifications disabled');
                    showNotification('ÂÆûÊó∂ÁõëÊéßÂ∑≤ÂÖ≥Èó≠', 'info', 2000);
                } else {
                    // ÂêØÁî®notifications
                    await rxCharacteristic.startNotifications();
                    notificationsEnabled = true;
                    document.getElementById('notifyStatus').textContent = 'Enabled';
                    document.getElementById('deviceStatusInfo').style.display = 'block';
                    toggle.checked = true;
                    log('Device status notifications enabled');
                    showNotification('ÂÆûÊó∂ÁõëÊéßÂ∑≤ÂºÄÂêØ', 'success', 2000);
                }
            } catch (error) {
                log(`Failed to toggle notifications: ${error.message}`);
                showNotification(`ÁõëÊéßÂàáÊç¢Â§±Ë¥•: ${error.message}`, 'error');
            }
        }

        // ÂêåÊ≠•Êó∂Èó¥ÂäüËÉΩ - ÂèëÈÄÅÊ†ºÂºèÔºöb1 09 year(2 byte) month day hour minute b1
        async function syncTime() {
            if (!characteristic) {
                log('Error: Device not connected');
                return;
            }

            try {
                // Ëé∑ÂèñÂΩìÂâçÊó∂Èó¥
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth() + 1; // JavaScriptÊúà‰ªΩ‰ªé0ÂºÄÂßã
                const day = now.getDate();
                const hour = now.getHours();
                const minute = now.getMinutes();

                // ÊûÑÈÄ†Êó∂Èó¥ÂêåÊ≠•Êï∞ÊçÆÂåÖÔºöb1 09 year(2 byte) month day hour minute b1
                const timePacket = new Uint8Array(9);
                timePacket[0] = 0xB1;  // Ëµ∑ÂßãÊ†áËØÜ
                timePacket[1] = 0x09;  // ÂëΩ‰ª§Á±ªÂûã - Êó∂Èó¥ÂêåÊ≠•
                timePacket[2] = (year >> 8) & 0xFF;  // Âπ¥‰ªΩÈ´òÂ≠óËäÇ
                timePacket[3] = year & 0xFF;         // Âπ¥‰ªΩ‰ΩéÂ≠óËäÇ
                timePacket[4] = month;               // Êúà‰ªΩ
                timePacket[5] = day;                 // Êó•Êúü
                timePacket[6] = hour;                // Â∞èÊó∂
                timePacket[7] = minute;              // ÂàÜÈíü
                timePacket[8] = 0xB1;  // ÁªìÊùüÊ†áËØÜ

                // ÂèëÈÄÅÊó∂Èó¥ÂêåÊ≠•Êï∞ÊçÆÂåÖ
                await characteristic.writeValue(timePacket);
                
                const timeStr = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')} ${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                const packetHex = Array.from(timePacket).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' ');
                
                                 log(`‚úì Time sync packet sent: ${timeStr}`);
                 log(`  Packet data: ${packetHex}`);
                 
             } catch (error) {
                 log(`‚úó Failed to sync time: ${error.message}`);
             }
         }

         // ËÆæÁΩÆÊ∏©Â∫¶È¢ÑËÆæ - ÂèëÈÄÅÊ†ºÂºèÔºö0xA3 + 8 + È¢ÑËÆæÁ¥¢Âºï + ÂçéÊ∞èÊ∏©Â∫¶(2Â≠óËäÇ) + ÊëÑÊ∞èÊ∏©Â∫¶(2Â≠óËäÇ) + 0xA3
         async function setTemperature(presetIndex, tempF) {
             if (!characteristic) {
                 log('Error: Device not connected');
                 return;
             }

             // È™åËØÅÊ∏©Â∫¶ËåÉÂõ¥
             const temperature = parseInt(tempF);
             if (temperature < 250 || temperature > 650) {
                 log(`Error: Temperature ${temperature}¬∞F is out of range (250-650¬∞F)`);
                 // ÊÅ¢Â§ç‰πãÂâçÁöÑÂÄº
                 document.getElementById(`tempF${presetIndex}`).value = document.getElementById(`tempF${presetIndex}`).defaultValue;
                 return;
             }

             try {
                 // ÂçéÊ∞èÂ∫¶ËΩ¨ÊëÑÊ∞èÂ∫¶ (C = (F - 32) * 5/9)
                 const tempC = Math.round((temperature - 32) * 5 / 9);

                 // ÊûÑÈÄ†Ê∏©Â∫¶ËÆæÁΩÆÊï∞ÊçÆÂåÖÔºö0xA3 + 8 + È¢ÑËÆæÁ¥¢Âºï + ÂçéÊ∞èÊ∏©Â∫¶(2Â≠óËäÇ) + ÊëÑÊ∞èÊ∏©Â∫¶(2Â≠óËäÇ) + 0xA3
                 const tempPacket = new Uint8Array(8);
                 tempPacket[0] = 0xB3;                    // Ëµ∑ÂßãÊ†áËØÜ
                 tempPacket[1] = 8;                       // Êï∞ÊçÆÈïøÂ∫¶
                 tempPacket[2] = presetIndex;             // È¢ÑËÆæÁ¥¢Âºï (1-5)
                 tempPacket[3] = (temperature >> 8) & 0xFF;  // ÂçéÊ∞èÊ∏©Â∫¶È´òÂ≠óËäÇ
                 tempPacket[4] = temperature & 0xFF;         // ÂçéÊ∞èÊ∏©Â∫¶‰ΩéÂ≠óËäÇ
                 tempPacket[5] = (tempC >> 8) & 0xFF;        // ÊëÑÊ∞èÊ∏©Â∫¶È´òÂ≠óËäÇ
                 tempPacket[6] = tempC & 0xFF;               // ÊëÑÊ∞èÊ∏©Â∫¶‰ΩéÂ≠óËäÇ
                 tempPacket[7] = 0xB3;                    // ÁªìÊùüÊ†áËØÜ

                 // ÂèëÈÄÅÊ∏©Â∫¶ËÆæÁΩÆÊï∞ÊçÆÂåÖ
                 await characteristic.writeValue(tempPacket);
                 
                 const packetHex = Array.from(tempPacket).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' ');
                 
                 log(`‚úì Temperature preset ${presetIndex} set to ${temperature}¬∞F (${tempC}¬∞C)`);
                 log(`  Packet data: ${packetHex}`);
                 
                           } catch (error) {
                  log(`‚úó Failed to set temperature: ${error.message}`);
              }
          }

          // ÈÄöÁî®B9ÂëΩ‰ª§ÂèëÈÄÅÂáΩÊï∞ - ÂèØËÆæÁΩÆ‰ªªÊÑèÂ≠óËäÇ
          async function sendB9Command(updates, description) {
              if (!characteristic) {
                  log('Error: Device not connected');
                  return;
              }

              try {
                  // Êõ¥Êñ∞Áä∂ÊÄÅ
                  for (const [bytePos, value] of Object.entries(updates)) {
                      currentB9State[bytePos] = value;
                  }

                  // ÊûÑÈÄ†B9ÂëΩ‰ª§Êï∞ÊçÆÂåÖÔºö0xB9 + ÈïøÂ∫¶(20) + Êï∞ÊçÆÂ≠óËäÇ + 0xB9
                  const command = new Uint8Array(20);
                  command[0] = 0xB9;        // Ëµ∑ÂßãÊ†áËØÜ
                  command[1] = 20;          // Êï∞ÊçÆÈïøÂ∫¶
                  command[2] = 0x00;
                  command[3] = currentB9State.byte3 || 0x01;   // È¢ÑËÆæÂÄº (1-5)
                  command[4] = 0x00;
                  command[5] = 0x00;
                  command[6] = currentB9State.byte6 || 0x00;   // LEDÂÄº
                  command[7] = 0x00;
                  command[8] = currentB9State.byte8 || 0x00;   // Auto Shut Time (0-30ÂàÜÈíü)
                  command[9] = 0x0f;
                  command[10] = currentB9State.byte10 || 0x00; // SessionÁä∂ÊÄÅ
                  command[11] = currentB9State.byte11 || 0x00;
                  command[12] = currentB9State.byte12 || 0x00; // Êú™Êù•Êâ©Â±ï
                  command[13] = currentB9State.byte13 || 0x00; // Brightness (0-100)
                  command[14] = currentB9State.byte14 || 0x00; // Êú™Êù•Êâ©Â±ï
                  command[15] = currentB9State.byte15 || 0x00; // Êú™Êù•Êâ©Â±ï
                  command[16] = currentB9State.byte16 || 0x00; // Êú™Êù•Êâ©Â±ï
                  command[17] = currentB9State.byte17 || 0x00; // Êú™Êù•Êâ©Â±ï
                  command[18] = currentB9State.byte18 || 0x00; // Êú™Êù•Êâ©Â±ï
                  command[19] = 0xB9;       // ÁªìÊùüÊ†áËØÜ

                  // ÂèëÈÄÅÂëΩ‰ª§
                  await characteristic.writeValue(command);
                  
                  const packetHex = Array.from(command).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' ');
                  
                  log(`‚úì ${description}`);
                  log(`  Packet data: ${packetHex}`);
                  
                  // ÊòæÁ§∫Êõ¥Êñ∞ÁöÑÂ≠óËäÇ
                  const updatedBytes = Object.entries(updates).map(([pos, val]) => 
                      `${pos}: 0x${val.toString(16).padStart(2, '0')}`
                  ).join(', ');
                  log(`  Updated bytes: ${updatedBytes}`);
                  
              } catch (error) {
                  log(`‚úó Failed to send B9 command (${description}): ${error.message}`);
              }
          }

          // ËÆæÁΩÆLEDÈ¢ÑËÆæ - Ë∞ÉÁî®ÈÄöÁî®B9ÂëΩ‰ª§ÂáΩÊï∞
          async function setLedPreset(ledValue) {
              // Ëß£ÊûêÂçÅÂÖ≠ËøõÂà∂ÂÄº
              const ledPreset = parseInt(ledValue, 16);
              const colorName = LED_COLORS[ledPreset] || 'Unknown';
              
              // È™åËØÅLEDÂÄºËåÉÂõ¥
              if (!(ledPreset in LED_COLORS)) {
                  log(`Error: Invalid LED color value ${ledValue}`);
                  return;
              }

              // Êõ¥Êñ∞LEDÈ¢ÑËßà
              updateLedPreview(ledPreset);

              // Ë∞ÉÁî®ÈÄöÁî®B9ÂëΩ‰ª§ÂáΩÊï∞ÔºåÂè™Êõ¥Êñ∞LEDÂÄºÔºàÁ¨¨6Â≠óËäÇÔºâ
              await sendB9Command(
                  { byte6: ledPreset },
                  `LED color set to ${colorName} (${ledValue})`
              );
              
              showNotification(`LEDÈ¢úËâ≤Â∑≤ËÆæÁΩÆ‰∏∫ ${colorName}`, 'success', 2000);
          }

          // Êõ¥Êñ∞SessionÊéßÂà∂ÊåâÈíÆÁä∂ÊÄÅÂπ∂ÊéßÂà∂ÂÖ∂‰ªñÊéß‰ª∂ÁöÑÂêØÁî®/Á¶ÅÁî®
          function updateSessionControlButton(isSessionEnabled) {
              const sessionBtn = document.getElementById('sessionControlBtn');
              
              // Ëé∑ÂèñÈúÄË¶ÅÊéßÂà∂ÁöÑÂÖÉÁ¥†
              const presetBtn = document.getElementById('presetBtn');
              const autoShutTimeInput = document.getElementById('autoShutTime');
              const holdTimeInput = document.getElementById('holdTime');
              const brightnessInput = document.getElementById('brightness');
              const ledPresetSelect = document.getElementById('ledPresetSelect');
              const modeControlBtn = document.getElementById('modeControlBtn');
              const hapticBtn = document.getElementById('hapticBtn');
              const boostBtn = document.getElementById('boostBtn');
              const cleaningAssistBtn = document.getElementById('cleaningAssistBtn');
              
              // Ê∏©Â∫¶È¢ÑËÆæËæìÂÖ•Ê°Ü
              const tempInputs = [
                  document.getElementById('tempF1'),
                  document.getElementById('tempF2'),
                  document.getElementById('tempF3'),
                  document.getElementById('tempF4'),
                  document.getElementById('tempF5')
              ];
              
              if (isSessionEnabled) {
                  // Âä†ÁÉ≠‰∏≠ÔºöÊåâÈíÆÂèòÁ∫¢Ëâ≤ÔºåÁ¶ÅÁî®ÂÖ∂‰ªñÊéß‰ª∂
                  sessionBtn.textContent = 'Stop Heating';
                  sessionBtn.style.backgroundColor = '#dc3545'; // Á∫¢Ëâ≤
                  sessionBtn.style.color = 'white';
                  
                  // Á¶ÅÁî®ÂÖ∂‰ªñÊéßÂà∂È°πÂπ∂Ê∑ªÂä†ËßÜËßâÊèêÁ§∫
                  presetBtn.disabled = true;
                  presetBtn.classList.add('heating-disabled');
                  
                  autoShutTimeInput.disabled = true;
                  autoShutTimeInput.classList.add('heating-disabled');
                  
                  holdTimeInput.disabled = true;
                  holdTimeInput.classList.add('heating-disabled');
                  
                  brightnessInput.disabled = true;
                  brightnessInput.classList.add('heating-disabled');
                  
                  ledPresetSelect.disabled = true;
                  ledPresetSelect.classList.add('heating-disabled');
                  
                  modeControlBtn.disabled = true;
                  modeControlBtn.classList.add('heating-disabled');
                  
                  hapticBtn.disabled = true;
                  hapticBtn.classList.add('heating-disabled');
                  
                  // BoostÊåâÈíÆÂú®Âä†ÁÉ≠Êó∂ÂêØÁî®
                  boostBtn.disabled = false;
                  boostBtn.classList.remove('heating-disabled');
                  
                  // CleaningAssistÊåâÈíÆÂú®Âä†ÁÉ≠Êó∂Á¶ÅÁî®
                  cleaningAssistBtn.disabled = true;
                  cleaningAssistBtn.classList.add('heating-disabled');
                  
                  // Á¶ÅÁî®ÊâÄÊúâÊ∏©Â∫¶È¢ÑËÆæËæìÂÖ•Ê°ÜÂπ∂Ê∑ªÂä†ËßÜËßâÊèêÁ§∫
                  tempInputs.forEach(input => {
                      if (input) {
                          input.disabled = true;
                          input.classList.add('heating-disabled');
                          // ‰∏∫Áà∂ÂÆπÂô®‰πüÊ∑ªÂä†Á¶ÅÁî®Á±ª
                          const container = input.closest('.preset-card');
                          if (container) container.classList.add('heating-disabled');
                      }
                  });
                  
                  // Á¶ÅÁî®presetÊéß‰ª∂
                  for (let i = 1; i <= 5; i++) {
                      const holdTimeSlider = document.getElementById(`presetHoldTime${i}`);
                      const modeSelect = document.getElementById(`presetMode${i}`);
                      if (holdTimeSlider) {
                          holdTimeSlider.disabled = true;
                          holdTimeSlider.classList.add('heating-disabled');
                      }
                      if (modeSelect) {
                          modeSelect.disabled = true;
                          modeSelect.classList.add('heating-disabled');
                      }
                  }
                  
                  
              } else {
                  // ÂÅúÊ≠¢Âä†ÁÉ≠ÔºöÊåâÈíÆÂèòÁªøËâ≤ÔºåÂêØÁî®ÂÖ∂‰ªñÊéß‰ª∂
                  sessionBtn.textContent = 'Press to Heat';
                  sessionBtn.style.backgroundColor = '#28a745'; // ÁªøËâ≤
                  sessionBtn.style.color = 'white';
                  
                  // Âè™ÊúâÂú®ËÆæÂ§áËøûÊé•Êó∂ÊâçÂêØÁî®ÂÖ∂‰ªñÊéßÂà∂È°π
                  const isConnected = !sessionBtn.disabled; // Â¶ÇÊûúsessionÊåâÈíÆÊ≤°Ë¢´Á¶ÅÁî®ÔºåËØ¥ÊòéËÆæÂ§áÂ∑≤ËøûÊé•
                  
                  if (isConnected) {
                      presetBtn.disabled = false;
                      presetBtn.classList.remove('heating-disabled');
                      
                      autoShutTimeInput.disabled = false;
                      autoShutTimeInput.classList.remove('heating-disabled');
                      
                      holdTimeInput.disabled = false;
                      holdTimeInput.classList.remove('heating-disabled');
                      
                      brightnessInput.disabled = false;
                      brightnessInput.classList.remove('heating-disabled');
                      
                      ledPresetSelect.disabled = false;
                      ledPresetSelect.classList.remove('heating-disabled');
                      
                      modeControlBtn.disabled = false;
                      modeControlBtn.classList.remove('heating-disabled');
                      
                      hapticBtn.disabled = false;
                      hapticBtn.classList.remove('heating-disabled');
                      
                      // BoostÊåâÈíÆÂú®ÈùûÂä†ÁÉ≠Êó∂Á¶ÅÁî®
                      boostBtn.disabled = true;
                      boostBtn.classList.add('heating-disabled');
                      
                      // CleaningAssistÊåâÈíÆÂú®ÈùûÂä†ÁÉ≠Êó∂ÂêØÁî®
                      cleaningAssistBtn.disabled = false;
                      cleaningAssistBtn.classList.remove('heating-disabled');
                      
                      // ÂêØÁî®ÊâÄÊúâÊ∏©Â∫¶È¢ÑËÆæËæìÂÖ•Ê°ÜÂπ∂ÁßªÈô§ËßÜËßâÊèêÁ§∫
                      tempInputs.forEach(input => {
                          if (input) {
                              input.disabled = false;
                              input.classList.remove('heating-disabled');
                              // ‰∏∫Áà∂ÂÆπÂô®‰πüÁßªÈô§Á¶ÅÁî®Á±ª
                              const container = input.closest('.preset-card');
                              if (container) container.classList.remove('heating-disabled');
                          }
                      });
                      
                      // ÂêØÁî®presetÊéß‰ª∂
                      for (let i = 1; i <= 5; i++) {
                          const holdTimeSlider = document.getElementById(`presetHoldTime${i}`);
                          const modeSelect = document.getElementById(`presetMode${i}`);
                          if (holdTimeSlider) {
                              holdTimeSlider.disabled = false;
                              holdTimeSlider.classList.remove('heating-disabled');
                          }
                          if (modeSelect) {
                              modeSelect.disabled = false;
                              modeSelect.classList.remove('heating-disabled');
                          }
                      }
                  }

              }
          }

          // ÂàáÊç¢SessionÁä∂ÊÄÅ - Ë∞ÉÁî®ÈÄöÁî®B9ÂëΩ‰ª§ÂáΩÊï∞
          async function toggleSession() {
              // Ëé∑ÂèñÂΩìÂâçÊåâÈíÆÁä∂ÊÄÅÊù•Âà§Êñ≠Ë¶ÅÊâßË°åÁöÑÊìç‰Ωú
              const sessionBtn = document.getElementById('sessionControlBtn');
              const isCurrentlyHeating = sessionBtn.textContent === 'Stop Heating';
              const newSessionState = isCurrentlyHeating ? 0x00 : 0xaa;
              const action = isCurrentlyHeating ? 'stop' : 'start';
              
              // Ë∞ÉÁî®ÈÄöÁî®B9ÂëΩ‰ª§ÂáΩÊï∞ÔºåÂè™Êõ¥Êñ∞SessionÁä∂ÊÄÅÔºàÁ¨¨10Â≠óËäÇÔºâ
              await sendB9Command(
                  { byte10: newSessionState },
                  `Session ${action} command sent`
              );
          }

          // Êõ¥Êñ∞presetÂç°ÁâáÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
          function updatePresetCardSelection(selectedPreset) {
              // ÁßªÈô§ÊâÄÊúâpresetÂç°ÁâáÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
              for (let i = 1; i <= 5; i++) {
                  const presetCard = document.querySelector(`#tempPresets .preset-card:nth-child(${i})`);
                  if (presetCard) {
                      presetCard.classList.remove('selected');
                  }
              }
              
              // ‰∏∫ÂΩìÂâçÈÄâ‰∏≠ÁöÑpresetÊ∑ªÂä†ÈÄâ‰∏≠Áä∂ÊÄÅ
              if (selectedPreset >= 1 && selectedPreset <= 5) {
                  const selectedCard = document.querySelector(`#tempPresets .preset-card:nth-child(${selectedPreset})`);
                  if (selectedCard) {
                      selectedCard.classList.add('selected');
                  }
              }
          }

          // ÂàáÊç¢È¢ÑËÆæÊå°‰Ωç - Âæ™ÁéØÂàáÊç¢1‚Üí2‚Üí3‚Üí4‚Üí5‚Üí1
          async function switchPreset() {
              // Âæ™ÁéØÂàáÊç¢È¢ÑËÆæÂÄº
              currentPreset = currentPreset >= 5 ? 1 : currentPreset + 1;
              
              // Êõ¥Êñ∞ÊåâÈíÆÊòæÁ§∫
              document.getElementById('presetBtn').textContent = currentPreset;
              
              // Êõ¥Êñ∞presetÂç°ÁâáÈÄâ‰∏≠Áä∂ÊÄÅ
              updatePresetCardSelection(currentPreset);
              
              // Êõ¥Êñ∞ÂΩìÂâçpresetÂØπÂ∫îÁöÑÊ®°ÂºèÊòæÁ§∫
              updateCurrentPresetModeDisplay(currentPreset);
              
              // Êõ¥Êñ∞CustomÈÖçÁΩÆÊòæÁ§∫
              updateCustomUI();
              
              // ÂèëÈÄÅÈ¢ÑËÆæÂàáÊç¢ÂëΩ‰ª§ - ‰ΩøÁî®B9ÂëΩ‰ª§Ê†ºÂºèÔºåÁ¨¨3Â≠óËäÇ‰∏∫È¢ÑËÆæÂÄº
              await sendB9Command(
                  { byte3: currentPreset },
                  `Preset switched to ${currentPreset}`
              );
              
              log(`‚úì Preset switched to ${currentPreset}`);
          }

          // ÈÄâÊã©ÊåáÂÆöÈ¢ÑËÆæ - ÈÄöËøáÁÇπÂáªÈ¢ÑËÆæÂç°ÁâáËß¶Âèë
          async function selectPreset(presetNumber) {
              // È™åËØÅÈ¢ÑËÆæÁºñÂè∑ËåÉÂõ¥
              if (presetNumber < 1 || presetNumber > 5) {
                  log(`Error: Invalid preset number ${presetNumber}`);
                  return;
              }
              
              // Â¶ÇÊûúÂ∑≤ÁªèÊòØÂΩìÂâçÈ¢ÑËÆæÔºåÂàô‰∏çÈúÄË¶ÅÂàáÊç¢
              if (currentPreset === presetNumber) {
                  log(`Preset ${presetNumber} is already selected`);
                  return;
              }
              
              // ËÆæÁΩÆÊñ∞ÁöÑÈ¢ÑËÆæÂÄº
              currentPreset = presetNumber;
              
              // Êõ¥Êñ∞ÊåâÈíÆÊòæÁ§∫
              document.getElementById('presetBtn').textContent = currentPreset;
              
              // Êõ¥Êñ∞presetÂç°ÁâáÈÄâ‰∏≠Áä∂ÊÄÅ
              updatePresetCardSelection(currentPreset);
              
              // Êõ¥Êñ∞ÂΩìÂâçpresetÂØπÂ∫îÁöÑÊ®°ÂºèÊòæÁ§∫
              updateCurrentPresetModeDisplay(currentPreset);
              
              // Êõ¥Êñ∞CustomÈÖçÁΩÆÊòæÁ§∫
              updateCustomUI();
              
              // ÂèëÈÄÅÈ¢ÑËÆæÂàáÊç¢ÂëΩ‰ª§ - ‰ΩøÁî®B9ÂëΩ‰ª§Ê†ºÂºèÔºåÁ¨¨3Â≠óËäÇ‰∏∫È¢ÑËÆæÂÄº
              await sendB9Command(
                  { byte3: currentPreset },
                  `Preset selected: ${currentPreset}`
              );
              
              log(`‚úì Preset ${currentPreset} selected`);
          }

          // ËÆæÁΩÆAuto Shut Time - ÂèëÈÄÅB9ÂëΩ‰ª§Á¨¨8Â≠óËäÇ
          async function setAutoShutTime(minutes) {
              // È™åËØÅÊó∂Èó¥ËåÉÂõ¥
              const autoShutTime = parseInt(minutes);
              if (autoShutTime < 0 || autoShutTime > 30) {
                  log(`Error: Auto Shut Time ${autoShutTime} is out of range (0-30 minutes)`);
                  // ÊÅ¢Â§ç‰πãÂâçÁöÑÂÄº
                  const autoShutTimeElement = document.getElementById('autoShutTime');
                  if (autoShutTimeElement) {
                      autoShutTimeElement.value = currentB9State.byte8 || 2;
                  } else {
                      console.error('autoShutTime element not found in setAutoShutTime');
                  }
                  return;
              }

              // Ë∞ÉÁî®ÈÄöÁî®B9ÂëΩ‰ª§ÂáΩÊï∞ÔºåÂè™Êõ¥Êñ∞Auto Shut TimeÔºàÁ¨¨8Â≠óËäÇÔºâ
              await sendB9Command(
                  { byte8: autoShutTime },
                  `Auto Shut Time set to ${autoShutTime} minutes`
              );
          }

          // ËÆæÁΩÆHold Time - ÂèëÈÄÅB7ÂëΩ‰ª§Ê†ºÂºèÔºöB7 06 01 holdTime(high) holdTime(low) B7
          async function setHoldTime(seconds) {
              if (!characteristic) {
                  log('Error: Device not connected');
                  return;
              }

              // È™åËØÅÊó∂Èó¥ËåÉÂõ¥
              const holdTime = parseInt(seconds);
              if (holdTime < 10 || holdTime > 90) {
                  log(`Error: Hold Time ${holdTime} is out of range (10-90 seconds)`);
                  // ÊÅ¢Â§ç‰πãÂâçÁöÑÂÄº
                  const holdTimeElement = document.getElementById('holdTime');
                  if (holdTimeElement) {
                      holdTimeElement.value = window.holdTime || 30;
                  } else {
                      console.error('holdTime element not found in setHoldTime');
                  }
                  return;
              }

              try {
                  // ÊûÑÈÄ†B7ÂëΩ‰ª§Êï∞ÊçÆÂåÖÔºöB7 06 00 holdTime(high) holdTime(low) B7 (preset 0 = ÂÖ®Â±ÄHold Time)
                  const holdTimeCommand = new Uint8Array(6);
                  holdTimeCommand[0] = 0xB7;                      // Ëµ∑ÂßãÊ†áËØÜ
                  holdTimeCommand[1] = 0x06;                      // Êï∞ÊçÆÈïøÂ∫¶
                  holdTimeCommand[2] = 0x00;                      // preset 0 (ÂÖ®Â±ÄHold Time)
                  holdTimeCommand[3] = (holdTime >> 8) & 0xFF;    // holdTimeÈ´òÂ≠óËäÇ
                  holdTimeCommand[4] = holdTime & 0xFF;           // holdTime‰ΩéÂ≠óËäÇ
                  holdTimeCommand[5] = 0xB7;                      // ÁªìÊùüÊ†áËØÜ

                  // ÂèëÈÄÅHold TimeËÆæÁΩÆÂëΩ‰ª§
                  await characteristic.writeValue(holdTimeCommand);
                  
                  const packetHex = Array.from(holdTimeCommand).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' ');
                  
                  log(`‚úì Hold Time set to ${holdTime} seconds`);
                  log(`  Packet data: ${packetHex}`);
                  
                  // Êõ¥Êñ∞ÂÖ®Â±ÄholdTimeÂèòÈáè
                  window.holdTime = holdTime;
                  
              } catch (error) {
                  log(`‚úó Failed to set Hold Time: ${error.message}`);
              }
          }

          // Êõ¥Êñ∞‰∫ÆÂ∫¶ÊòæÁ§∫ÂÄºÔºàÂÆûÊó∂Ôºâ
          function updateBrightnessDisplay(value) {
              document.getElementById('brightnessDisplay').textContent = value;
          }

          // Êõ¥Êñ∞Auto Shut TimeÊòæÁ§∫ÂÄºÔºàÂÆûÊó∂Ôºâ
          function updateAutoShutDisplay(value) {
              document.getElementById('autoShutDisplay').textContent = value + ' min';
          }

          // Êõ¥Êñ∞Hold TimeÊòæÁ§∫ÂÄºÔºàÂÆûÊó∂Ôºâ
          function updateHoldTimeDisplay(value) {
              const holdTimeDisplayElement = document.getElementById('holdTimeDisplay');
              if (holdTimeDisplayElement) {
                  holdTimeDisplayElement.textContent = value + ' sec';
              } else {
                  console.error('holdTimeDisplay element not found');
              }
          }

          // ÊªëÂùóÊãñÂä®Áä∂ÊÄÅÁÆ°ÁêÜ
          function startSliderDrag(sliderId) {
              draggingSliders.add(sliderId);
              isDraggingSlider = draggingSliders.size > 0;
              
              // Ê∏ÖÈô§‰πãÂâçÁöÑË∂ÖÊó∂
              if (sliderTimeouts[sliderId]) {
                  clearTimeout(sliderTimeouts[sliderId]);
              }
              
              // ËÆæÁΩÆË∂ÖÊó∂ÔºåÂ¶ÇÊûú3ÁßíÂÜÖÊ≤°ÊúâÊìç‰ΩúÂ∞±ÊÅ¢Â§çÊé•Êî∂Êõ¥Êñ∞
              sliderTimeouts[sliderId] = setTimeout(() => {
                  endSliderDrag(sliderId);
                  log(`Slider ${sliderId} drag timeout - resuming updates`);
              }, 3000);
              
              // log(`Started dragging slider: ${sliderId}, total dragging: ${draggingSliders.size}`);
          }

          function endSliderDrag(sliderId) {
              // Ê∏ÖÈô§Ë∂ÖÊó∂
              if (sliderTimeouts[sliderId]) {
                  clearTimeout(sliderTimeouts[sliderId]);
                  delete sliderTimeouts[sliderId];
              }
              
              // ‰ªéÊãñÂä®ÈõÜÂêà‰∏≠ÁßªÈô§
              draggingSliders.delete(sliderId);
              
              // Âª∂ËøüÊÅ¢Â§çÊõ¥Êñ∞ÔºåÁ°Æ‰øùchange‰∫ã‰ª∂ÂÆåÊàê
              setTimeout(() => {
                  isDraggingSlider = draggingSliders.size > 0;
                  // log(`Ended dragging slider: ${sliderId}, total dragging: ${draggingSliders.size}`);
              }, 100);
          }

          // ËÆæÁΩÆBrightness - ÂèëÈÄÅB9ÂëΩ‰ª§Á¨¨13Â≠óËäÇ
          async function setBrightness(brightness) {
              // È™åËØÅ‰∫ÆÂ∫¶ËåÉÂõ¥
              const brightnessValue = parseInt(brightness);
              if (brightnessValue < 0 || brightnessValue > 100) {
                  log(`Error: Brightness ${brightnessValue} is out of range (0-100)`);
                  // ÊÅ¢Â§ç‰πãÂâçÁöÑÂÄº
                  const brightnessElement = document.getElementById('brightness');
                  if (brightnessElement) {
                      brightnessElement.value = currentB9State.byte13;
                  } else {
                      console.error('brightness element not found in setBrightness');
                  }
                  updateBrightnessDisplay(currentB9State.byte13);
                  return;
              }

              // Ë∞ÉÁî®ÈÄöÁî®B9ÂëΩ‰ª§ÂáΩÊï∞ÔºåÂè™Êõ¥Êñ∞BrightnessÔºàÁ¨¨13Â≠óËäÇÔºâ
              await sendB9Command(
                  { byte13: brightnessValue },
                  `Brightness set to ${brightnessValue}`
              );
          }

          // ÂàáÊç¢Ê®°Âºè - ÂèëÈÄÅB5ÂëΩ‰ª§Ê†ºÂºèÔºöB5 05 01 mode B5
          async function switchMode() {
              if (!characteristic) {
                  log('Error: Device not connected');
                  return;
              }

              try {
                  // Âæ™ÁéØÂàáÊç¢Ê®°ÂºèÔºöSteady (A1) ‚Üí Ascent (B1) ‚Üí Descent (C1) ‚Üí Valley (D1) ‚Üí Hill (E1) ‚Üí Steady (A1)
                  let newMode;
                  switch (currentMode) {
                      case 0xA1: // Steady -> Ascent
                          newMode = 0xB1;
                          break;
                      case 0xB1: // Ascent -> Descent
                          newMode = 0xC1;
                          break;
                      case 0xC1: // Descent -> Valley
                          newMode = 0xD1;
                          break;
                      case 0xD1: // Valley -> Hill
                          newMode = 0xE1;
                          break;
                      case 0xE1: // Hill -> Steady
                          newMode = 0xA1;
                          break;
                      default: // ÈªòËÆ§‰∏∫ Steady
                          newMode = 0xA1;
                          break;
                  }

                  // ÊûÑÈÄ†B5ÂëΩ‰ª§Êï∞ÊçÆÂåÖÔºöB5 05 00 mode B5 (preset 0 = ÂÖ®Â±ÄMode Control)
                  const modeCommand = new Uint8Array(5);
                  modeCommand[0] = 0xB5;    // Ëµ∑ÂßãÊ†áËØÜ
                  modeCommand[1] = 0x05;    // Êï∞ÊçÆÈïøÂ∫¶
                  modeCommand[2] = 0x00;    // preset 0 (ÂÖ®Â±ÄMode Control)
                  modeCommand[3] = newMode; // Ê®°ÂºèÂÄº
                  modeCommand[4] = 0xB5;    // ÁªìÊùüÊ†áËØÜ

                  // ÂèëÈÄÅÊ®°ÂºèÂàáÊç¢ÂëΩ‰ª§
                  await characteristic.writeValue(modeCommand);
                  
                  const modeName = MODE_TYPES[newMode];
                  const packetHex = Array.from(modeCommand).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' ');
                  
                  log(`‚úì Mode switch command sent: ${modeName} (0x${newMode.toString(16).padStart(2, '0')})`);
                  log(`  Packet data: ${packetHex}`);
                  
                  // ‰∏¥Êó∂Êõ¥Êñ∞ÊòæÁ§∫ÔºàÁ≠âÂæÖËÆæÂ§ánotifyÁ°ÆËÆ§Ôºâ
                  updateModeDisplay(newMode, modeName);
                  currentMode = newMode;
                  
                  showNotification(`Ê®°ÂºèÂàáÊç¢‰∏∫ ${modeName}`, 'success', 2000);
                  
              } catch (error) {
                  log(`‚úó Failed to switch mode: ${error.message}`);
                  showNotification(`Ê®°ÂºèÂàáÊç¢Â§±Ë¥•: ${error.message}`, 'error');
              }
          }

          // Êõ¥Êñ∞Ê®°ÂºèÊòæÁ§∫
          function updateModeDisplay(mode, modeName) {
              const currentModeDisplayElement = document.getElementById('currentModeDisplay');
              if (currentModeDisplayElement) {
                  currentModeDisplayElement.textContent = modeName;
              } else {
                  console.error('currentModeDisplay element not found');
              }
              
              // Êõ¥Êñ∞Ê®°ÂºèÂ∫èÂàóÊòæÁ§∫ÔºåÈ´ò‰∫ÆÂΩìÂâçÊ®°Âºè
              let sequenceText = '';
              const modes = ['Steady', 'Ascent', 'Descent', 'Valley', 'Hill'];
              const currentModeName = modeName.split(' ')[0]; // ÁßªÈô§ÂèØËÉΩÁöÑ "(0x...)" ÈÉ®ÂàÜ
              
              modes.forEach((name, index) => {
                  if (name === currentModeName) {
                      sequenceText += `<strong style="color: var(--primary-color);">${name}</strong>`;
                  } else {
                      sequenceText += name;
                  }
                  
                  if (index < modes.length - 1) {
                      sequenceText += ' ‚Üí ';
                  }
              });
              
              const modeSequenceElement = document.getElementById('modeSequence');
              if (modeSequenceElement) {
                  modeSequenceElement.innerHTML = sequenceText;
              } else {
                  console.error('modeSequence element not found');
              }
          }

          // ÂàáÊç¢HapticÂèçÈ¶à - ÂèëÈÄÅB9ÂëΩ‰ª§Á¨¨11Â≠óËäÇ
          async function toggleHaptic() {
              // ÂàáÊç¢ÂΩìÂâçÁä∂ÊÄÅ
              const newHapticState = currentB9State.byte11 === 0xAA ? 0x00 : 0xAA;
              const isEnabled = newHapticState === 0xAA;
              
              // Ë∞ÉÁî®ÈÄöÁî®B9ÂëΩ‰ª§ÂáΩÊï∞ÔºåÂè™Êõ¥Êñ∞HapticÁä∂ÊÄÅÔºàÁ¨¨11Â≠óËäÇÔºâ
              await sendB9Command(
                  { byte11: newHapticState },
                  `Haptic feedback ${isEnabled ? 'enabled' : 'disabled'}`
              );
              
              // Á´ãÂç≥Êõ¥Êñ∞ÊåâÈíÆÊòæÁ§∫
              updateHapticButton(isEnabled);
              
              showNotification(`Ëß¶ËßâÂèçÈ¶àÂ∑≤${isEnabled ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠'}`, 'success', 2000);
          }

          // Session Boost - ÁÇπÂáªÂºèÊìç‰ΩúÔºöÊØèÊ¨°ÁÇπÂáªÂèëÈÄÅÈÄíÂ¢ûÁöÑÊï∞ÂÄº
          async function toggleBoost() {
              try {
                  // ÊØèÊ¨°ÁÇπÂáªÈÄíÂ¢ûbyte12ÁöÑÂÄº
                  currentB9State.byte12 += 1;
                  
                  // ÂèëÈÄÅÈÄíÂ¢ûÁöÑÂÄº
                  await sendB9Command(
                      { byte12: currentB9State.byte12 },
                      `Session boost value: ${currentB9State.byte12}`
                  );
                  
                  // Êõ¥Êñ∞ÊåâÈíÆÊòæÁ§∫ÂΩìÂâçÂÄº
                  updateBoostButton(currentB9State.byte12);
                  showNotification(`boostÂÄº: ${currentB9State.byte12}`, 'warning', 1500);
                  
              } catch (error) {
                  log(`‚úó Failed to send boost value: ${error.message}`);
                  showNotification('boostÂèëÈÄÅÂ§±Ë¥•', 'error');
              }
          }

          // Êõ¥Êñ∞HapticÊåâÈíÆÊòæÁ§∫
          function updateHapticButton(isEnabled) {
              const hapticBtn = document.getElementById('hapticBtn');
              if (isEnabled) {
                  hapticBtn.textContent = 'On';
                  hapticBtn.className = 'btn btn-success';
                  hapticBtn.style.minWidth = '80px';
                  hapticBtn.style.padding = '6px 12px';
                  hapticBtn.style.fontSize = '0.8rem';
              } else {
                  hapticBtn.textContent = 'Off';
                  hapticBtn.className = 'btn btn-secondary';
                  hapticBtn.style.minWidth = '80px';
                  hapticBtn.style.padding = '6px 12px';
                  hapticBtn.style.fontSize = '0.8rem';
              }
          }

          // Êõ¥Êñ∞BoostÊåâÈíÆÊòæÁ§∫
          function updateBoostButton(value) {
              const boostBtn = document.getElementById('boostBtn');
              if (typeof value === 'number' && value > 0) {
                  boostBtn.textContent = `Boost(${value})`;
                  boostBtn.className = 'btn btn-warning'; // ‰ΩøÁî®Ë≠¶ÂëäËâ≤Ë°®Á§∫boostÊúâÂÄº
                  boostBtn.style.minWidth = '80px';
                  boostBtn.style.padding = '6px 12px';
                  boostBtn.style.fontSize = '0.8rem';
              } else {
                  boostBtn.textContent = 'Boost';
                  boostBtn.className = 'btn btn-secondary';
                  boostBtn.style.minWidth = '80px';
                  boostBtn.style.padding = '6px 12px';
                  boostBtn.style.fontSize = '0.8rem';
              }
          }

          // ÂàáÊç¢CleaningAssistÁä∂ÊÄÅ - ÂèëÈÄÅC6ÂëΩ‰ª§Ê†ºÂºèÔºöC6 04 AA/00 C6
          async function toggleCleaningAssist() {
              if (!characteristic) {
                  log('Error: Device not connected');
                  return;
              }

              try {
                  // ÂàáÊç¢Áä∂ÊÄÅ
                  cleaningAssistEnabled = !cleaningAssistEnabled;
                  const commandValue = cleaningAssistEnabled ? 0xAA : 0x00;
                  
                  // ÊûÑÈÄ†C6ÂëΩ‰ª§Êï∞ÊçÆÂåÖÔºöC6 04 AA/00 C6
                  const cleaningCommand = new Uint8Array(4);
                  cleaningCommand[0] = 0xC6;        // Ëµ∑ÂßãÊ†áËØÜ
                  cleaningCommand[1] = 0x04;        // Êï∞ÊçÆÈïøÂ∫¶
                  cleaningCommand[2] = commandValue; // AA=ÂºÄÂêØ, 00=ÂÖ≥Èó≠
                  cleaningCommand[3] = 0xC6;        // ÁªìÊùüÊ†áËØÜ

                  // ÂèëÈÄÅÊ∏ÖÊ¥ÅÂä©ÊâãÂëΩ‰ª§
                  await characteristic.writeValue(cleaningCommand);
                  
                  const packetHex = Array.from(cleaningCommand).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' ');
                  const action = cleaningAssistEnabled ? 'enabled' : 'disabled';
                  
                  log(`‚úì Cleaning Assist ${action}`);
                  log(`  Packet data: ${packetHex}`);
                  
                  // Êõ¥Êñ∞ÊåâÈíÆÊòæÁ§∫
                  updateCleaningAssistButton(cleaningAssistEnabled);
                  
                  showNotification(`Ê∏ÖÊ¥ÅÂä©ÊâãÂ∑≤${cleaningAssistEnabled ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠'}`, 'success', 2000);
                  
              } catch (error) {
                  // ÂèëÈÄÅÂ§±Ë¥•Êó∂ÊÅ¢Â§çÁä∂ÊÄÅ
                  cleaningAssistEnabled = !cleaningAssistEnabled;
                  log(`‚úó Failed to toggle Cleaning Assist: ${error.message}`);
                  showNotification(`Ê∏ÖÊ¥ÅÂä©ÊâãÊìç‰ΩúÂ§±Ë¥•: ${error.message}`, 'error');
              }
          }

          // Êõ¥Êñ∞CleaningAssistÊåâÈíÆÊòæÁ§∫
          function updateCleaningAssistButton(isEnabled) {
              const cleaningBtn = document.getElementById('cleaningAssistBtn');
              if (isEnabled) {
                  cleaningBtn.textContent = 'Stop Cleaning';
                  cleaningBtn.className = 'btn btn-warning';
                  cleaningBtn.style.minWidth = '150px';
                  // Êõ¥Êñ∞ÂõæÊ†á
                  cleaningBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Cleaning';
              } else {
                  cleaningBtn.textContent = 'Cleaning Assist';
                  cleaningBtn.className = 'btn btn-secondary';
                  cleaningBtn.style.minWidth = '150px';
                  // Êõ¥Êñ∞ÂõæÊ†á
                  cleaningBtn.innerHTML = '<i class="fas fa-broom"></i> Cleaning Assist';
              }
          }

          // Êõ¥Êñ∞ÂΩìÂâçpresetÂØπÂ∫îÁöÑÊ®°ÂºèÊòæÁ§∫
          function updateCurrentPresetModeDisplay(preset) {
              const currentPresetModeElement = document.getElementById('currentPresetMode');
              if (currentPresetModeElement && preset >= 1 && preset <= 5) {
                  const presetMode = presetModes[preset];
                  const modeName = MODE_TYPES[presetMode] || 'Unknown';
                  currentPresetModeElement.textContent = modeName;
              }
          }

          // ==================== Preset Hold Time ÊéßÂà∂ ====================
          
          // Êõ¥Êñ∞Preset Hold TimeÊòæÁ§∫ÂÄºÔºàÂÆûÊó∂Ôºâ
          function updatePresetHoldTimeDisplay(preset, value) {
              document.getElementById(`presetHoldTimeDisplay${preset}`).textContent = value + 's';
          }

          // ËÆæÁΩÆPreset Hold Time - ÂèëÈÄÅB7ÂëΩ‰ª§Ê†ºÂºèÔºöB7 06 preset time_high time_low B7
          async function setPresetHoldTime(preset, seconds) {
              if (!characteristic) {
                  log('Error: Device not connected');
                  return;
              }

              // È™åËØÅÊó∂Èó¥ËåÉÂõ¥
              const holdTime = parseInt(seconds);
              if (holdTime < 10 || holdTime > 90) {
                  log(`Error: Preset ${preset} Hold Time ${holdTime} is out of range (10-90 seconds)`);
                  // ÊÅ¢Â§ç‰πãÂâçÁöÑÂÄº
                  document.getElementById(`presetHoldTime${preset}`).value = presetHoldTimes[preset];
                  updatePresetHoldTimeDisplay(preset, presetHoldTimes[preset]);
                  return;
              }

              try {
                  // ÊûÑÈÄ†B7ÂëΩ‰ª§Êï∞ÊçÆÂåÖÔºöB7 06 preset holdTime(high) holdTime(low) B7
                  const holdTimeCommand = new Uint8Array(6);
                  holdTimeCommand[0] = 0xB7;                      // Ëµ∑ÂßãÊ†áËØÜ
                  holdTimeCommand[1] = 0x06;                      // Êï∞ÊçÆÈïøÂ∫¶
                  holdTimeCommand[2] = preset;                    // preset (1-5)
                  holdTimeCommand[3] = (holdTime >> 8) & 0xFF;    // holdTimeÈ´òÂ≠óËäÇ
                  holdTimeCommand[4] = holdTime & 0xFF;           // holdTime‰ΩéÂ≠óËäÇ
                  holdTimeCommand[5] = 0xB7;                      // ÁªìÊùüÊ†áËØÜ

                  // ÂèëÈÄÅPreset Hold TimeËÆæÁΩÆÂëΩ‰ª§
                  await characteristic.writeValue(holdTimeCommand);
                  
                  const packetHex = Array.from(holdTimeCommand).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' ');
                  
                  log(`‚úì Preset ${preset} Hold Time set to ${holdTime} seconds`);
                  log(`  Packet data: ${packetHex}`);
                  
                  // Êõ¥Êñ∞Êú¨Âú∞Â≠òÂÇ®
                  presetHoldTimes[preset] = holdTime;
                  
                  showNotification(`È¢ÑËÆæ${preset}‰øùÊåÅÊó∂Èó¥ËÆæÁΩÆ‰∏∫${holdTime}Áßí`, 'success', 2000);
                  
              } catch (error) {
                  log(`‚úó Failed to set Preset ${preset} Hold Time: ${error.message}`);
                  showNotification(`È¢ÑËÆæ${preset}‰øùÊåÅÊó∂Èó¥ËÆæÁΩÆÂ§±Ë¥•: ${error.message}`, 'error');
              }
          }

          // ==================== Preset Mode ÊéßÂà∂ ====================
          
          // Ëé∑ÂèñCustom setting‰∏≠ÊúÄÂêé‰∏Ä‰∏™Èùû0ÁÇπÁöÑÊó∂Èó¥ÂÄº
          function getLastNonZeroTimeFromCustom() {
              const timeInputs = document.querySelectorAll('#customConfigCard .custom-time');
              let lastNonZeroTime = 30; // ÈªòËÆ§ÂÄº
              
              // ‰ªéÂêéÂæÄÂâçÊü•ÊâæÊúÄÂêé‰∏Ä‰∏™Èùû0ÁöÑÊó∂Èó¥ÂÄº
              for (let i = timeInputs.length - 1; i >= 1; i--) { // ‰ªépoint8Âà∞point2
                  const timeValue = parseInt(timeInputs[i].value) || 0;
                  if (timeValue > 0) {
                      lastNonZeroTime = timeValue;
                      break;
                  }
              }
              
              return lastNonZeroTime;
          }

          // ËÆæÁΩÆPreset Mode - ÂèëÈÄÅB5ÂëΩ‰ª§Ê†ºÂºèÔºöB5 05 preset mode B5
          async function setPresetMode(preset, modeValue) {
              if (!characteristic) {
                  log('Error: Device not connected');
                  return;
              }

              try {
                  // Ëß£ÊûêÂçÅÂÖ≠ËøõÂà∂Ê®°ÂºèÂÄº
                  const mode = parseInt(modeValue, 16);
                  const modeName = MODE_TYPES[mode] || 'Unknown';
                  
                  // È™åËØÅÊ®°ÂºèÂÄº
                  if (!(mode in MODE_TYPES)) {
                      log(`Error: Invalid mode value ${modeValue} for preset ${preset}`);
                      return;
                  }

                  // Â¶ÇÊûúÊ®°ÂºèÊòØCustom(0xF1)ÔºåËá™Âä®ËÆæÁΩÆHold Time‰∏∫Custom setting‰∏≠ÊúÄÂêé‰∏Ä‰∏™Èùû0ÁÇπÁöÑÊó∂Èó¥ÂÄº
                //   if (mode === 0xF1) {
                //       const customHoldTime = getLastNonZeroTimeFromCustom();
                      
                //       // Êõ¥Êñ∞UIÊªëÂùó
                //       const holdTimeSlider = document.getElementById(`presetHoldTime${preset}`);
                //       if (holdTimeSlider) {
                //           holdTimeSlider.value = customHoldTime;
                //           updatePresetHoldTimeDisplay(preset, customHoldTime);
                //           presetHoldTimes[preset] = customHoldTime;
                //       }
                      
                //       // ÂèëÈÄÅHold TimeËÆæÁΩÆÂëΩ‰ª§
                //       await setPresetHoldTime(preset, customHoldTime);
                      
                //       log(`‚úì Auto-set Preset ${preset} Hold Time to ${customHoldTime}s (last non-zero custom time)`);
                //       showNotification(`È¢ÑËÆæ${preset}‰øùÊåÅÊó∂Èó¥Ëá™Âä®ËÆæÁΩÆ‰∏∫${customHoldTime}ÁßíÔºàÂü∫‰∫éCustomÈÖçÁΩÆÔºâ`, 'info', 3000);
                //   }

                  // ÊûÑÈÄ†B5ÂëΩ‰ª§Êï∞ÊçÆÂåÖÔºöB5 05 preset mode B5
                  const modeCommand = new Uint8Array(5);
                  modeCommand[0] = 0xB5;    // Ëµ∑ÂßãÊ†áËØÜ
                  modeCommand[1] = 0x05;    // Êï∞ÊçÆÈïøÂ∫¶
                  modeCommand[2] = preset;  // preset (1-5)
                  modeCommand[3] = mode;    // Ê®°ÂºèÂÄº
                  modeCommand[4] = 0xB5;    // ÁªìÊùüÊ†áËØÜ

                  // ÂèëÈÄÅPreset ModeËÆæÁΩÆÂëΩ‰ª§
                  await characteristic.writeValue(modeCommand);
                  
                  const packetHex = Array.from(modeCommand).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' ');
                  
                  log(`‚úì Preset ${preset} Mode set to ${modeName} (${modeValue})`);
                  log(`  Packet data: ${packetHex}`);
                  
                  // Êõ¥Êñ∞Êú¨Âú∞Â≠òÂÇ®
                  presetModes[preset] = mode;
                  
                  showNotification(`È¢ÑËÆæ${preset}Ê®°ÂºèËÆæÁΩÆ‰∏∫${modeName}`, 'success', 2000);
                  
              } catch (error) {
                  log(`‚úó Failed to set Preset ${preset} Mode: ${error.message}`);
                  showNotification(`È¢ÑËÆæ${preset}Ê®°ÂºèËÆæÁΩÆÂ§±Ë¥•: ${error.message}`, 'error');
              }
          }

          // ==================== Êï∞ÊçÆÊé•Êî∂Â§ÑÁêÜ ====================
          
          // Â§ÑÁêÜA7Ê†ºÂºèÁöÑPreset Hold TimeÂìçÂ∫îÊï∞ÊçÆÂåÖ
          function handlePresetHoldTimeData(data) {
              if (data.length !== 6 || data[0] !== 0xA7 || data[5] !== 0xA7) {
                  log(`Invalid A7 preset hold time packet format`);
                  return;
              }
              
              const preset = data[2];
              const holdTime = (data[3] << 8) | data[4];
              
              // È™åËØÅpresetËåÉÂõ¥
              if (preset < 1 || preset > 5) {
                  log(`Invalid preset index in A7 packet: ${preset}`);
                  return;
              }
              
              // Êõ¥Êñ∞Êú¨Âú∞Â≠òÂÇ®ÂíåUIÔºàÂè™Âú®‰∏çÊãñÂä®Êó∂Êõ¥Êñ∞Ôºâ
              presetHoldTimes[preset] = holdTime;
              if (!draggingSliders.has(`presetHoldTime${preset}`)) {
                  document.getElementById(`presetHoldTime${preset}`).value = holdTime;
                  updatePresetHoldTimeDisplay(preset, holdTime);
              }
              
              log(`Received preset ${preset} hold time: ${holdTime} seconds`);
          }

          // Â§ÑÁêÜA5Ê†ºÂºèÁöÑPreset ModeÂìçÂ∫îÊï∞ÊçÆÂåÖ
          function handlePresetModeData(data) {
              if (data.length !== 5 || data[0] !== 0xA5 || data[4] !== 0xA5) {
                  log(`Invalid A5 preset mode packet format`);
                  return;
              }
              
              const preset = data[2];
              const mode = data[3];
              const modeName = MODE_TYPES[mode] || `Unknown (0x${mode.toString(16).padStart(2, '0')})`;
              
              // È™åËØÅpresetËåÉÂõ¥
              if (preset < 1 || preset > 5) {
                  log(`Invalid preset index in A5 packet: ${preset}`);
                  return;
              }
              
              // Êõ¥Êñ∞Êú¨Âú∞Â≠òÂÇ®ÂíåUI
              presetModes[preset] = mode;
              const selectElement = document.getElementById(`presetMode${preset}`);
              if (selectElement) {
                  const hexValue = '0x' + mode.toString(16).padStart(2, '0').toUpperCase();
                  selectElement.value = hexValue;
              }
              
              // Â¶ÇÊûúËøôÊòØÂΩìÂâçÊ¥ªÂä®ÁöÑpresetÔºåÊõ¥Êñ∞Áä∂ÊÄÅÁõëÊéß‰∏≠ÁöÑÊòæÁ§∫
              if (preset === currentPreset) {
                  updateCurrentPresetModeDisplay(preset);
              }
              
              log(`Received preset ${preset} mode: ${modeName} (0x${mode.toString(16).padStart(2, '0')})`);
          }

        // Ê£ÄÊü•Âõ∫‰ª∂ÁâàÊú¨Âπ∂ËøîÂõûÁä∂ÊÄÅ
        function checkFirmwareVersion(softwareRevision) {
            if (!softwareRevision || softwareRevision === '--') {
                return { needsUpdate: false, statusText: 'Unknown version', isHighlight: false };
            }

            // Ëß£ÊûêËΩØ‰ª∂ÁâàÊú¨Ê†ºÂºèÔºöSW2-YYMMDD-XXX
            const versionMatch = softwareRevision.match(/SW2-(\d{6})/);
            if (!versionMatch) {
                return { needsUpdate: false, statusText: 'Unknown format', isHighlight: false };
            }

            const currentDate = versionMatch[1]; // YYMMDDÊ†ºÂºè
            const targetDate = TARGET_FIRMWARE_DATE; // SW2-250716

            if (currentDate < targetDate) {
                return { 
                    needsUpdate: true, 
                    statusText: 'New firmware available', 
                    isHighlight: true 
                };
            } else if (currentDate === targetDate) {
                return { 
                    needsUpdate: false, 
                    statusText: 'Newest firmware', 
                    isHighlight: false 
                };
            } else {
                return { 
                    needsUpdate: false, 
                    statusText: 'Newer than target', 
                    isHighlight: false 
                };
            }
        }

        // Êõ¥Êñ∞Âõ∫‰ª∂Áä∂ÊÄÅÊòæÁ§∫
        function updateFirmwareStatus(softwareRevision) {
            const statusContainer = document.getElementById('firmwareStatusContainer');
            const statusText = document.getElementById('firmwareStatusText');
            const updateBtn = document.getElementById('updateFirmwareBtn');

            const firmwareStatus = checkFirmwareVersion(softwareRevision);

            if (firmwareStatus.statusText !== 'Unknown version') {
                statusContainer.style.display = 'block';
                statusText.textContent = firmwareStatus.statusText;

                if (firmwareStatus.isHighlight) {
                    // È´ò‰∫ÆÊòæÁ§∫ÔºöÊ©ôËâ≤ËÉåÊôØ
                    statusText.style.color = '#ff6b35';
                    statusText.style.backgroundColor = 'rgba(255, 107, 53, 0.1)';
                    statusText.style.padding = '2px 6px';
                    statusText.style.borderRadius = '4px';
                    statusText.style.border = '1px solid rgba(255, 107, 53, 0.3)';
                    
                    // ÊåâÈíÆ‰πüÈ´ò‰∫Æ
                    updateBtn.classList.remove('btn-warning');
                    updateBtn.classList.add('btn-danger');
                    updateBtn.style.animation = 'pulse 2s infinite';
                } else {
                    // ÊôÆÈÄöÊòæÁ§∫ÔºöÁªøËâ≤
                    statusText.style.color = '#28a745';
                    statusText.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
                    statusText.style.padding = '2px 6px';
                    statusText.style.borderRadius = '4px';
                    statusText.style.border = '1px solid rgba(40, 167, 69, 0.3)';
                    
                    // ÊåâÈíÆÊôÆÈÄöÊ†∑Âºè
                    updateBtn.classList.remove('btn-danger');
                    updateBtn.classList.add('btn-warning');
                    updateBtn.style.animation = 'none';
                }
            } else {
                statusContainer.style.display = 'none';
            }

            log(`Firmware status: ${firmwareStatus.statusText} (Highlight: ${firmwareStatus.isHighlight})`);
        }

        // Âè™ËØªÂèñsoftware revision„ÄÅmanufacturerÂíåhardware version
        async function readSoftwareAndManufacturer(server) {
            let softwareRevision = '--';
            let manufacturerName = '--';
            let hardwareVersion = '--';
            try {
                const deviceInfoService = await server.getPrimaryService(DEVICE_INFO_SERVICE_UUID);
                // Software Revision
                try {
                    const swCharacteristic = await deviceInfoService.getCharacteristic(SOFTWARE_REVISION_UUID);
                    const swValue = await swCharacteristic.readValue();
                    softwareRevision = new TextDecoder().decode(swValue);
                    log(`Software Revision: ${softwareRevision}`);
                } catch (error) {
                    log(`Failed to read Software Revision: ${error.message}`);
                }
                // Manufacturer Name
                try {
                    const mfgCharacteristic = await deviceInfoService.getCharacteristic(MANUFACTURER_NAME_UUID);
                    const mfgValue = await mfgCharacteristic.readValue();
                    manufacturerName = new TextDecoder().decode(mfgValue);
                    log(`Manufacturer Name: ${manufacturerName}`);
                } catch (error) {
                    log(`Failed to read Manufacturer Name: ${error.message}`);
                }
                // Hardware Version
                try {
                    const hwCharacteristic = await deviceInfoService.getCharacteristic(HARDWARE_VERSION_UUID);
                    const hwValue = await hwCharacteristic.readValue();
                    hardwareVersion = new TextDecoder().decode(hwValue);
                    log(`Hardware Version: ${hardwareVersion}`);
                } catch (error) {
                    log(`Failed to read Hardware Version: ${error.message}`);
                }
            } catch (error) {
                log(`Failed to get Device Info Service: ${error.message}`);
            }
            // Êõ¥Êñ∞UI
            document.getElementById('softwareRevision').textContent = softwareRevision || '--';
            document.getElementById('manufacturerName').textContent = manufacturerName || '--';
            document.getElementById('hardwareVersion').textContent = hardwareVersion || '--';
            
            // Ê£ÄÊü•Âπ∂Êõ¥Êñ∞Âõ∫‰ª∂Áä∂ÊÄÅ
            updateFirmwareStatus(softwareRevision);
        }

        // ========== CustomÂèÇÊï∞ÈÖçÁΩÆÁõ∏ÂÖ≥ ==========
         
          // ‰ªéUIËé∑ÂèñËá™ÂÆö‰πâÊõ≤Á∫øÊï∞ÊçÆ
          function getCustomProfileFromUI() {
              const tempInputs = document.querySelectorAll('#customConfigCard .custom-temp');
              const timeInputs = document.querySelectorAll('#customConfigCard .custom-time');
              const profile = { temp: [], time: [] };
              for (let i = 0; i < 10; i++) { // Êâ©Â±ïÂà∞10‰∏™ÁÇπ
                  profile.temp.push(parseInt(tempInputs[i].value) || 0);
                  profile.time.push(parseInt(timeInputs[i].value) || 0);
              }
              return profile;
          }

          // ÂèëÈÄÅËá™ÂÆö‰πâÊõ≤Á∫ø
          async function sendCustomProfile() {
             if (!characteristic) {
                 log('Error: Device not connected');
                 showNotification('ËÆæÂ§áÊú™ËøûÊé•', 'error');
                 return;
             }
              
             // ‰øùÂ≠òÂΩìÂâçUIÊï∞ÊçÆÂà∞ÂΩìÂâçpreset
             saveCurrentCustomUI();
             
             // ‰ΩøÁî®ÂΩìÂâçpresetÁöÑÊï∞ÊçÆÔºà‰ªécustomSettingsËé∑ÂèñÔºâ
             const currentPresetData = customSettings[currentPreset] || { temps: [400, 410, 420, 430, 440, 450, 460, 470, 480, 490], times: [0, 20, 30, 40, 50, 60, 70, 80, 90, 100] };
             
             // ÁªÑÂåÖÂπ∂ÂèëÈÄÅ‰∏âÂåÖÔºàba/bb/bcÂ§¥Â∞æÔºâÔºåÂåÖÂê´preset‰ø°ÊÅØÔºåÊîØÊåÅ10‰∏™ÁÇπ
             for (let index = 0; index < 3; index++) {
                 let ble_tx_buff = new Uint8Array(16); // Â¢ûÂä†‰∏Ä‰∏™Â≠óËäÇÁî®‰∫épreset
                 let ble_tx_len = 16;
                 if (index === 0) {
                     ble_tx_buff[0] = 0xba;
                     ble_tx_buff[1] = ble_tx_len;
                     ble_tx_buff[2] = currentPreset; // ‰ΩøÁî®Temperature PresetsÁöÑpresetÂÄº
                     ble_tx_buff[3] = currentPresetData.temps[0] >> 8;
                     ble_tx_buff[4] = currentPresetData.temps[0] & 0xff;
                     ble_tx_buff[5] = currentPresetData.times[0];
                     ble_tx_buff[6] = currentPresetData.temps[1] >> 8;
                     ble_tx_buff[7] = currentPresetData.temps[1] & 0xff;
                     ble_tx_buff[8] = currentPresetData.times[1];
                     ble_tx_buff[9] = currentPresetData.temps[2] >> 8;
                     ble_tx_buff[10] = currentPresetData.temps[2] & 0xff;
                     ble_tx_buff[11] = currentPresetData.times[2];
                     ble_tx_buff[12] = currentPresetData.temps[3] >> 8;
                     ble_tx_buff[13] = currentPresetData.temps[3] & 0xff;
                     ble_tx_buff[14] = currentPresetData.times[3];
                     ble_tx_buff[15] = 0xba;
                 } else if (index === 1) {
                     ble_tx_buff[0] = 0xbb;
                     ble_tx_buff[1] = ble_tx_len;
                     ble_tx_buff[2] = currentPreset; // ‰ΩøÁî®Temperature PresetsÁöÑpresetÂÄº
                     ble_tx_buff[3] = currentPresetData.temps[4] >> 8;
                     ble_tx_buff[4] = currentPresetData.temps[4] & 0xff;
                     ble_tx_buff[5] = currentPresetData.times[4];
                     ble_tx_buff[6] = currentPresetData.temps[5] >> 8;
                     ble_tx_buff[7] = currentPresetData.temps[5] & 0xff;
                     ble_tx_buff[8] = currentPresetData.times[5];
                     ble_tx_buff[9] = currentPresetData.temps[6] >> 8;
                     ble_tx_buff[10] = currentPresetData.temps[6] & 0xff;
                     ble_tx_buff[11] = currentPresetData.times[6];
                     ble_tx_buff[12] = currentPresetData.temps[7] >> 8;
                     ble_tx_buff[13] = currentPresetData.temps[7] & 0xff;
                     ble_tx_buff[14] = currentPresetData.times[7];
                     ble_tx_buff[15] = 0xbb;
                 } else {
                     // Á¨¨‰∏â‰∏™ÂåÖ (0xbc) - point9Âíåpoint10
                     ble_tx_buff[0] = 0xbc;
                     ble_tx_buff[1] = ble_tx_len;
                     ble_tx_buff[2] = currentPreset; // ‰ΩøÁî®Temperature PresetsÁöÑpresetÂÄº
                     ble_tx_buff[3] = currentPresetData.temps[8] >> 8;
                     ble_tx_buff[4] = currentPresetData.temps[8] & 0xff;
                     ble_tx_buff[5] = currentPresetData.times[8];
                     ble_tx_buff[6] = currentPresetData.temps[9] >> 8;
                     ble_tx_buff[7] = currentPresetData.temps[9] & 0xff;
                     ble_tx_buff[8] = currentPresetData.times[9];
                     // Ââ©‰ΩôÂ≠óËäÇÂ°´ÂÖÖ0Êàñ‰øùÁïô
                     ble_tx_buff[9] = 0x00;
                     ble_tx_buff[10] = 0x00;
                     ble_tx_buff[11] = 0x00;
                     ble_tx_buff[12] = 0x00;
                     ble_tx_buff[13] = 0x00;
                     ble_tx_buff[14] = 0x00;
                     ble_tx_buff[15] = 0xbc;
                 }
                 try {
                     // Â¶ÇÊûú‰∏çÊòØÁ¨¨‰∏Ä‰∏™ÂåÖÔºåÊ∑ªÂä†Âª∂ËøüÈÅøÂÖçGATTÊìç‰ΩúÂÜ≤Á™Å
                     if (index > 0) {
                         await new Promise(resolve => setTimeout(resolve, 100));
                     }
                     
                     await characteristic.writeValue(ble_tx_buff);
                     const packetType = index === 0 ? 'ba' : index === 1 ? 'bb' : 'bc';
                     log(`‚úì Custom Preset ${currentPreset} ÂèÇÊï∞ÂåÖ${index+1}Â∑≤ÂèëÈÄÅ(${packetType}): [${Array.from(ble_tx_buff).map(b=>b.toString(16).padStart(2,'0')).join(' ')}]`);
                 
                                        // 1. Ëé∑Âèñpoint1-8ÁöÑÊúÄÂ§ßÊó∂Èó¥ÂÄº
                        const timeInputs = document.querySelectorAll('#customConfigCard .custom-time');
                        let maxCustomTime = 0;
                        for (let i = 0; i < timeInputs.length; i++) {
                            const t = parseInt(timeInputs[i].value) || 0;
                            if (t > maxCustomTime) maxCustomTime = t;
                        }
                        // 2. ÈÅçÂéÜpreset1-5ÔºåËÆæÁΩÆ‰∏∫CustomÊ®°ÂºèÁöÑhold time
                        // for (let i = 1; i <= 5; i++) {
                        //     const modeSelect = document.getElementById(`presetMode${i}`);
                        //     if (modeSelect && modeSelect.value === '0xF1') {
                        //         // ‰øÆÊîπÊªëÂùóUI
                        //         const holdTimeSlider = document.getElementById(`presetHoldTime${i}`);
                        //         if (holdTimeSlider) {
                        //             holdTimeSlider.value = maxCustomTime;
                        //             // ÂèØÈÄâÔºöÂêåÊ≠•ÊòæÁ§∫
                        //             if (typeof updatePresetHoldTimeDisplay === 'function') {
                        //                 updatePresetHoldTimeDisplay(i, maxCustomTime);
                        //             }
                        //         }
                        //         // ÂèëÈÄÅËìùÁâôÂëΩ‰ª§
                        //         if (typeof setPresetHoldTime === 'function') {
                        //             setPresetHoldTime(i, maxCustomTime);
                        //         }
                        //     }
                        // }      
                        // showNotification(`Â∑≤ÂêåÊ≠•CustomÊ®°ÂºèÁöÑHold Time‰∏∫${maxCustomTime}Áßí`, 'info', 2000);           
                    } catch (e) {
                     log(`‚úó CustomÂèÇÊï∞ÂåÖ${index+1}ÂèëÈÄÅÂ§±Ë¥•: ${e.message}`);
                     showNotification(`Ëá™ÂÆö‰πâÂèÇÊï∞ÂåÖ${index+1}ÂèëÈÄÅÂ§±Ë¥•`, 'error');
                     return;
                 }


             }
             showNotification(`Custom Preset ${currentPreset} ÂèÇÊï∞ÂÖ®ÈÉ®ÂèëÈÄÅÊàêÂäü`, 'success');
          }
          
          // ÁªëÂÆöÊåâÈíÆ‰∫ã‰ª∂
          document.getElementById('sendCustomProfileBtn').onclick = sendCustomProfile;
          
          // Êñ∞Â¢ûÔºöËá™ÂÆö‰πâÂèÇÊï∞ÂåÖËß£Êûê (ÊîØÊåÅ10‰∏™ÁÇπ)
          function handleCustomProfileData(data) {
              let group;
              if (data[0] === 0xaa) group = 0;      // Á¨¨‰∏ÄÂåÖÔºöpoint1-4
              else if (data[0] === 0xab) group = 1; // Á¨¨‰∫åÂåÖÔºöpoint5-8
              else if (data[0] === 0xac) group = 2; // Á¨¨‰∏âÂåÖÔºöpoint9-10
              else return; // Êú™Áü•ÂåÖÁ±ªÂûã
              
              let preset = data[2]; // Êñ∞Â¢ûÔºöËØªÂèñpreset‰ø°ÊÅØ
              let temps = [];
              let times = [];
              
              // Êï∞ÊçÆ‰ªédata[3]ÂºÄÂßãËØªÂèñ
              if (group === 2) {
                  // Á¨¨‰∏âÂåÖÂè™Êúâ2‰∏™ÁÇπÁöÑÊï∞ÊçÆ
                  for(let i=0; i<2; i++) {
                      let temp = (data[3+i*3] << 8) | data[4+i*3];
                      let time = data[5+i*3];
                      temps.push(temp);
                      times.push(time);
                  }
              } else {
                  // Ââç‰∏§ÂåÖÂêÑÊúâ4‰∏™ÁÇπÁöÑÊï∞ÊçÆ
                  for(let i=0; i<4; i++) {
                      let temp = (data[3+i*3] << 8) | data[4+i*3];
                      let time = data[5+i*3];
                      temps.push(temp);
                      times.push(time);
                  }
              }
              
              // È™åËØÅpresetËåÉÂõ¥
              if (preset >= 1 && preset <= 5) {
                  // Â≠òÂÇ®Âà∞ÂØπÂ∫îÁöÑpreset‰∏≠
                  if (!customSettings[preset]) {
                      customSettings[preset] = { temps: [], times: [] };
                  }
                  
                  // Êõ¥Êñ∞Â≠òÂÇ®ÁöÑÊï∞ÊçÆ
                  const pointCount = group === 2 ? 2 : 4;
                  for(let i=0; i<pointCount; i++) {
                      let idx = group*4 + i;
                      if (idx < 10) { // Êâ©Â±ïÂà∞10‰∏™ÁÇπ
                          customSettings[preset].temps[idx] = temps[i];
                          customSettings[preset].times[idx] = times[i];
                      }
                  }
                  
                  // ÊâìÂç∞ÂèòÂåñ
                  logCustomSettingsChange(preset, '‰ªéËÆæÂ§áÊé•Êî∂Êõ¥Êñ∞', `ÂåÖ${group+1}`);
                  
                  // Â¶ÇÊûúÂΩìÂâçÊòæÁ§∫ÁöÑpreset‰∏éÊé•Êî∂Âà∞ÁöÑpresetÁõ∏ÂêåÔºåÂàôÊõ¥Êñ∞UI
                  if (currentPreset === preset) {
                      updateCustomUI();
                  }
                  
                  log(`Êî∂Âà∞Ëá™ÂÆö‰πâÂèÇÊï∞ÂåÖ${group+1} (Preset ${preset})ÔºöÊ∏©Â∫¶=[${temps.join(', ')}]ÔºåÊó∂Èó¥=[${temps.join(', ')}]`);
                  showNotification(`Êî∂Âà∞Preset ${preset}Ëá™ÂÆö‰πâÂèÇÊï∞ÂåÖ${group+1}Â∑≤ÂêåÊ≠•`,'info');
              } else {
                  log(`Êî∂Âà∞Êó†ÊïàÁöÑpresetÂÄº: ${preset}`);
                  showNotification(`Êî∂Âà∞Êó†ÊïàÁöÑpresetÂÄº: ${preset}`, 'error');
               }
           }
           
           // ÂàáÊç¢custom presetÔºà‰∏éTemperature PresetsÂêåÊ≠•Ôºâ
           function switchCustomPreset(preset) {
               preset = parseInt(preset);
               if (preset >= 1 && preset <= 5) {
                   // ‰øùÂ≠òÂΩìÂâçUIÊï∞ÊçÆÂà∞ÂΩìÂâçpreset
                   saveCurrentCustomUI();
                   
                   // ÂàáÊç¢Âà∞Êñ∞presetÔºà‰ΩøÁî®currentPresetÂèòÈáèÔºâ
                   currentPreset = preset;
                   
                   // Êõ¥Êñ∞UIÊòæÁ§∫
                   updateCustomUI();
                   
                   // ÂêåÊ≠•Temperature PresetsÁöÑÈÄâÊã©
                   updatePresetCardSelection(preset);
                   
                   log(`ÂàáÊç¢Âà∞Custom Preset ${preset}`);
                   showNotification(`Â∑≤ÂàáÊç¢Âà∞Custom Preset ${preset}`, 'info');
               }
           }
           
           // ‰øùÂ≠òÂΩìÂâçUIÊï∞ÊçÆÂà∞ÂΩìÂâçpreset
           function saveCurrentCustomUI() {
               const tempInputs = document.querySelectorAll('#customConfigCard .custom-temp');
               const timeInputs = document.querySelectorAll('#customConfigCard .custom-time');
               
               if (!customSettings[currentPreset]) {
                   customSettings[currentPreset] = { temps: [], times: [] };
               }
               
               for (let i = 0; i < 10; i++) { // Êâ©Â±ïÂà∞10‰∏™ÁÇπ
                   if (tempInputs[i]) {
                       customSettings[currentPreset].temps[i] = parseInt(tempInputs[i].value);
                   }
                   if (timeInputs[i]) {
                       customSettings[currentPreset].times[i] = parseInt(timeInputs[i].value) || 0;
                   }
               }
               
               // ÊâìÂç∞ÂèòÂåñ
               logCustomSettingsChange(currentPreset, 'Áî®Êà∑ÊâãÂä®‰øùÂ≠ò', '‰ªéUIËæìÂÖ•');
           }
           
           // Êõ¥Êñ∞UIÊòæÁ§∫ÂΩìÂâçpresetÁöÑÊï∞ÊçÆ
           function updateCustomUI() {
               const tempInputs = document.querySelectorAll('#customConfigCard .custom-temp');
               const timeInputs = document.querySelectorAll('#customConfigCard .custom-time');
               
               if (customSettings[currentPreset]) {
                   for (let i = 0; i < 10; i++) { // Êâ©Â±ïÂà∞10‰∏™ÁÇπ
                       if (tempInputs[i] && customSettings[currentPreset].temps[i] !== undefined) {
                           tempInputs[i].value = customSettings[currentPreset].temps[i];
                       }
                       if (timeInputs[i] && customSettings[currentPreset].times[i] !== undefined) {
                           // point1ÁöÑÊó∂Èó¥Âõ∫ÂÆö‰∏∫0Ôºå‰∏çÊõ¥Êñ∞
                           if (i !== 0) {
                               timeInputs[i].value = customSettings[currentPreset].times[i];
                           }
                       }
                   }
               }
           }

          // Êñ∞Â¢ûÔºöÂ§ÑÁêÜÊù•Ëá™ËÆæÂ§áÁöÑÈ¢úËâ≤ÁÇπÊï∞ÊçÆ
          function handleColorPointData(data) {
              const pointMap = { 0xad: 1, 0xae: 2, 0xaf: 3 };
              const point = pointMap[data[0]];
              if (!point) return;

              const r = data[2];
              const g = data[3];
              const b = data[4];

              // Convert RGB to hex string #RRGGBB
              const toHex = c => ('0' + c.toString(16)).slice(-2);
              const hexColor = `#${toHex(r)}${toHex(g)}${toHex(b)}`;

              // Update the color picker UI
              const colorInput = document.getElementById(`colorPoint${point}`);
              if (colorInput) {
                  colorInput.value = hexColor;
              }

              log(`Received color point ${point} data: R=${r}, G=${g}, B=${b} (${hexColor})`);
              showNotification(`Color point ${point} updated from device.`, 'info', 2000);
          }

          async function sendColorPoint(point) {
              if (!characteristic) {
                  log('Error: Device not connected');
                  showNotification('ËÆæÂ§áÊú™ËøûÊé•ÔºåÊó†Ê≥ïËÆæÁΩÆÈ¢úËâ≤', 'error');
                  return;
              }
              // Ëé∑ÂèñÈ¢úËâ≤
              const colorInput = document.getElementById('colorPoint' + point);
              const hex = colorInput.value;
              // Ëß£ÊûêRGB
              const r = parseInt(hex.substr(1,2), 16);
              const g = parseInt(hex.substr(3,2), 16);
              const b = parseInt(hex.substr(5,2), 16);

              // ÁªÑÂåÖ
              let cmd, end;
              if (point === 1) { cmd = 0xbd; end = 0xbd; }
              else if (point === 2) { cmd = 0xbe; end = 0xbe; }
              else if (point === 3) { cmd = 0xbf; end = 0xbf; }
              else { return; }

              const buf = new Uint8Array([cmd, 0x06, r, g, b, end]);
              try {
                  await characteristic.writeValue(buf);
                  log(`‚úì ÂèëÈÄÅÈ¢úËâ≤ÁÇπ${point}: [${Array.from(buf).map(x=>x.toString(16).padStart(2,'0')).join(' ')}]`);
                  showNotification(`È¢úËâ≤ÁÇπ${point}Â∑≤ÂèëÈÄÅ`, 'success', 1500);
              } catch (e) {
                  log(`‚úó È¢úËâ≤ÁÇπ${point}ÂèëÈÄÅÂ§±Ë¥•: ${e.message}`);
                  showNotification(`È¢úËâ≤ÁÇπ${point}ÂèëÈÄÅÂ§±Ë¥•`, 'error');
              }
          }

          // ========== IRO.js ÂúÜÂΩ¢Ë∞ÉËâ≤ÁõòÈõÜÊàê ==========
          let iroPicker = null;
          let currentColorPoint = 1;
          let iroPickerInitialColor = '#ff0000';
          let pickerInputsBound = false;

          function clamp255(v) {
              const n = parseInt(v, 10);
              if (isNaN(n)) return 0;
              return Math.max(0, Math.min(255, n));
          }

          function setPickerRgbInputs(rgb) {
              const rEl = document.getElementById('picker_r');
              const gEl = document.getElementById('picker_g');
              const bEl = document.getElementById('picker_b');
              if (!rEl || !gEl || !bEl) return;
              rEl.value = rgb.r;
              gEl.value = rgb.g;
              bEl.value = rgb.b;
          }

          function bindPickerInputEvents() {
              if (pickerInputsBound) return;
              const rEl = document.getElementById('picker_r');
              const gEl = document.getElementById('picker_g');
              const bEl = document.getElementById('picker_b');
              if (!rEl || !gEl || !bEl) return;
              const handler = () => {
                  const r = clamp255(rEl.value);
                  const g = clamp255(gEl.value);
                  const b = clamp255(bEl.value);
                  if (iroPicker) {
                      iroPicker.color.rgb = { r, g, b };
                      document.getElementById('colorPickerRgbInfo').textContent = `RGB: (${r}, ${g}, ${b})`;
                  }
              };
              rEl.addEventListener('input', handler);
              gEl.addEventListener('input', handler);
              bEl.addEventListener('input', handler);
              pickerInputsBound = true;
          }

          // ÊâìÂºÄË∞ÉËâ≤ÁõòÂºπÁ™ó
          function openColorPicker(point) {
              currentColorPoint = point;
              // Ëé∑ÂèñÂΩìÂâçÈ¢úËâ≤
              const btn = document.getElementById('colorPointBtn' + point);
              iroPickerInitialColor = rgb2hex(btn.style.backgroundColor || '#ff0000');
              // ÂàùÂßãÂåñiro.js
              if (!iroPicker) {
                  iroPicker = new iro.ColorPicker('#iroColorPicker', {
                      width: 220,
                      color: iroPickerInitialColor,
                      borderWidth: 1,
                      borderColor: '#ccc',
                      layout: [
                          { component: iro.ui.Wheel },
                          { component: iro.ui.Slider, options: { sliderType: 'value' } }
                      ]
                  });
                  // ÁõëÂê¨È¢úËâ≤ÂèòÂåñÔºåÊòæÁ§∫RGB
                  iroPicker.on('color:change', function(color) {
                      const rgb = color.rgb;
                      document.getElementById('colorPickerRgbInfo').textContent =
                          `RGB: (${rgb.r}, ${rgb.g}, ${rgb.b})`;
                      setPickerRgbInputs(rgb);
                  });
              } else {
                  iroPicker.color.set(iroPickerInitialColor);
                  // ÊâãÂä®ÊòæÁ§∫‰∏ÄÊ¨°
                  const rgb = iroPicker.color.rgb;
                  document.getElementById('colorPickerRgbInfo').textContent =
                      `RGB: (${rgb.r}, ${rgb.g}, ${rgb.b})`;
                  setPickerRgbInputs(rgb);
              }
              bindPickerInputEvents();
              document.getElementById('colorPickerModal').style.display = 'flex';
          }
          // ÂÖ≥Èó≠Ë∞ÉËâ≤ÁõòÂºπÁ™ó
          function closeColorPicker() {
              document.getElementById('colorPickerModal').style.display = 'none';
          }
          // È¢úËâ≤ËΩ¨hex
          function rgb2hex(rgb) {
              if (rgb.startsWith('#')) return rgb;
              const result = rgb.match(/\d+/g);
              if (!result) return '#ff0000';
              return '#' + result.slice(0,3).map(x=>('0'+parseInt(x).toString(16)).slice(-2)).join('');
          }
          // ÂºπÁ™óÊåâÈíÆ‰∫ã‰ª∂
          document.getElementById('colorPickerOkBtn').onclick = function() {
              const hex = iroPicker.color.hexString;
              // Êõ¥Êñ∞ÊåâÈíÆÈ¢úËâ≤
              const btn = document.getElementById('colorPointBtn' + currentColorPoint);
              btn.style.background = hex;
              // ÂèëÈÄÅÂà∞ËÆæÂ§á
              sendColorPoint(currentColorPoint, hex);
              closeColorPicker();
          };
          document.getElementById('colorPickerCancelBtn').onclick = function() {
              closeColorPicker();
          };
          // ÁÇπÂáªÂºπÁ™óÂ§ñÈÉ®ÂÖ≥Èó≠
          document.getElementById('colorPickerModal').onclick = function(e) {
              if (e.target === this) closeColorPicker();
          };
          // ‰øÆÊîπsendColorPointÊîØÊåÅ‰º†ÂÖ•hex
          async function sendColorPoint(point, hex) {
              if (!characteristic) {
                  log('Error: Device not connected');
                  showNotification('ËÆæÂ§áÊú™ËøûÊé•ÔºåÊó†Ê≥ïËÆæÁΩÆÈ¢úËâ≤', 'error');
                  return;
              }
              // Ëé∑ÂèñÈ¢úËâ≤
              hex = hex || document.getElementById('colorPointBtn' + point).style.background || '#ff0000';
              hex = rgb2hex(hex);
              // Ëß£ÊûêRGB
              const r = parseInt(hex.substr(1,2), 16);
              const g = parseInt(hex.substr(3,2), 16);
              const b = parseInt(hex.substr(5,2), 16);
              // ÁªÑÂåÖ
              let cmd, end;
              if (point === 1) { cmd = 0xbd; end = 0xbd; }
              else if (point === 2) { cmd = 0xbe; end = 0xbe; }
              else if (point === 3) { cmd = 0xbf; end = 0xbf; }
              else { return; }
              const buf = new Uint8Array([cmd, 0x06, r, g, b, end]);
              try {
                  await characteristic.writeValue(buf);
                  log(`‚úì ÂèëÈÄÅÈ¢úËâ≤ÁÇπ${point}: [${Array.from(buf).map(x=>x.toString(16).padStart(2,'0')).join(' ')}]`);
                  showNotification(`È¢úËâ≤ÁÇπ${point}Â∑≤ÂèëÈÄÅ`, 'success', 1500);
              } catch (e) {
                  log(`‚úó È¢úËâ≤ÁÇπ${point}ÂèëÈÄÅÂ§±Ë¥•: ${e.message}`);
                  showNotification(`È¢úËâ≤ÁÇπ${point}ÂèëÈÄÅÂ§±Ë¥•`, 'error');
              }
          }
          // ËÆæÂ§ánotifyÊõ¥Êñ∞È¢úËâ≤ÁÇπÊó∂ÂêåÊ≠•ÊåâÈíÆÈ¢úËâ≤
          function handleColorPointData(data) {
              const pointMap = { 0xad: 1, 0xae: 2, 0xaf: 3 };
              const point = pointMap[data[0]];
              if (!point) return;
              const r = data[2];
              const g = data[3];
              const b = data[4];
              const hexColor = `#${('0'+r.toString(16)).slice(-2)}${('0'+g.toString(16)).slice(-2)}${('0'+b.toString(16)).slice(-2)}`;
              const btn = document.getElementById('colorPointBtn' + point);
              if (btn) btn.style.background = hexColor;
              log(`Received color point ${point} data: R=${r}, G=${g}, B=${b} (${hexColor})`);
              showNotification(`Color point ${point} updated from device.`, 'info', 2000);
          }

          // ========== IRO.js ÂúÜÂΩ¢Ë∞ÉËâ≤ÁõòÈõÜÊàê ==========
          window.addEventListener('load', function() {
              let iroPicker = null;
              let currentColorPoint = 1;
              let iroPickerInitialColor = '#ff0000';
              let pickerInputsBound = false;

              function clamp255(v) {
                  const n = parseInt(v, 10);
                  if (isNaN(n)) return 0;
                  return Math.max(0, Math.min(255, n));
              }
              function setPickerRgbInputs(rgb) {
                  const rEl = document.getElementById('picker_r');
                  const gEl = document.getElementById('picker_g');
                  const bEl = document.getElementById('picker_b');
                  if (!rEl || !gEl || !bEl) return;
                  rEl.value = rgb.r;
                  gEl.value = rgb.g;
                  bEl.value = rgb.b;
              }
              function bindPickerInputEvents() {
                  if (pickerInputsBound) return;
                  const rEl = document.getElementById('picker_r');
                  const gEl = document.getElementById('picker_g');
                  const bEl = document.getElementById('picker_b');
                  if (!rEl || !gEl || !bEl) return;
                  const handler = () => {
                      const r = clamp255(rEl.value);
                      const g = clamp255(gEl.value);
                      const b = clamp255(bEl.value);
                      if (iroPicker) {
                          iroPicker.color.rgb = { r, g, b };
                          document.getElementById('colorPickerRgbInfo').textContent = `RGB: (${r}, ${g}, ${b})`;
                      }
                  };
                  rEl.addEventListener('input', handler);
                  gEl.addEventListener('input', handler);
                  bEl.addEventListener('input', handler);
                  pickerInputsBound = true;
              }

              window.openColorPicker = function(point) {
                  currentColorPoint = point;
                  // Ëé∑ÂèñÂΩìÂâçÈ¢úËâ≤
                  const btn = document.getElementById('colorPointBtn' + point);
                  iroPickerInitialColor = rgb2hex(btn.style.backgroundColor || '#ff0000');
                  // ÂàùÂßãÂåñiro.js
                  if (!iroPicker) {
                      iroPicker = new iro.ColorPicker('#iroColorPicker', {
                          width: 220,
                          color: iroPickerInitialColor,
                          borderWidth: 1,
                          borderColor: '#ccc',
                          layout: [
                              { component: iro.ui.Wheel },
                              { component: iro.ui.Slider, options: { sliderType: 'value' } }
                          ]
                      });
                      // ÁõëÂê¨È¢úËâ≤ÂèòÂåñÔºåÊòæÁ§∫RGB
                      iroPicker.on('color:change', function(color) {
                          const rgb = color.rgb;
                          document.getElementById('colorPickerRgbInfo').textContent =
                              `RGB: (${rgb.r}, ${rgb.g}, ${rgb.b})`;
                          setPickerRgbInputs(rgb);
                      });
                  } else {
                      iroPicker.color.set(iroPickerInitialColor);
                      // ÊâãÂä®ÊòæÁ§∫‰∏ÄÊ¨°
                      const rgb = iroPicker.color.rgb;
                      document.getElementById('colorPickerRgbInfo').textContent =
                          `RGB: (${rgb.r}, ${rgb.g}, ${rgb.b})`;
                      setPickerRgbInputs(rgb);
                  }
                  bindPickerInputEvents();
                  document.getElementById('colorPickerModal').style.display = 'flex';
              };

              function closeColorPicker() {
                  document.getElementById('colorPickerModal').style.display = 'none';
              }
              function rgb2hex(rgb) {
                  if (rgb.startsWith('#')) return rgb;
                  const result = rgb.match(/\d+/g);
                  if (!result) return '#ff0000';
                  return '#' + result.slice(0,3).map(x=>('0'+parseInt(x).toString(16)).slice(-2)).join('');
              }

              document.getElementById('colorPickerOkBtn').onclick = function() {
                  const hex = iroPicker.color.hexString;
                  // Êõ¥Êñ∞ÊåâÈíÆÈ¢úËâ≤
                  const btn = document.getElementById('colorPointBtn' + currentColorPoint);
                  btn.style.background = hex;
                  // ÂèëÈÄÅÂà∞ËÆæÂ§á
                  sendColorPoint(currentColorPoint, hex);
                  closeColorPicker();
              };
              document.getElementById('colorPickerCancelBtn').onclick = function() {
                  closeColorPicker();
              };
              document.getElementById('colorPickerModal').onclick = function(e) {
                  if (e.target === this) closeColorPicker();
              };
          });
          // sendColorPointÂíåhandleColorPointDataÂáΩÊï∞‰øùÊåÅÂÖ®Â±ÄÂèØÁî®


          // ‰øÆÊ≠£ÁâàÔºöpoint2~point10Ê∏©Â∫¶ËåÉÂõ¥ÈÄíÂΩíËÅîÂä®ÈôêÂà∂ (Êâ©Â±ïÂà∞10‰∏™ÁÇπ)
          window.addEventListener('DOMContentLoaded', function() {
              const tempInputs = document.querySelectorAll('#customConfigCard .custom-temp');
              const timeInputs = document.querySelectorAll('#customConfigCard .custom-time');
              function updateRangeFrom(index) {
                  let hasChanged = false;
                  for (let i = index; i < tempInputs.length - 1; i++) {
                    const prev = parseInt(tempInputs[i].value) || 0;
                    const deltaT = parseInt(timeInputs[i+1].value) - parseInt(timeInputs[i].value);
                    const min = prev - deltaT * 3;
                    const max = prev + deltaT * 10;
                      if(min < 250) min = 250;
                      if(max > 650) max = 650;
                      tempInputs[i+1].min = min;
                      tempInputs[i+1].max = max;
                      if(timeInputs[i+1].value != 0){
                        let curr = parseInt(tempInputs[i+1].value) || 0;
                        let changed = false;
                        if (curr < min) { tempInputs[i+1].value = min; changed = true; }
                        if (curr > max) { tempInputs[i+1].value = max; changed = true; }
                        // Â¶ÇÊûúÂΩìÂâçÂÄºË¢´‰øÆÊ≠£ÔºåÈÄíÂΩí‰øÆÊ≠£‰∏ã‰∏Ä‰∏™ÁÇπ
                        if (changed) {
                            hasChanged = true;
                            if (i+1 < tempInputs.length - 1) {
                                // ÈÄíÂΩí‰øÆÊ≠£ÂêéÁª≠ÁÇπ
                                updateRangeFrom(i+1);
                            }
                        }                        
                      }

                  }
                  // Â¶ÇÊûúÊúâÂÄºË¢´‰øÆÊîπÔºåÂêåÊ≠•Êõ¥Êñ∞customSettings
                  if (hasChanged) {
                      saveCurrentCustomUI();
                  }
              }
              // Áªôpoint0~point9Âä†‰∫ã‰ª∂ (Êâ©Â±ïÂà∞10‰∏™ÁÇπ)
              for (let i = 0; i < tempInputs.length - 1; i++) {
                  tempInputs[i].addEventListener('input', function() {
                      updateRangeFrom(i);
                  });
              }
              // È°µÈù¢ÂàùÂßãÂåñÊó∂ÈÄíÂΩí‰øÆÊ≠£‰∏ÄÊ¨°
              updateRangeFrom(1);

              function updateTimeRangeFrom(index) {
                let hasChanged = false;
                for (let i = index; i < timeInputs.length - 1; i++) {
                      const prev = parseInt(timeInputs[i].value) || 0;
                      let curr = parseInt(timeInputs[i+1].value) || 0;


                      if (curr < prev) {
                          for (let j = i+1; j < timeInputs.length; j++) {
                              timeInputs[j].value = 0;
                              tempInputs[j].value = 0;
                              if(prev == 90) {
                                timeInputs[j].min = 90;
                              }
                              else {
                                timeInputs[j].min = prev+1;
                              }
                          }
                          timeInputs[i+1].disabled = false;
                          for (let j = i+2; j < timeInputs.length; j++) {
                            timeInputs[j].disabled = true;
                         }
                         hasChanged = true;
                         break; 
                      }
                  }
                 // Â¶ÇÊûúÊúâÂÄºË¢´‰øÆÊîπÔºåÂêåÊ≠•Êõ¥Êñ∞customSettings
                 if (hasChanged) {
                     saveCurrentCustomUI();
                 }
                 // updateRangeFrom(1);
              }
              // point2~point9ÂèòÂåñÊó∂ÈÄíÂΩí‰øÆÊ≠£ÂêéÁª≠ÁÇπ (Êâ©Â±ïÂà∞10‰∏™ÁÇπ)
              for (let i = 1; i < timeInputs.length - 1; i++) {
                  timeInputs[i].addEventListener('input', function() {
                      updateTimeRangeFrom(i);
                  });
              }
              // È°µÈù¢ÂàùÂßãÂåñÊó∂ÈÄíÂΩí‰øÆÊ≠£‰∏ÄÊ¨°
              updateTimeRangeFrom(2);


          });
    
    
    
    
    
    </script>
</body>
</html>