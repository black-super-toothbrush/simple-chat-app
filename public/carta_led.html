<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BLE Scan & Connect</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 24px; background: #f7f7fb; color: #222; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .toolbar { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    button { padding: 8px 14px; border-radius: 8px; border: 1px solid #8884; background: #4f7cff; color: #fff; cursor: pointer; }
    button:hover { filter: brightness(1.05); }
    #status { margin-top: 8px; font-size: 13px; color: #555; }
    .hint { font-size: 12px; color: #777; }
    .warn { color: #b45309; background: #fff7ed; border: 1px solid #fed7aa; padding: 8px 10px; border-radius: 8px; margin-top: 8px; display:none; }
  </style>
</head>
<body>
  <h1>Bluetooth Scan & Connect</h1>
  <div class="toolbar">
    <button id="scanBtn">Scan</button>
    <span class="hint">Tip: Use Chrome over HTTPS or localhost.</span>
  </div>
  <div id="status">Ready</div>
  <div id="secureWarn" class="warn">This page is not served in a secure context. Web Bluetooth requires HTTPS or localhost.</div>

  <script>
    const scanBtn = document.getElementById('scanBtn');
    const statusEl = document.getElementById('status');
    const secureWarnEl = document.getElementById('secureWarn');

    let connectedDevice = null;

    function setStatus(msg) {
      statusEl.textContent = msg;
      console.log('[Status]', msg);
    }

    async function onScanClick() {
      if (!navigator.bluetooth) {
        setStatus('Web Bluetooth is not supported in this browser');
        return;
      }
      try {
        setStatus('Opening device chooser...');
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: ['1011123e-8535-b5a0-7140-a304d2495cb7']
        });
        setStatus(`Connecting to ${device.name || device.id} ...`);
        const server = await device.gatt.connect();
        connectedDevice = device;
        setStatus(`Connected: ${device.name || device.id}`);
        console.log('GATT Server:', server);

        // Example: read a characteristic after connected
        // const service = await server.getPrimaryService('battery_service');
        // const char = await service.getCharacteristic('battery_level');
        // const value = await char.readValue();
      } catch (err) {
        if (err && err.name === 'NotFoundError') {
          setStatus('User cancelled selection');
        } else {
          console.error(err);
          setStatus(`Connection failed: ${err.message || err}`);
        }
      }
    }

    scanBtn.addEventListener('click', onScanClick);

    // Environment hint
    window.addEventListener('load', () => {
      if (!isSecureContext) {
        secureWarnEl.style.display = 'block';
      }
    });
  </script>
</body>
</html>