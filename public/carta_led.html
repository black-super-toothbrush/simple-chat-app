<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BLE Scan & Connect</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 24px; background: #f7f7fb; color: #222; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .toolbar { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    button { padding: 8px 14px; border-radius: 8px; border: 1px solid #8884; background: #4f7cff; color: #fff; cursor: pointer; }
    button:hover { filter: brightness(1.05); }
    #status { margin-top: 8px; font-size: 13px; color: #555; }
    .hint { font-size: 12px; color: #777; }
    .warn { color: #b45309; background: #fff7ed; border: 1px solid #fed7aa; padding: 8px 10px; border-radius: 8px; margin-top: 8px; display:none; }
  </style>
</head>
<body>
  <h1>Bluetooth Scan & Connect</h1>
  <div class="toolbar">
    <button id="scanBtn">Scan</button>
  </div>
  <div id="status">Ready</div>
  <div id="secureWarn" class="warn">This page is not served in a secure context. Web Bluetooth requires HTTPS or localhost.</div>

  <!-- LED Color Palettes -->
  <div class="card" style="margin-top:16px; padding:12px; background:#fff; border:1px solid #ddd; border-radius:12px;">
    <div style="font-weight:600; margin-bottom:8px;">LED Color Palettes</div>
    <div id="paletteGrid" style="display:grid; grid-template-columns:repeat(4, minmax(160px, 1fr)); gap:12px;">
      <label style="display:flex; align-items:center; gap:8px;">Color 1 <input id="color1" type="color" value="#ff0000" style="width:44px; height:28px; padding:0; border:none; background:none;" /> <button class="apply-btn" data-idx="0" style="padding:6px 10px;">Apply</button></label>
      <label style="display:flex; align-items:center; gap:8px;">Color 2 <input id="color2" type="color" value="#00ff00" style="width:44px; height:28px; padding:0; border:none; background:none;" /> <button class="apply-btn" data-idx="1" style="padding:6px 10px;">Apply</button></label>
      <label style="display:flex; align-items:center; gap:8px;">Color 3 <input id="color3" type="color" value="#0000ff" style="width:44px; height:28px; padding:0; border:none; background:none;" /> <button class="apply-btn" data-idx="2" style="padding:6px 10px;">Apply</button></label>
      <label style="display:flex; align-items:center; gap:8px;">Color 4 <input id="color4" type="color" value="#ffff00" style="width:44px; height:28px; padding:0; border:none; background:none;" /> <button class="apply-btn" data-idx="3" style="padding:6px 10px;">Apply</button></label>
      <label style="display:flex; align-items:center; gap:8px;">Color 5 <input id="color5" type="color" value="#ff00ff" style="width:44px; height:28px; padding:0; border:none; background:none;" /> <button class="apply-btn" data-idx="4" style="padding:6px 10px;">Apply</button></label>
      <label style="display:flex; align-items:center; gap:8px;">Color 6 <input id="color6" type="color" value="#00ffff" style="width:44px; height:28px; padding:0; border:none; background:none;" /> <button class="apply-btn" data-idx="5" style="padding:6px 10px;">Apply</button></label>
      <label style="display:flex; align-items:center; gap:8px;">Color 7 <input id="color7" type="color" value="#ffffff" style="width:44px; height:28px; padding:0; border:none; background:none;" /> <button class="apply-btn" data-idx="6" style="padding:6px 10px;">Apply</button></label>
      <label style="display:flex; align-items:center; gap:8px;">Color 8 <input id="color8" type="color" value="#000000" style="width:44px; height:28px; padding:0; border:none; background:none;" /> <button class="apply-btn" data-idx="7" style="padding:6px 10px;">Apply</button></label>
    </div>
    <div id="rgbLabel" class="hint" style="margin-top:10px;">RGB: 255, 0, 0</div>
  </div>

  <script>
    const scanBtn = document.getElementById('scanBtn');
    const statusEl = document.getElementById('status');
    const secureWarnEl = document.getElementById('secureWarn');

    let connectedDevice = null;
    let gattServer = null;
    let ledCharacteristic = null;
    let ledNotifyCharacteristic = null;
    const LED_SERVICE_UUID = '1011123e-8535-b5a0-7140-a304d2495cb7';
    const LED_CHAR_UUID = '1011123e-8535-b5a0-7140-a304d2495cb9';
    const LED_NOTIFY_CHAR_UUID = '1011123e-8535-b5a0-7140-a304d2495cb8';

    function setStatus(msg) {
      statusEl.textContent = msg;
      console.log('[Status]', msg);
    }
    function hexDumpFromDataView(dv) {
      const bytes = new Uint8Array(dv.buffer, dv.byteOffset, dv.byteLength);
      return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join(' ');
    }
    // Send a clock calibration frame (0xDD) after connection
    async function sendClockCalibrationDD(char) {
      try {
        const now = new Date();
        const year = now.getFullYear();
        const yh = (year >> 8) & 0xFF; // high byte
        const yl = year & 0xFF;        // low byte
        let month = now.getMonth() + 1; // 1-12
        let day = now.getDate();        // 1-31 (doc shows 1-30)
        let hour = now.getHours();      // 0-23
        let minute = now.getMinutes();  // 0-59
        // clamp per spec from provided table
        month = Math.min(12, Math.max(1, month));
        day = Math.min(30, Math.max(1, day));
        hour = Math.min(24, Math.max(1, hour)); // table shows 0x01-0x18
        minute = Math.min(59, Math.max(0, minute));
        const payload = new Uint8Array([
          0xDD, 0x0C, yh, yl, month, day, hour, minute, 0x00, 0x00, 0x00, 0xDD
        ]);
        if (typeof char.writeValue === 'function') {
          await char.writeValue(payload);
        } else if (typeof char.writeValueWithoutResponse === 'function') {
          await char.writeValueWithoutResponse(payload);
        } else {
          throw new Error('Characteristic does not support write');
        }
        console.log('已发送 0xDD 时钟校准帧:', payload);
        setStatus('Sent 0xDD clock calibration');
      } catch (err) {
        console.error('0xDD write failed', err);
        setStatus(`0xDD write failed: ${err.message || err}`);
      }
    }
    function handleLedNotify(event) {
      try {
        const dv = event.target.value;
        // Debug: print all received bytes in HEX
        console.debug('[Notify HEX]', hexDumpFromDataView(dv));
        const len = dv.byteLength;
        if (len < 7) return;
        const start = dv.getUint8(0);
        const cmd = dv.getUint8(1);
        const idx = dv.getUint8(2);
        const r = dv.getUint8(3);
        const g = dv.getUint8(4);
        const b = dv.getUint8(5);
        const end = dv.getUint8(6);
        if (start !== 0xEA || cmd !== 0x07 || end !== 0xEA) return;
        if (idx < 0 || idx > 7) return;
        const hex = '#' + [r,g,b].map(v => v.toString(16).padStart(2, '0')).join('');
        const inputEl = document.querySelector(`#paletteGrid input#color${idx+1}`);
        if (inputEl) {
          inputEl.value = hex;
        }
        const rgbLabelEl = document.getElementById('rgbLabel');
        if (rgbLabelEl) {
          rgbLabelEl.textContent = `RGB: ${r}, ${g}, ${b}`;
        }
        setStatus(`LED ${idx} color updated from device`);
      } catch (e) {
        console.error('Notify parse error', e);
      }
    }

    async function onScanClick() {
      if (!navigator.bluetooth) {
        setStatus('Web Bluetooth is not supported in this browser');
        return;
      }
      try {
        setStatus('Opening device chooser...');
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: ['1011123e-8535-b5a0-7140-a304d2495cb7']
        });
        setStatus(`Connecting to ${device.name || device.id} ...`);
        const server = await device.gatt.connect();
        gattServer = server;
        connectedDevice = device;
        setStatus(`Connected: ${device.name || device.id}`);
        console.log('GATT Server:', server);

        // Get LED service & characteristic
        try {
          const service = await server.getPrimaryService(LED_SERVICE_UUID);
          ledCharacteristic = await service.getCharacteristic(LED_CHAR_UUID);
          // Show connected & LED ready before subscribing notifications
          setStatus(`Connected: ${device.name || device.id} (LED ready)`);
          // 连接成功后立即发送一帧 0xDD（时钟校准）
          try {
            await sendClockCalibrationDD(ledCharacteristic);
          } catch (e) {
            console.warn('发送 0xDD 帧失败', e);
          }
          // 参考 carta2 的方式：遍历服务的特征并订阅所有支持 notify 的特征
          try {
            const characteristics = await service.getCharacteristics();
            let notifyCount = 0;
          for (const char of characteristics) {
            console.log('特征值 UUID:', char.uuid, 'Properties:', char.properties);
            if (char.properties && char.properties.notify) {
              // 先绑定监听再开启通知，尽量避免丢失首帧
              char.addEventListener('characteristicvaluechanged', event => {
                const dv = event.target.value;
                const d = new Uint8Array(dv.buffer, dv.byteOffset, dv.byteLength);
                console.log('收到 Notify 数据:', d);
                console.debug('[Notify HEX]', hexDumpFromDataView(dv));
                try { handleLedNotify(event); } catch (e) { console.error('handleLedNotify error', e); }
              });
              try {
                await char.startNotifications();
              } catch (e) {
                console.warn('startNotifications 失败', e);
              }
              // 如果支持 read，订阅后尝试读取一次当前值
              try {
                const v = await char.readValue();
                console.debug('[Initial READ HEX]', hexDumpFromDataView(v));
              } catch (readErr) {
                console.debug('Read 不支持或失败（notify-only characteristic）', readErr);
              }
              // 记录目标通知特征，便于后续使用
              if (char.uuid === LED_NOTIFY_CHAR_UUID) {
                ledNotifyCharacteristic = char;
              }
              notifyCount++;
            }
            }
            if (notifyCount > 0) {
              setStatus('LED notifications enabled; waiting for data...');
            } else {
              console.warn('该服务下没有支持 notify 的特征');
            }
          } catch (notifErr) {
            console.warn('遍历并开启 notify 失败', notifErr);
          }
        } catch (e) {
          console.error('Failed to get LED characteristic', e);
          setStatus(`Connected: ${device.name || device.id}, but LED characteristic not found`);
        }
        // Example: read a characteristic after connected
        // const service = await server.getPrimaryService('battery_service');
        // const char = await service.getCharacteristic('battery_level');
        // const value = await char.readValue();
      } catch (err) {
        if (err && err.name === 'NotFoundError') {
          setStatus('User cancelled selection');
        } else {
          console.error(err);
          setStatus(`Connection failed: ${err.message || err}`);
        }
      }
    }

    scanBtn.addEventListener('click', onScanClick);

    // Disconnection handler
    navigator.bluetooth.addEventListener?.('gattserverdisconnected', (ev) => {
      const dev = ev.target;
      setStatus(`Disconnected: ${dev?.name || dev?.id || 'device'}`);
      ledCharacteristic = null;
      ledNotifyCharacteristic = null;
    });

    // Environment hint
    window.addEventListener('load', () => {
      if (!isSecureContext) {
        secureWarnEl.style.display = 'block';
      }
      // bind color inputs
      const labels = Array.from(document.querySelectorAll('#paletteGrid input[type="color"]'));
      const applyButtons = Array.from(document.querySelectorAll('#paletteGrid .apply-btn'));
      const rgbLabel = document.getElementById('rgbLabel');
      const colorHexes = new Array(8);
      const hexToRgb = (hex) => {
        const h = hex.replace('#','');
        const bigint = parseInt(h, 16);
        const r = (bigint >> 16) & 255;
        const g = (bigint >> 8) & 255;
        const b = bigint & 255;
        return { r, g, b };
      };
      const onChange = (ev, ledIndex) => {
        const { r, g, b } = hexToRgb(ev.target.value);
        rgbLabel.textContent = `RGB: ${r}, ${g}, ${b}`;
        colorHexes[ledIndex] = ev.target.value;
      };
      labels.forEach((el, idx) => el.addEventListener('input', (ev) => onChange(ev, idx)));
      // init saved colors
      labels.forEach((el, idx) => colorHexes[idx] = el.value);
      // Apply button -> write BLE only when clicked
      applyButtons.forEach((btn) => {
        btn.addEventListener('click', async () => {
          const idx = Number(btn.dataset.idx);
          if (!ledCharacteristic) {
            setStatus('Connect a BLE device first');
            return;
          }
          const hex = labels[idx]?.value;
          const { r, g, b } = hexToRgb(hex);
          const payload = new Uint8Array([0xE5, 0x07, idx, r, g, b, 0xE5]);
          try {
            if (typeof ledCharacteristic.writeValue === 'function') {
              await ledCharacteristic.writeValue(payload);
            } else if (typeof ledCharacteristic.writeValueWithoutResponse === 'function') {
              await ledCharacteristic.writeValueWithoutResponse(payload);
            } else {
              throw new Error('Characteristic does not support write');
            }
            setStatus(`LED ${idx} color applied`);
          } catch (err) {
            console.error('Write failed', err);
            setStatus(`Write failed: ${err.message || err}`);
          }
        });
      });
      // init with first color
      if (labels[0]) {
        const { r, g, b } = hexToRgb(labels[0].value);
        rgbLabel.textContent = `RGB: ${r}, ${g}, ${b}`;
      }
    });
  </script>
</body>
</html>