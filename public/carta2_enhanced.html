<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bluetooth Device Status Panel</title>
  <!-- å¼•å…¥ SheetJS åº“ç”¨äºç”Ÿæˆ Excel æ–‡ä»¶ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #f8fbff; padding: 2em; }
    h2 { margin-bottom: 1em; }
    .panel { background: #fff; padding: 1em; border-radius: 10px; box-shadow: 0 0 6px #ccc; max-width: 500px; margin-bottom: 1em; }
    .row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed #ddd; }
    .row:last-child { border: none; }
    label { font-weight: bold; }
    .val { font-family: monospace; }
    button, input { margin: 0.5em 0; padding: 0.6em; font-size: 1em; }
    .form { margin-top: 1em; }
    
    /* æ•°æ®é‡‡é›†çŠ¶æ€æ ·å¼ */
    .recording-panel {
      background: #fff3cd;
      border: 2px solid #ffc107;
    }
    .recording-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #dc3545;
      margin-right: 8px;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.3; }
    }
    .status-recording { color: #dc3545; font-weight: bold; }
    .status-idle { color: #6c757d; }
    .status-stopped { color: #28a745; font-weight: bold; }
  </style>
</head>
<body>

<h2>ğŸ“¡ Bluetooth Status Panel</h2>
<button id="connectBtn">ğŸ”— Connect Bluetooth Device</button>

<!-- æ•°æ®é‡‡é›†æ§åˆ¶é¢æ¿ -->
<div class="panel" id="recordingPanel">
  <div class="row">
    <label>ğŸ“Š æ•°æ®é‡‡é›†çŠ¶æ€:</label>
    <span class="val status-idle" id="recordingStatus">å¾…æœºä¸­</span>
  </div>
  <div class="row">
    <label>å·²é‡‡é›†æ•°æ®ç‚¹:</label>
    <span class="val" id="recordedCount">0</span>
  </div>
  <div class="row">
    <label>åœæ­¢æ£€æµ‹æ—¶é—´:</label>
    <span class="val">
      <input type="number" id="stopThreshold" value="5" min="1" max="60" style="width: 60px;"> ç§’
    </span>
  </div>
  <div class="row">
    <button id="manualExportBtn" style="background: #28a745; color: white;">ğŸ’¾ æ‰‹åŠ¨å¯¼å‡º Excel</button>
    <button id="clearDataBtn" style="background: #dc3545; color: white;">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
  </div>
</div>

<div class="form">
  <label for="ssid">SSID:</label>
  <input type="text" id="ssid" placeholder="Enter WiFi SSID">
  <label for="password">Password:</label>
  <input type="text" id="password" placeholder="Enter WiFi password">
  <button id="startWifiBtn">ğŸš€ Start WiFi</button>

  <!-- OTA BIN Upload -->
  <div style="margin-top:1em;">
    <label for="binFile">Select OTA Firmware (.bin):</label>
    <input type="file" id="binFile" accept=".bin">
    <button id="sendBinBtn">ğŸ“¦ Send OTA BIN</button>
  </div>

  <!-- OTA URL Input -->
  <div style="margin-top: 1em;">
  <label for="otaUrl">OTA URL:</label>
  <input type="text" id="otaUrl" placeholder="Enter OTA download URL" style="width: 50%;">
  <button id="startOtaBtn">â¬‡ï¸ Start WiFi OTA</button>
  </div>

  <div class="form">
  <label for="hexInput">Send Hex Data Manually:</label>
  <input type="text" id="hexInput" placeholder="e.g. AA 01 FF 00" style="width: 60%;">
  <button id="sendHexBtn">ğŸ“¤ Send Hex</button>
  <button id="sendAsciiBtn">ğŸ“ Send ASCII</button>
  </div>

  <!-- Percentage Slider -->
  <div class="form">
  <label for="percentSlider">Percentage Control (0-100):</label>
  <button id="percentMinusBtn" title="Decrease">-</button>
  <input type="range" id="percentSlider" min="0" max="100" value="50" style="width: 60%;">
  <button id="percentPlusBtn" title="Increase">+</button>
  <span id="percentValue">50</span>%
  </div>

</div>

<div class="panel" id="statusPanel">
  <div class="row"><label>Atomizer Type:</label><span class="val" id="atomizer">--</span></div>
  <div class="row"><label>Dry Herb Preset:</label><span class="val" id="dryPreset">--</span></div>
  <div class="row"><label>Gesso Preset:</label><span class="val" id="gessoPreset">--</span></div>
  <div class="row"><label>Countdown:</label><span class="val" id="countdown">--</span></div>
  <div class="row"><label>Current Temp:</label><span class="val" id="curTemp">--</span></div>
  <div class="row"><label>Preset Temp:</label><span class="val" id="presetTemp">--</span></div>
  <div class="row"><label>Battery Level:</label><span class="val" id="battery">--</span></div>
  <div class="row"><label>LED Preset:</label><span class="val" id="ledPreset">--</span></div>
  <div class="row"><label>Dry Herb Time:</label><span class="val" id="dryTime">--</span></div>
  <div class="row"><label>Gesso Time:</label><span class="val" id="gessoTime">--</span></div>
</div>
<div class="panel" id="chartPanel">
  <div class="row"><label>ğŸ“ˆ å®æ—¶æ¸©åº¦æ›²çº¿</label><span class="val">Side â€¢ Bottom â€¢ Power</span></div>
  <div class="row">
    <span class="val" style="color:#e74c3c">Side: <span id="curSide">--</span></span>
    <span class="val" style="color:#3498db">Bottom: <span id="curBottom">--</span></span>
    <span class="val" style="color:#2ecc71">Power: <span id="curPower">--</span></span>
  </div>
  <canvas id="chartCanvas" width="500" height="240"></canvas>
  <div class="row"><span style="color:#e74c3c">â— Side</span><span style="color:#3498db">â— Bottom</span><span style="color:#2ecc71">â— Power</span></div>
</div>

<script>
let characteristicToWrite = null; // ä¿å­˜å¯å†™ç‰¹å¾å€¼

// ==================== æ•°æ®é‡‡é›†ç›¸å…³å˜é‡ ====================
let recordedData = []; // å­˜å‚¨æ‰€æœ‰é‡‡é›†çš„æ•°æ®
let isRecording = false; // æ˜¯å¦æ­£åœ¨é‡‡é›†
let lastDataTime = null; // æœ€åä¸€æ¬¡æ¥æ”¶æ•°æ®çš„æ—¶é—´
let stopCheckInterval = null; // åœæ­¢æ£€æµ‹å®šæ—¶å™¨
let recordingStartTime = null; // å¼€å§‹é‡‡é›†çš„æ—¶é—´

// æ›´æ–°é‡‡é›†çŠ¶æ€æ˜¾ç¤º
function updateRecordingStatus(status) {
  const statusEl = document.getElementById('recordingStatus');
  const panelEl = document.getElementById('recordingPanel');
  
  if (status === 'recording') {
    statusEl.innerHTML = '<span class="recording-indicator"></span>æ­£åœ¨é‡‡é›†...';
    statusEl.className = 'val status-recording';
    panelEl.classList.add('recording-panel');
    isRecording = true;
  } else if (status === 'stopped') {
    statusEl.textContent = 'é‡‡é›†å®Œæˆ';
    statusEl.className = 'val status-stopped';
    panelEl.classList.remove('recording-panel');
    isRecording = false;
  } else {
    statusEl.textContent = 'å¾…æœºä¸­';
    statusEl.className = 'val status-idle';
    panelEl.classList.remove('recording-panel');
    isRecording = false;
  }
}

// å¼€å§‹æ•°æ®é‡‡é›†
function startRecording() {
  if (isRecording) return;
  
  recordedData = [];
  recordingStartTime = new Date();
  updateRecordingStatus('recording');
  
  console.log('âœ… å¼€å§‹æ•°æ®é‡‡é›†');
  
  // å¯åŠ¨åœæ­¢æ£€æµ‹å®šæ—¶å™¨
  startStopDetection();
}

// åœæ­¢æ•°æ®é‡‡é›†å¹¶å¯¼å‡º
function stopRecording() {
  if (!isRecording) return;
  
  updateRecordingStatus('stopped');
  console.log(`âœ… æ•°æ®é‡‡é›†å®Œæˆï¼Œå…±é‡‡é›† ${recordedData.length} æ¡æ•°æ®`);
  
  // åœæ­¢æ£€æµ‹å®šæ—¶å™¨
  if (stopCheckInterval) {
    clearInterval(stopCheckInterval);
    stopCheckInterval = null;
  }
  
  // è‡ªåŠ¨å¯¼å‡ºExcel
  if (recordedData.length > 0) {
    exportToExcel();
  } else {
    alert('æ²¡æœ‰é‡‡é›†åˆ°æ•°æ®');
  }
}

// å¯åŠ¨åœæ­¢æ£€æµ‹
function startStopDetection() {
  if (stopCheckInterval) {
    clearInterval(stopCheckInterval);
  }
  
  stopCheckInterval = setInterval(() => {
    if (!isRecording) return;
    
    const threshold = parseInt(document.getElementById('stopThreshold').value) * 1000;
    const now = Date.now();
    
    if (lastDataTime && (now - lastDataTime) > threshold) {
      console.log(`â¹ï¸ æ•°æ®åœæ­¢è¶…è¿‡ ${threshold/1000} ç§’ï¼Œè‡ªåŠ¨åœæ­¢é‡‡é›†`);
      stopRecording();
    }
  }, 1000);
}

// è®°å½•æ•°æ®ç‚¹
function recordDataPoint(side, bottom, power) {
  const timestamp = new Date();
  const dataPoint = {
    timestamp: timestamp.toISOString(),
    time: timestamp.toLocaleString('zh-CN'),
    side: side,
    bottom: bottom,
    power: power
  };
  
  recordedData.push(dataPoint);
  lastDataTime = Date.now();
  
  // æ›´æ–°æ˜¾ç¤º
  document.getElementById('recordedCount').textContent = recordedData.length;
  
  // å¦‚æœè¿˜æ²¡å¼€å§‹é‡‡é›†ï¼Œåˆ™è‡ªåŠ¨å¼€å§‹
  if (!isRecording) {
    startRecording();
  }
}

// å¯¼å‡ºä¸ºExcelæ–‡ä»¶
function exportToExcel() {
  if (recordedData.length === 0) {
    alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
    return;
  }
  
  // åˆ›å»ºå·¥ä½œç°¿
  const wb = XLSX.utils.book_new();
  
  // å‡†å¤‡æ•°æ®
  const wsData = [
    ['æ—¶é—´æˆ³', 'æ—¶é—´', 'Side Temperature', 'Bottom Temperature', 'Power'],
    ...recordedData.map(d => [d.timestamp, d.time, d.side, d.bottom, d.power])
  ];
  
  // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
  wsData.push([]);
  wsData.push(['ç»Ÿè®¡ä¿¡æ¯']);
  wsData.push(['æ€»æ•°æ®ç‚¹', recordedData.length]);
  wsData.push(['é‡‡é›†å¼€å§‹æ—¶é—´', recordingStartTime ? recordingStartTime.toLocaleString('zh-CN') : '']);
  wsData.push(['é‡‡é›†ç»“æŸæ—¶é—´', new Date().toLocaleString('zh-CN')]);
  
  if (recordedData.length > 0) {
    const sides = recordedData.map(d => d.side);
    const bottoms = recordedData.map(d => d.bottom);
    const powers = recordedData.map(d => d.power);
    
    wsData.push([]);
    wsData.push(['Side - æœ€å°å€¼', Math.min(...sides).toFixed(2)]);
    wsData.push(['Side - æœ€å¤§å€¼', Math.max(...sides).toFixed(2)]);
    wsData.push(['Side - å¹³å‡å€¼', (sides.reduce((a,b) => a+b, 0) / sides.length).toFixed(2)]);
    wsData.push([]);
    wsData.push(['Bottom - æœ€å°å€¼', Math.min(...bottoms).toFixed(2)]);
    wsData.push(['Bottom - æœ€å¤§å€¼', Math.max(...bottoms).toFixed(2)]);
    wsData.push(['Bottom - å¹³å‡å€¼', (bottoms.reduce((a,b) => a+b, 0) / bottoms.length).toFixed(2)]);
    wsData.push([]);
    wsData.push(['Power - æœ€å°å€¼', Math.min(...powers).toFixed(2)]);
    wsData.push(['Power - æœ€å¤§å€¼', Math.max(...powers).toFixed(2)]);
    wsData.push(['Power - å¹³å‡å€¼', (powers.reduce((a,b) => a+b, 0) / powers.length).toFixed(2)]);
  }
  
  // åˆ›å»ºå·¥ä½œè¡¨
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  
  // è®¾ç½®åˆ—å®½
  ws['!cols'] = [
    { wch: 25 },
    { wch: 20 },
    { wch: 18 },
    { wch: 20 },
    { wch: 12 }
  ];
  
  // æ·»åŠ å·¥ä½œè¡¨åˆ°å·¥ä½œç°¿
  XLSX.utils.book_append_sheet(wb, ws, 'æ¸©åº¦æ•°æ®');
  
  // ç”Ÿæˆæ–‡ä»¶å
  const filename = `æ¸©åº¦æ•°æ®_${new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5)}.xlsx`;
  
  // ä¸‹è½½æ–‡ä»¶
  XLSX.writeFile(wb, filename);
  
  console.log(`âœ… Excel æ–‡ä»¶å·²å¯¼å‡º: ${filename}`);
  alert(`æ•°æ®å·²å¯¼å‡ºåˆ°æ–‡ä»¶: ${filename}\nå…± ${recordedData.length} æ¡æ•°æ®`);
}

// æ¸…ç©ºæ•°æ®
function clearRecordedData() {
  if (isRecording) {
    const confirm = window.confirm('æ­£åœ¨é‡‡é›†ä¸­ï¼Œç¡®å®šè¦æ¸…ç©ºæ•°æ®å—ï¼Ÿ');
    if (!confirm) return;
    
    // åœæ­¢é‡‡é›†
    if (stopCheckInterval) {
      clearInterval(stopCheckInterval);
      stopCheckInterval = null;
    }
  }
  
  recordedData = [];
  document.getElementById('recordedCount').textContent = '0';
  updateRecordingStatus('idle');
  console.log('ğŸ—‘ï¸ æ•°æ®å·²æ¸…ç©º');
}

// æŒ‰é’®äº‹ä»¶ç»‘å®š
document.getElementById('manualExportBtn').addEventListener('click', () => {
  if (recordedData.length === 0) {
    alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
    return;
  }
  exportToExcel();
});

document.getElementById('clearDataBtn').addEventListener('click', () => {
  const confirm = window.confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é‡‡é›†çš„æ•°æ®å—ï¼Ÿ');
  if (confirm) {
    clearRecordedData();
  }
});

// ==================== åŸæœ‰ä»£ç  ====================

/* ç­‰å¾…è®¾å¤‡è¿”å› AWKï¼ˆ41 57 4Bï¼‰ï¼Œå¸¦è¶…æ—¶ */
function waitForAck(timeout = 6000) {
  return new Promise((resolve, reject) => {
    const timer = setTimeout(() => {
      console.warn("âš ï¸ ACK è¶…æ—¶ï¼Œæœªæ”¶åˆ°è®¾å¤‡å“åº”");
      reject(new Error("ç­‰å¾… AWK è¶…æ—¶"));
    }, timeout);

    // ä¿å­˜ä¸€ä¸ªè§¦å‘å™¨åˆ°å…¨å±€ï¼Œæ”¶åˆ° AWK æ—¶ä¼šè°ƒç”¨å®ƒ
    ackResolver = () => {
      clearTimeout(timer);
      resolve();
    };
  });
}


function set(id, value) {
  document.getElementById(id).textContent = value;
}
const chartDataSide=[];const chartDataBottom=[];const chartDataPower=[];const chartMaxPoints=200;
function drawChart(){const c=document.getElementById('chartCanvas');if(!c)return;const x=c.getContext('2d'),w=c.width,h=c.height,m=30,pw=w-m*2,ph=h-m*2;x.clearRect(0,0,w,h);x.fillStyle='#fff';x.fillRect(0,0,w,h);x.strokeStyle='#eee';x.lineWidth=1;for(let i=0;i<=4;i++){const y=m+i/4*ph;x.beginPath();x.moveTo(m,y);x.lineTo(m+pw,y);x.stroke();}const a=chartDataSide.concat(chartDataBottom,chartDataPower);if(!a.length){x.fillStyle='#666';x.font='14px sans-serif';x.fillText('ç­‰å¾…æ•°æ®â€¦',m+10,m+20);return;}let mn=Math.min(...a),mx=Math.max(...a);if(mn===mx){mn-=1;mx+=1;}const sy=v=>m+(ph-(v-mn)/(mx-mn)*ph),ss=pw/Math.max(chartDataSide.length-1,1),sb=pw/Math.max(chartDataBottom.length-1,1),sp=pw/Math.max(chartDataPower.length-1,1);x.strokeStyle='#e74c3c';x.lineWidth=2;x.beginPath();for(let i=0;i<chartDataSide.length;i++){const xx=m+i*ss,yy=sy(chartDataSide[i]);if(i===0)x.moveTo(xx,yy);else x.lineTo(xx,yy);}x.stroke();x.strokeStyle='#3498db';x.beginPath();for(let i=0;i<chartDataBottom.length;i++){const xx=m+i*sb,yy=sy(chartDataBottom[i]);if(i===0)x.moveTo(xx,yy);else x.lineTo(xx,yy);}x.stroke();x.strokeStyle='#2ecc71';x.beginPath();for(let i=0;i<chartDataPower.length;i++){const xx=m+i*sp,yy=sy(chartDataPower[i]);if(i===0)x.moveTo(xx,yy);else x.lineTo(xx,yy);}x.stroke();x.strokeStyle='#aaa';x.lineWidth=1;x.strokeRect(m,m,pw,ph);x.fillStyle='#666';x.font='12px sans-serif';x.fillText(`min:${mn}`,6,h-8);x.fillText(`max:${mx}`,6,16);} 

function addDataToChart(s,b,p){
  chartDataSide.push(s);
  chartDataBottom.push(b);
  chartDataPower.push(p);
  if(chartDataSide.length>chartMaxPoints)chartDataSide.shift();
  if(chartDataBottom.length>chartMaxPoints)chartDataBottom.shift();
  if(chartDataPower.length>chartMaxPoints)chartDataPower.shift();
  set('curSide',s);
  set('curBottom',b);
  set('curPower',Number(p).toFixed(2));
  drawChart();
  
  // âœ… è®°å½•æ•°æ®ç‚¹
  recordDataPoint(s, b, p);
}

document.getElementById('connectBtn').addEventListener('click', async () => {
  try {
    const device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: ['1011123e-8535-b5a0-7140-a304d2495cb7']
    });

    const server = await device.gatt.connect();
    const service = await server.getPrimaryService('1011123e-8535-b5a0-7140-a304d2495cb7');
    const characteristics = await service.getCharacteristics();

    for (const char of characteristics) {
      console.log('ç‰¹å¾å€¼ UUID:', char.uuid, 'Properties:', char.properties);
      if (char.properties.notify) {
        await char.startNotifications();
        char.addEventListener('characteristicvaluechanged', event => {
          const d = new Uint8Array(event.target.value.buffer);
          /* ---------- AWK æ£€æµ‹ ---------- */
          if (d.length === 3 && d[0] === 0x41 && d[1] === 0x57 && d[2] === 0x4B) {
            console.log('âœ… æ”¶åˆ° AWK');
            if (typeof ackResolver === 'function') {
              ackResolver();
              ackResolver = null;
            }
            return;
          }

          if(d[0] != 0x99) {
            console.log('æ”¶åˆ° Notify æ•°æ®:', d);
          }

          if (d[0] === 0xDD && d.length >= 17) {
            const sideTemp = ((d[3] << 8) | d[4]) * 9 / 5 + 32;
            const power = ((d[7] << 8) | d[8]) / 100;
            const bottomTemp = (d[15] << 8) | d[16];
            addDataToChart(sideTemp, bottomTemp, power);
            return;
          }

          if (d.length < 16) return;
          if (d[0] != 0x99)  return;
          const byte2 = d[2];
          const byte3 = d[3];
          const byte4 = d[4];
          const byte5 = d[5];
          const temp = (d[6] << 8) | d[7];
          const dryTemp = (d[8] << 8) | d[9];
          const gessoTemp = (d[10] << 8) | d[11];
          const battery = d[12];
          const ledPreset = d[13] >> 4;
          const dryTime = d[14];
          const gessoTime = d[15];
          
          let presetTemp = 0;
          if(byte2 == 0x40)  presetTemp = dryTemp;
          if(byte2 == 0x60)  presetTemp = gessoTemp;
          if(byte2 == 0xA0)  presetTemp = dryTemp;
          if(byte2 == 0x30)  presetTemp = gessoTemp;

          const atomizerMap = {
            0x40: 'Gesso', 0x60: 'Gesso', 0xA0: 'Dry Herb', 0x30: 'Gesso Max', 0x00: 'No Atomizer'
          };
          const unitMap = {
            0x11: 'â„‰', 0x22: 'â„ƒ'
          };

          set('atomizer', atomizerMap[byte2] || `0x${byte2.toString(16)}`);
          set('dryPreset', byte4 >> 4);
          set('gessoPreset', byte4 & 0x0F);
          set('countdown', `${byte5}s`);
          set('curTemp', temp + unitMap[byte3]);
          set('presetTemp', presetTemp + unitMap[byte3]);
          set('battery', `${battery}%`);
          set('ledPreset', ledPreset);
          set('dryTime', `${dryTime}s`);
          set('gessoTime', `${gessoTime}s`);
          console.log('æ‰¾åˆ° Notify ç‰¹å¾å€¼:', char.uuid);
        });
      }

      if (char.properties.write || char.properties.writeWithoutResponse) {
        characteristicToWrite = char;
        console.log('æ‰¾åˆ° Write ç‰¹å¾å€¼:', char.uuid);
      }
    }

    alert("è“ç‰™è®¾å¤‡è¿æ¥æˆåŠŸï¼");

  } catch (e) {
    alert('è¿æ¥å¤±è´¥: ' + e);
  }
});

document.getElementById('startWifiBtn').addEventListener('click', async () => {
  const ssid = document.getElementById('ssid').value;
  const password = document.getElementById('password').value;

  if (!ssid || !password) {
    alert("è¯·è¾“å…¥å®Œæ•´çš„ SSID å’Œå¯†ç ");
    return;
  }

  if (!characteristicToWrite) {
    alert("æœªè¿æ¥è“ç‰™è®¾å¤‡æˆ–æœªæ‰¾åˆ°å¯å†™ç‰¹å¾å€¼");
    return;
  }

  try {
    const encoder = new TextEncoder();
    const ssidBytes = encoder.encode(ssid);
    const passwordBytes = encoder.encode(password);

    if (ssidBytes.length > 32 || passwordBytes.length > 64) {
      alert("SSID æˆ–å¯†ç è¿‡é•¿");
      return;
    }

    const data = new Uint8Array(1 + 1 + ssidBytes.length + 1 + passwordBytes.length);
    data[0] = 0xC0;
    data[1] = ssidBytes.length;
    data.set(ssidBytes, 2);
    data[2 + ssidBytes.length] = passwordBytes.length;
    data.set(passwordBytes, 3 + ssidBytes.length);

    await characteristicToWrite.writeValue(data);
    alert("WiFi ä¿¡æ¯å·²å‘é€");
  } catch (e) {
    alert("å‘é€å¤±è´¥: " + e.message);
  }
});

document.getElementById('startOtaBtn').addEventListener('click', async () => {
  const otaUrl = document.getElementById('otaUrl').value.trim();
  
  if (!otaUrl) {
    alert("è¯·è¾“å…¥ OTA ä¸‹è½½ URL");
    return;
  }
  
  if (!characteristicToWrite) {
    alert("æœªè¿æ¥è“ç‰™è®¾å¤‡æˆ–æœªæ‰¾åˆ°å¯å†™ç‰¹å¾å€¼");
    return;
  }
  
  try {
    const encoder = new TextEncoder();
    const urlBytes = encoder.encode(otaUrl);
    
    if (urlBytes.length > 128) {
      alert("URL å¤ªé•¿ï¼ˆé™128å­—èŠ‚ï¼‰");
      return;
    }
    
    const data = new Uint8Array(1 + 1 + urlBytes.length);
    data[0] = 0xD0;
    data[1] = urlBytes.length;
    data.set(urlBytes, 2);
    
    await characteristicToWrite.writeValue(data);
    alert("OTA URL å·²å‘é€ï¼Œè®¾å¤‡å³å°†å¼€å§‹ä¸‹è½½å¹¶æ›´æ–°...");
  } catch (e) {
    alert("å‘é€å¤±è´¥: " + e.message);
  }
});

document.getElementById('sendHexBtn').addEventListener('click', async () => {
  const hex = document.getElementById('hexInput').value.trim();
  if (!hex) {
    alert("è¯·è¾“å…¥åå…­è¿›åˆ¶æ•°æ®ï¼Œä¾‹å¦‚ï¼šAA 01 FF 00");
    return;
  }

  if (!characteristicToWrite) {
    alert("æœªè¿æ¥è“ç‰™è®¾å¤‡æˆ–æœªæ‰¾åˆ°å¯å†™ç‰¹å¾å€¼");
    return;
  }

  try {
    const byteArray = hex.split(/\s+/).map(b => parseInt(b, 16));
    const data = new Uint8Array(byteArray);
    await characteristicToWrite.writeValue(data);
    alert("å·²å‘é€ Hex æ•°æ®");
  } catch (e) {
    alert("å‘é€å¤±è´¥: " + e.message);
  }
});

document.getElementById('sendAsciiBtn').addEventListener('click', async () => {
  const asciiStr = document.getElementById('hexInput').value.trim();
  if (!asciiStr) {
    alert("è¯·è¾“å…¥ ASCII å­—ç¬¦ä¸²");
    return;
  }

  if (!characteristicToWrite) {
    alert("æœªè¿æ¥è“ç‰™è®¾å¤‡æˆ–æœªæ‰¾åˆ°å¯å†™ç‰¹å¾å€¼");
    return;
  }

  try {
    const data = new TextEncoder().encode(asciiStr); // è½¬æˆ UTF-8 å­—èŠ‚æµ
    await characteristicToWrite.writeValue(data);
    alert("å·²å‘é€ ASCII å­—ç¬¦ä¸²");
  } catch (e) {
    alert("å‘é€å¤±è´¥: " + e.message);
  }
});



/* ---------- å°åŒ…ï¼šè¿”å› Uint8Array( 518 ) ---------- */
const PAYLOAD_SIZE = 16;        // æ¯å¸§æœ‰æ•ˆæ•°æ® 32B
const FRAME_SIZE   = 22;   // 1+2+16+2+1
const HEADER_BYTE  = 0xAA;
const TAIL_BYTE    = 0xAA;
function crc16Modbus(buf) {
  let crc = 0xFFFF;
  for (let b of buf) {
    crc ^= b;
    for (let i = 0; i < 8; ++i)
      crc = (crc & 1) ? (crc >>> 1) ^ 0xA001 : crc >>> 1;
  }
  return crc & 0xFFFF;
}
function buildSmallPacket(seq, payload32) {
  const frame = new Uint8Array(FRAME_SIZE);

  frame[0] = HEADER_BYTE;           // å¸§å¤´
  frame[1] = seq & 0xFF;           // Seq_L
  frame[2] = (seq >> 8) & 0xFF;    // Seq_H

  frame.fill(0xFF, 3);             // å…ˆæŠŠ 32B åŒºåŸŸå¡« 0xFF
  frame.set(payload32, 3);         // å†™å…¥å®é™…æ•°æ®

  const crc = crc16Modbus(frame.subarray(1, 1 + 2 + PAYLOAD_SIZE)); // Seq+Payload
  frame[19] = (crc >> 8) & 0xFF;    // CRC é«˜
  frame[20] =  crc & 0xFF;          // CRC ä½
  frame[21] = TAIL_BYTE;            // å¸§å°¾

  return frame;
}





/* ---------- é€‰æ‹© BIN â†’ åˆ†åŒ… â†’ å†™å…¥ ---------- */
document.getElementById('sendBinBtn').addEventListener('click', async () => {
  const f = document.getElementById('binFile').files[0];
  if (!f) { alert('è¯·é€‰æ‹© .bin æ–‡ä»¶'); return; }
  if (!characteristicToWrite) { alert('è¯·å…ˆè¿æ¥è“ç‰™è®¾å¤‡'); return; }

  try {
    const arrayBuf = await f.arrayBuffer();
    let bin = new Uint8Array(arrayBuf);
    const realLength = bin.length; // åŸå§‹é•¿åº¦
    console.log(`ğŸ“¦ é€‰æ‹©çš„ OTA bin æ–‡ä»¶å¤§å°: ${realLength} å­—èŠ‚`);
    // âœ… è¡¥é½åˆ° 512 å­—èŠ‚å¯¹é½ï¼ˆä¸è¶³è¡¥ 0xFFï¼‰
    const padding = bin.length % 512;
    if (padding !== 0) {
      const padded = new Uint8Array(bin.length + (512 - padding)).fill(0xFF);
      padded.set(bin);
      bin = padded;
    }
    const totalBlocks = bin.length / 512; // 512 å­—èŠ‚ä¸ºä¸€ä¸ªå—
    const totalPkts = bin.length / PAYLOAD_SIZE; // 16 å­—èŠ‚æ¯åŒ…

    // âœ… å‘é€å¤´åŒ…ï¼š0x52 0x45 0x51 + len_L + len_H
    const header = new Uint8Array(9);
    header[0] = 0x52;
    header[1] = 0x45;
    header[2] = 0x51;
    header[3] = (totalBlocks >> 8) & 0xFF;
    header[4] = totalBlocks & 0xFF;

    header[5] = (realLength >> 24) & 0xFF;
    header[6] = (realLength >> 16) & 0xFF;
    header[7] = (realLength >> 8) & 0xFF;
    header[8] = realLength & 0xFF;

    console.log(`ğŸ“¦ å‘é€ REQ åŒ…ï¼Œæ€»å—æ•°: ${totalBlocks}, å®é™…å­—èŠ‚æ•°: ${realLength}`);
    await characteristicToWrite.writeValue(header);
    try {
      await waitForAck();  // ç­‰è®¾å¤‡ ACK
      console.log("âœ… æ”¶åˆ° ACKï¼Œå¼€å§‹å‘é€æ•°æ®...");
    } catch (e) {
      alert("REQ é˜¶æ®µå¤±è´¥: " + e.message);
      return;
    }




    const BATCH_SIZE = 32;  // æ¯ N åŒ…ç­‰ä¸€æ¬¡ ACK

    for (let offset = 0, seq = 0; offset < bin.length; offset += PAYLOAD_SIZE, ++seq) {
      const remain = bin.length - offset;
      const block32 = remain >= PAYLOAD_SIZE
            ? bin.subarray(offset, offset + PAYLOAD_SIZE)
            : new Uint8Array(PAYLOAD_SIZE).fill(0xFF)
                  .map((v, i) => (i < remain ? bin[offset + i] : v));

      const pkt = buildSmallPacket(seq, block32);
      console.log(`Sending pkt data pkt=${pkt}, seq=${seq}, size=${pkt.length}, remain=${remain}`);
      await characteristicToWrite.writeValue(pkt);

      if ((seq + 1) % BATCH_SIZE === 0 || (offset + PAYLOAD_SIZE) >= bin.length) {
        console.log(`ğŸ• Batch ${seq + 1} sent, waiting for ACK...`);
        try {
          await waitForAck();  // æ¯32å¸§ç­‰ä¸€æ¬¡ AWK
        } catch (e) {
          alert(e.message);
          return;
        }
      }
    }


      alert('OTA bin å…¨éƒ¨å‘é€å®Œæˆï¼');
    } 
  catch (e) {
    alert('å‘é€å¤±è´¥: ' + e.message);
  }
});



window.addEventListener('DOMContentLoaded', () => {
  const otaInput = document.getElementById('otaUrl');
  otaInput.value = `${location.origin}/simple_ota.bin`;
  drawChart();
  
  // æ»‘åŠ¨æ¡äº‹ä»¶å¤„ç†
  const percentSlider = document.getElementById('percentSlider');
  const percentValue = document.getElementById('percentValue');
  const percentMinusBtn = document.getElementById('percentMinusBtn');
  const percentPlusBtn = document.getElementById('percentPlusBtn');
  
  percentSlider.addEventListener('input', () => {
    percentValue.textContent = percentSlider.value;
  });
  
  percentSlider.addEventListener('change', async () => {
    const percent = parseInt(percentSlider.value);
    
    if (!characteristicToWrite) {
      alert('æœªè¿æ¥è“ç‰™è®¾å¤‡æˆ–æœªæ‰¾åˆ°å¯å†™ç‰¹å¾å€¼');
      return;
    }
    
    try {
      const data = new Uint8Array([0xB1, 0x04, percent, 0xB1]);
      await characteristicToWrite.writeValue(data);
      console.log(`å·²å‘é€ç™¾åˆ†æ¯”æ•°æ®: B1 04 ${percent.toString(16).padStart(2, '0').toUpperCase()} B1`);
    } catch (e) {
      alert('å‘é€å¤±è´¥: ' + e.message);
    }
  });
  
  percentMinusBtn.addEventListener('click', async () => {
    let v = parseInt(percentSlider.value) || 0;
    if (v > 0) v -= 1;
    percentSlider.value = v;
    percentValue.textContent = v;
    if (!characteristicToWrite) { alert('æœªè¿æ¥è“ç‰™è®¾å¤‡æˆ–æœªæ‰¾åˆ°å¯å†™ç‰¹å¾å€¼'); return; }
    try {
      const data = new Uint8Array([0xB1, 0x04, v, 0xB1]);
      await characteristicToWrite.writeValue(data);
      console.log(`å·²å‘é€ç™¾åˆ†æ¯”æ•°æ®: B1 04 ${v.toString(16).padStart(2, '0').toUpperCase()} B1`);
    } catch (e) { alert('å‘é€å¤±è´¥: ' + e.message); }
  });
  
  percentPlusBtn.addEventListener('click', async () => {
    let v = parseInt(percentSlider.value) || 0;
    if (v < 100) v += 1;
    percentSlider.value = v;
    percentValue.textContent = v;
    if (!characteristicToWrite) { alert('æœªè¿æ¥è“ç‰™è®¾å¤‡æˆ–æœªæ‰¾åˆ°å¯å†™ç‰¹å¾å€¼'); return; }
    try {
      const data = new Uint8Array([0xB1, 0x04, v, 0xB1]);
      await characteristicToWrite.writeValue(data);
      console.log(`å·²å‘é€ç™¾åˆ†æ¯”æ•°æ®: B1 04 ${v.toString(16).padStart(2, '0').toUpperCase()} B1`);
    } catch (e) { alert('å‘é€å¤±è´¥: ' + e.message); }
  });
});


</script>

</body>
</html>
